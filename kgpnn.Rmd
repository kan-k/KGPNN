---
title: "kGPNN"
author: "Kan Keeratimahat"
date: "14/09/2023"
output: pdf_document
---

#First idea is to link the id-age-GENDER.

```{r}
part_list<-read.table('/well/nichols/users/qcv214/Placement_2/participant_list.txt', header = FALSE, sep = "", dec = ".") #4529 participants
part_list$exist_vbm <- file.exists(paste0('/well/win-biobank/projects/imaging/data/data3/subjectsAll/',part_list[,1],'/T1/T1_vbm/T1_GM_to_template_GM_mod.nii.gz'))
part_use<-part_list[part_list$exist_vbm==1,] #4263 participants left
# 
agetab<-read.table(file = '/well/nichols/projects/UKB/SMS/ukb_latest-Age.tsv', sep = '\t', header = TRUE)
age_tab<-as.data.frame(matrix(,nrow = length(part_use$V1),ncol = 3)) #id, age, number of masked voxels
colnames(age_tab)[1:3]<-c('id','age','sex')
age_tab$id<-part_use$V1
for(i in 1:length(part_use$V1)){
  age_tab$age[i]<-agetab$X21003.2.0[agetab$eid_8107==sub(".", "",age_tab$id[i])]
  age_tab$sex[i]<-agetab$X31.0.0[agetab$eid_8107==sub(".", "",age_tab$id[i])]
}
write_feather(age_tab, '/well/nichols/users/qcv214/KGPNN/age_sex.feather')
```

```{r}
age_tab <- as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex.feather'))
```

##EDA for age-sex
```{r}
library(readr)
library(ggplot2)
ggplot(age_tab, aes(x = age, fill = factor(sex))) +
  
  # Define the bin width (5 years)
  geom_histogram(binwidth = 5, position = "stack", color = "black") +
  
  # Add labels and theme options for better visualization
  labs(title = "Stacked Histogram of Age by Sex",
       x = "Age (Years)", y = "Frequency") +
  
  theme_minimal()
```

```{r}
mean(age_tab$sex)
summary(age_tab$age[age_tab$sex==0])
summary(age_tab$age[age_tab$sex==1])
```
We can see that the data distribution is almost identical so it's good to go.

I tihnk we need same amount of male and female to assess uncertainty. and compare accuracy
###Stratify the data by using downsampling on sex
```{r}
# Check the counts of each sex category
sex_counts <- table(age_tab$sex)
# Determine the minimum count
min_count <- min(sex_counts)
# Stratify the data
balanced_age_tab <- age_tab %>%
  group_by(sex) %>%
  sample_n(size = min_count)
```
This `balanced_age_tab` is stratified correctly, and ordered by sex. amount is 1971 in each.

Sort age by sex
```{r}
# Sort the entire dataframe by age and group by sex
balanced_age_tab <- balanced_age_tab %>%
  split(.$sex) %>%
  lapply(function(x) x[order(x$age),]) %>%
  bind_rows()
```

```{r}
#write_feather(balanced_age_tab, '/well/nichols/users/qcv214/KGPNN/age_sex_strat.feather')
age_tab <- as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat.feather'))
```
##EDA for age-sex
```{r}
library(readr)
library(ggplot2)
ggplot(age_tab, aes(x = age, fill = factor(sex))) +
  
  # Define the bin width (5 years)
  geom_histogram(binwidth = 5, position = "stack", color = "black") +
  
  # Add labels and theme options for better visualization
  labs(title = "Stacked Histogram of Age by Sex",
       x = "Age (Years)", y = "Frequency") +
  
  theme_minimal()
```
```{r}
library(readr)
library(ggplot2)
ggplot(age_tab, aes(x = age, fill = factor(sex))) +
  
  # Define the bin width (5 years)
  geom_histogram(binwidth = 5, position = "dodge", color = "black") +
  
  # Add labels and theme options for better visualization
  labs(title = "Histogram of Age by Sex",
       x = "Age (Years)", y = "Frequency") +
  
  theme_minimal()
```
```{r}
# Load the necessary libraries
library(ggplot2)

# Assuming age_tab is your data.frame
# If not, replace it with the actual data.frame name

# Create a ggplot object
ggplot(age_tab, aes(x = factor(age), fill = factor(sex))) +
  
  # Define the bin width (5 years)
  geom_histogram(binwidth = 5, position = "dodge", color = "black") +
  
  # Add labels and theme options for better visualization
  labs(title = "Double Bar Histogram of Age by Sex",
       x = "Age (Years)", y = "Frequency") +
  
  theme_minimal() +
  
  # Adjust legend labels
  scale_fill_manual(values = c("0" = "blue", "1" = "red"), 
                    name = "Sex",
                    labels = c("Female", "Male"))

```

```{r}
mean(age_tab$sex)
summary(age_tab$age[age_tab$sex==0])
summary(age_tab$age[age_tab$sex==1])
```

```{r}
write_feather(age_tab[1:1971,], '/well/nichols/users/qcv214/KGPNN/age_F.feather')
write_feather(age_tab[1972:3942,], '/well/nichols/users/qcv214/KGPNN/age_M.feather')
```

#Now split each `age_F` and `age_M` into training and tests. using the same sampling should achieve similar distribution for both.
```{r}
sample(1971,0.3*1971)
```
Previously I had 50/50 split for train/test, so 2k each.
Let's do 70%-30%
```{r}
set.seed(4)
train.ind <- sample(1971,0.7*1971)
test.ind <- setdiff(1:1971,train.ind)
write.csv(x = train.ind, file = '/well/nichols/users/qcv214/KGPNN/train_index.csv', row.names = FALSE)
write.csv(x = test.ind, file = '/well/nichols/users/qcv214/KGPNN/test_index.csv', row.names = FALSE)
```

##Do I need to assess similarity of distribution of train/test... I tried viewing density plots already.

#Pipeline

0. Note that I am not refitting individual GP parameters, I just use the same ones from before.

1. Run gpnn_bb_ig to explore optima
2. On top, run gpnn_bb(_ig)_ext_bbs to exploit global optimum




Running
//f_gpnn_bbig_init.R  27609396
//m_gpnn_bbig_init.R  27609386
Note that I initially ask for 500 epochs, I will reduce to 1 as I already observe somegood results by 40 epochs

##Now I have to do extended bbs

###First assess the miniumum loss achieved in each model.

There seems to be an essential split between Male and Female with Male having higher lowest test RMSE
```{r}
runs <- c(1:10)
res1 <- vector(mode = 'numeric')
res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep14_F_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
  res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep14_M_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
}

plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 400 iterations", ylab="RMSE", xlab="Run Number",ylim=c(4,8))
lines(x = runs,y=sqrt(res2),col='blue',lwd=2, type = 'b')
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Female','Male', 'response sd'),lty=c(1),col=c('red','blue','black'))
```


##I am going to do extended bbs, but I will reduce the number of epoch AND ALLOW. random starting point

Currently running
//f_gpnn_bbig_init_bbs.R  27655397
//m_gpnn_bbig_init_bbs.R  27627738


Plot gpnn_bbig_init_bbs
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 400 #500*4
runs <- c(1:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep14_F_gpnn_bbig_init_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep14_M_gpnn_bbig_init_loss__jobid_",i,".csv")))[,1:num.it]
}


#define legends
leglab <- c(paste0("F_Ridge+GP")
                             ,paste0("M_Ridge+GP"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.4,5.9))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','orange','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,6.1))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue'))
``` 

#Lets do
1. GPR for each gender
2. SGLD gor each gender => I've looked at prev results `/well/nichols/users/qcv214/bnn2/res3/pile/re_summary_jun9_sgld2k_a7.csv` for comparsion, lets use a = 1e-4, 300 epochs
**** I have just remembered that `sgld_bbig_ab_gsd_V2` is the "near mode" version, so it will start with initialisation from BB and NOT BBS.
*** Also bear in mind that eventually im only interested in 200 samples. This is because of MALA
** But I will run full data first anyway


3. Orginial GPNN


#15 Sept
I have realised that all of my code so far re-order the `id`, which messes up the train-test split. I will fix it all now.
//f_gpnn_bbig_init.R  28190035
//m_gpnn_bbig_init.R  28190867
//f_gpr 28199099
//m_gpr 28198911


Currently running
//f_sgld_n sep15_f_sgld_bbig_a4_b0_near 28438243
//m_sgld_n sep15_m_sgld_bbig_a4_b0_near 28438254
//f_gpnn_bbig_init_bbs  28438266
//m_gpnn_bbig_init_bbs 28438278

//f_sgld_n  sep15_f_sgld_bbig_a6_b0_near 28446442 => false result, wrong a
//m_sgld_n  sep15_m_sgld_bbig_a6_b0_near 28446429 =>false result, wrong a

//f_gpnn_bbig_init_bbs sep18_F_gpnn_bbig_init_bbs ==> 300 epochs.  28446401
//m_gpnn_bbig_init_bbs sep18_M_gpnn_bbig_init_bbs ==> 300 epochs.  28446414

//f_gpr 28450774 ==>coverage fixed.  coverage 97.8, 91.4
//m_gpr 28450770 ==>coverage fixed.  coverage 98, 93


#Visualise GPR-40 of male and female on top of BBS
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 400 #500*4
runs <- c(1:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep14_F_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep14_M_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
}
#Female GPR
runs.hs <- c(1:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_f_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.5)) #Just median
hs.test <-quantile(hs.int[,6],c(0.5)) #just median
#Male GPR
runs.hs2 <- c(1:10)
hs.int2<-matrix(,nrow=length(runs.hs2),ncol=13)
for(i in runs.hs2){
  hs.int2[which(i==runs.hs2),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_m_gpr_noscale_",i,".csv"))))
}
hs.train2 <- quantile(hs.int2[,5],c(0.5)) #Just median
hs.test2 <-quantile(hs.int2[,6],c(0.5)) #just median



#define legends
leglab <- c(paste0("F_Ridge+GP")
                             ,paste0("M_Ridge+GP"),"F_GPR-40","M_GPR-40")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.4,5.9))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.test, col='red4',lwd=2)
abline(h=hs.test2, col='navy',lwd=2)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('right',legend = leglab,lty=c(1),col=c("red",'blue','red4','navy'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,6.5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.train, col='red4',lwd=2)
abline(h=hs.train2, col='navy',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('right',legend = leglab,lty=c(1),col=c("red",'blue','red4','navy'))
``` 
On training we can see that there is no difference for GPNN, while for GPR, female is fitted better than male
On test, we can see same thing for GPR but also applies to GPNN.

let's look at R^2
```{r}
#GPNN
num.it <- 400
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep14_F_gpnn_bbig_init_bbs_rsq__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep14_M_gpnn_bbig_init_bbs_rsq__jobid_",i,".csv")))[,1:num.it]
}

#Female GPR
runs.hs <- c(1:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_f_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,1],c(0.5)) #Just median
hs.test <-quantile(hs.int[,3],c(0.5)) #just median
#Male GPR
runs.hs2 <- c(1:10)
hs.int2<-matrix(,nrow=length(runs.hs2),ncol=13)
for(i in runs.hs2){
  hs.int2[which(i==runs.hs2),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_m_gpr_noscale_",i,".csv"))))
}
hs.train2 <- quantile(hs.int2[,1],c(0.5)) #Just median
hs.test2 <-quantile(hs.int2[,3],c(0.5)) #just median

#Legends
leglab <- c(paste0("F_Ridge+GP")
                             ,paste0("M_Ridge+GP"),"F_GPR-40","M_GPR-40")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=res.iqr[2,],col='red',lwd=2, type = 'l',main = "Test R^2", ylab="R^2", xlab="iteration")
lines(x=1:num.it,y=res.iqr[1,],col='pink',lwd=0.5)
lines(x=1:num.it,y=res.iqr[3,],col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=res.iqr2[2,],col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=res.iqr2[1,],col='lightblue',lwd=0.5)
lines(x=1:num.it,y=res.iqr2[3,],col='lightblue',lwd=0.5)
abline(h=hs.test, col='red4',lwd=2)
abline(h=hs.test2, col='navy',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('right',legend = leglab,lty=c(1),col=c("red",'blue','red4','navy'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=res.iqr[2,],col='red',lwd=2, type = 'l',main = "Train R^2", ylab="R^2", xlab="iteration")
lines(x=1:num.it,y=res.iqr[1,],col='pink',lwd=0.5)
lines(x=1:num.it,y=res.iqr[3,],col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=res.iqr2[2,],col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=res.iqr2[1,],col='lightblue',lwd=0.5)
lines(x=1:num.it,y=res.iqr2[3,],col='lightblue',lwd=0.5)
abline(h=hs.train, col='red4',lwd=2)
abline(h=hs.train2, col='navy',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('right',legend = leglab,lty=c(1),col=c("red",'blue','red4','navy'))
```

See that for R^2, the performance is opposite for GPR in train and test


This isn't working very well. I think it hasn't converged. Basically the trainig RMSE is not 0 and training R^2 is not 100%.
2 main differences here: number of iterations is reduced 5-fold. 

Previously it was 2k train - 2k test
Now it's 1379 train (reduced by 31%), 539 test.



#Meeting with Tom 18 sep
Re-write SALSA code in R. Look at feat5, fastfeat, and code that pre-process the input in fastfeat (something like CleanNIFTI...)



For SGLD, what if I do lr reduction with smoothing.

***Important, check GPR200 coverage. It has 2000 samples but the t-dist only uses 500-1 parameters. this doesn't make so much diff as it should be arouund 1.96-1.97
BUT what's important is the propotion (/2000)




#19 sep

BBS with 1200 iterations

##Visualise GPR-40 of male and female on top of BBS
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 1200 #500*4
runs <- c(1:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep18_F_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep18_M_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
}
#Female GPR
runs.hs <- c(1:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_f_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.5)) #Just median
hs.test <-quantile(hs.int[,6],c(0.5)) #just median
#Male GPR
runs.hs2 <- c(1:10)
hs.int2<-matrix(,nrow=length(runs.hs2),ncol=13)
for(i in runs.hs2){
  hs.int2[which(i==runs.hs2),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_m_gpr_noscale_",i,".csv"))))
}
hs.train2 <- quantile(hs.int2[,5],c(0.5)) #Just median
hs.test2 <-quantile(hs.int2[,6],c(0.5)) #just median



#define legends
leglab <- c(paste0("F_Ridge+GP")
                             ,paste0("M_Ridge+GP"),"F_GPR-40","M_GPR-40")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.4,5.9))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.test, col='red4',lwd=2)
abline(h=hs.test2, col='navy',lwd=2)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','red4','navy'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,6.5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.train, col='red4',lwd=2)
abline(h=hs.train2, col='navy',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','red4','navy'))
``` 
let's look at R^2
```{r}
#GPNN
num.it <- 1200
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep18_F_gpnn_bbig_init_bbs_rsq__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep18_M_gpnn_bbig_init_bbs_rsq__jobid_",i,".csv")))[,1:num.it]
}

#Female GPR
runs.hs <- c(1:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_f_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,1],c(0.5)) #Just median
hs.test <-quantile(hs.int[,3],c(0.5)) #just median
#Male GPR
runs.hs2 <- c(1:10)
hs.int2<-matrix(,nrow=length(runs.hs2),ncol=13)
for(i in runs.hs2){
  hs.int2[which(i==runs.hs2),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_m_gpr_noscale_",i,".csv"))))
}
hs.train2 <- quantile(hs.int2[,1],c(0.5)) #Just median
hs.test2 <-quantile(hs.int2[,3],c(0.5)) #just median

#Legends
leglab <- c(paste0("F_Ridge+GP")
                             ,paste0("M_Ridge+GP"),"F_GPR-40","M_GPR-40")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=res.iqr[2,],col='red',lwd=2, type = 'l',main = "Test R^2", ylab="R^2", xlab="iteration")
lines(x=1:num.it,y=res.iqr[1,],col='pink',lwd=0.5)
lines(x=1:num.it,y=res.iqr[3,],col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=res.iqr2[2,],col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=res.iqr2[1,],col='lightblue',lwd=0.5)
lines(x=1:num.it,y=res.iqr2[3,],col='lightblue',lwd=0.5)
abline(h=hs.test, col='red4',lwd=2)
abline(h=hs.test2, col='navy',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','red4','navy'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=res.iqr[2,],col='red',lwd=2, type = 'l',main = "Train R^2", ylab="R^2", xlab="iteration")
lines(x=1:num.it,y=res.iqr[1,],col='pink',lwd=0.5)
lines(x=1:num.it,y=res.iqr[3,],col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=res.iqr2[2,],col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=res.iqr2[1,],col='lightblue',lwd=0.5)
lines(x=1:num.it,y=res.iqr2[3,],col='lightblue',lwd=0.5)
abline(h=hs.train, col='red4',lwd=2)
abline(h=hs.train2, col='navy',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','red4','navy'))
```
NOTE: I accidentally looked at the wrong graphs. BBS converge in 100 epochs

## SGLD wrong setting
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 1200 #500*4
runs <- c(1:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_f_sgld_bbig_a4_b0_near_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_m_sgld_bbig_a4_b0_near_loss__jobid_",i,".csv")))[,1:num.it]
}
#Female GPR
runs.hs <- c(1:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_f_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.5)) #Just median
hs.test <-quantile(hs.int[,6],c(0.5)) #just median
#Male GPR
runs.hs2 <- c(1:10)
hs.int2<-matrix(,nrow=length(runs.hs2),ncol=13)
for(i in runs.hs2){
  hs.int2[which(i==runs.hs2),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_m_gpr_noscale_",i,".csv"))))
}
hs.train2 <- quantile(hs.int2[,5],c(0.5)) #Just median
hs.test2 <-quantile(hs.int2[,6],c(0.5)) #just median



#define legends
leglab <- c(paste0("F_Ridge+GP")
                             ,paste0("M_Ridge+GP"),"F_GPR-40","M_GPR-40")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.4,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.test, col='red4',lwd=2)
abline(h=hs.test2, col='navy',lwd=2)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','red4','navy'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.train, col='red4',lwd=2)
abline(h=hs.train2, col='navy',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','red4','navy'))
``` 
```{r}
#GPNN
num.it <- 1200
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_f_sgld_bbig_a4_b0_near_rsq__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_m_sgld_bbig_a4_b0_near_rsq__jobid_",i,".csv")))[,1:num.it]
}

#Female GPR
runs.hs <- c(1:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_f_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,1],c(0.5)) #Just median
hs.test <-quantile(hs.int[,3],c(0.5)) #just median
#Male GPR
runs.hs2 <- c(1:10)
hs.int2<-matrix(,nrow=length(runs.hs2),ncol=13)
for(i in runs.hs2){
  hs.int2[which(i==runs.hs2),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_m_gpr_noscale_",i,".csv"))))
}
hs.train2 <- quantile(hs.int2[,1],c(0.5)) #Just median
hs.test2 <-quantile(hs.int2[,3],c(0.5)) #just median

#Legends
leglab <- c(paste0("F_Ridge+GP")
                             ,paste0("M_Ridge+GP"),"F_GPR-40","M_GPR-40")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=res.iqr[2,],col='red',lwd=2, type = 'l',main = "Test R^2", ylab="R^2", xlab="iteration")
lines(x=1:num.it,y=res.iqr[1,],col='pink',lwd=0.5)
lines(x=1:num.it,y=res.iqr[3,],col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=res.iqr2[2,],col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=res.iqr2[1,],col='lightblue',lwd=0.5)
lines(x=1:num.it,y=res.iqr2[3,],col='lightblue',lwd=0.5)
abline(h=hs.test, col='red4',lwd=2)
abline(h=hs.test2, col='navy',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','red4','navy'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=res.iqr[2,],col='red',lwd=2, type = 'l',main = "Train R^2", ylab="R^2", xlab="iteration")
lines(x=1:num.it,y=res.iqr[1,],col='pink',lwd=0.5)
lines(x=1:num.it,y=res.iqr[3,],col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=res.iqr2[2,],col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=res.iqr2[1,],col='lightblue',lwd=0.5)
lines(x=1:num.it,y=res.iqr2[3,],col='lightblue',lwd=0.5)
abline(h=hs.train, col='red4',lwd=2)
abline(h=hs.train2, col='navy',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','red4','navy'))
```

***Important - note that R^2 presented in graph and calculated in bayescal are entirely different.....

Currently running
//sep18_f_sgld_bbig_a6_b0_near 28463679
//sep18_m_sgld_bbig_a6_b0_near 28463689
//sep18_f_sgld_bbig_a8_b0_near 28463709
//sep18_m_sgld_bbig_a8_b0_near 28463699

#SGLD a6
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 1200 #500*4
runs <- c(1:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep18_f_sgld_bbig_a6_b0_near_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep18_m_sgld_bbig_a6_b0_near_loss__jobid_",i,".csv")))[,1:num.it]
}
#Female GPR
runs.hs <- c(1:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_f_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.5)) #Just median
hs.test <-quantile(hs.int[,6],c(0.5)) #just median
#Male GPR
runs.hs2 <- c(1:10)
hs.int2<-matrix(,nrow=length(runs.hs2),ncol=13)
for(i in runs.hs2){
  hs.int2[which(i==runs.hs2),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_m_gpr_noscale_",i,".csv"))))
}
hs.train2 <- quantile(hs.int2[,5],c(0.5)) #Just median
hs.test2 <-quantile(hs.int2[,6],c(0.5)) #just median



#define legends
leglab <- c(paste0("F_Ridge+GP")
                             ,paste0("M_Ridge+GP"),"F_GPR-40","M_GPR-40")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.4,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.test, col='red4',lwd=2)
abline(h=hs.test2, col='navy',lwd=2)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','red4','navy'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.train, col='red4',lwd=2)
abline(h=hs.train2, col='navy',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','red4','navy'))
``` 
This is decent

##SGLD a8
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 1200 #500*4
runs <- c(1:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep18_f_sgld_bbig_a8_b0_near_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep18_m_sgld_bbig_a8_b0_near_loss__jobid_",i,".csv")))[,1:num.it]
}
#Female GPR
runs.hs <- c(1:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_f_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.5)) #Just median
hs.test <-quantile(hs.int[,6],c(0.5)) #just median
#Male GPR
runs.hs2 <- c(1:10)
hs.int2<-matrix(,nrow=length(runs.hs2),ncol=13)
for(i in runs.hs2){
  hs.int2[which(i==runs.hs2),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_m_gpr_noscale_",i,".csv"))))
}
hs.train2 <- quantile(hs.int2[,5],c(0.5)) #Just median
hs.test2 <-quantile(hs.int2[,6],c(0.5)) #just median



#define legends
leglab <- c(paste0("F_Ridge+GP")
                             ,paste0("M_Ridge+GP"),"F_GPR-40","M_GPR-40")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.4,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.test, col='red4',lwd=2)
abline(h=hs.test2, col='navy',lwd=2)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','red4','navy'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.train, col='red4',lwd=2)
abline(h=hs.train2, col='navy',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','red4','navy'))
``` 

learning rate too low

Let's look at bayescal?





Currently running
[failed] sep22_sex_gpnn_bbig_init. 28572454
Error in rep.int(rep.int(seq_len(nx), rep.int(rep.fac, nx)), orep) :
  invalid 'times' value
Calls: model.matrix ... poly -> do.call -> <Anonymous> -> do.call -> <Anonymous>

sep22_sex_gpnn_bbig_init. 28595709



#24 sep
Note that in `sex_gpnn_bbig_init` a participant disappears from the `age` list, resulting in old indexing having 4263 max index but age only has 4262. This has happened but I can't find it. there is also a file called `age_add1` which im not sure about.
What I will do is remove the index 4263, and leave the test index to have 4263... but then idk who left... let's investigate

Look at 
```{r}
age_tab2<-as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex.feather'))
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')

setdiff(age_tab$id,age_tab2$id)

which(age_tab$id == 24612030)

ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"))
train.test.ind <- list()
train.test.ind$test <-  unlist(ind.temp[2,])
train.test.ind$train <-  unlist(ind.temp[1,])

which(age_tab$id == 24612030) %in% train.test.ind$test
which(age_tab$id == 24612030) %in% train.test.ind$train 
```
Since the missing point is in test set, we can just reduce test set to 1999
Create an empty row
```{r}
age_temp <- rbind(age_tab2[1:(which(age_tab$id == 24612030) -1),], c(24612030,NA,NA),age_tab2[(which(age_tab$id == 24612030)):nrow(age_tab2),] )
```

```{r}
age_temp <- rbind(age_tab2[1:3101,], c(24612030,NA,NA),age_tab2[3102:nrow(age_tab2),] )
```


[// failed, not saved correctly] sep22_sex_gpnn_bbig_init 28666880

[failed]sep25_sex_gpnn_bbig_init_bbs. 28715381, should finish 9pm

[failed, not saved correctly] sep22_sex_gpnn_bbig_init 28715470 ===> 100 epochs

//sep22_sex_gpnn_bbig_init 28721002 ===> 50 epochs should finish at 6pm. 
sep25_sex_gpnn_bbig_init_bbs. 28732835  ===> 50 epochs should finish at 9.30pm. 



#25 Sep
Turns out for sgld,  a4 is just right. Compare a4 to a6 for all measures, e.g. rmse, rsq and coverage
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 200 #500*4
runs <- c(1:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep25_sex_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1:4,7:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb27_gpnn_bb_ig_init_ext_bbs_test_loss__jobid_",i,".csv")))[,1:num.it]
}
runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))



#define legends
leglab <- c(paste0("Gender")
                             ,paste0("No-gender (original)"),"GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.4,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.test, col='magenta',lwd=2)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('right',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.train, col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('right',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
``` 

let's look at R^2
```{r}
#GPNN
num.it <- 200
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep25_sex_gpnn_bbig_init_bbs_rsq__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1:4,7:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb27_gpnn_bb_ig_init_ext_bbs_test_rsq__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,1],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,3],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Gender")
                             ,paste0("No-gender (original)"),"GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=res.iqr[2,],col='red',lwd=2, type = 'l',main = "Test R^2", ylab="R^2", xlab="iteration")
lines(x=1:num.it,y=res.iqr[1,],col='pink',lwd=0.5)
lines(x=1:num.it,y=res.iqr[3,],col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=res.iqr2[2,],col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=res.iqr2[1,],col='lightblue',lwd=0.5)
lines(x=1:num.it,y=res.iqr2[3,],col='lightblue',lwd=0.5)
abline(h=hs.test, col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('right',legend = leglab,lty=c(1),col=c("red",'blue','magenta','navy'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=res.iqr[2,],col='red',lwd=2, type = 'l',main = "Train R^2", ylab="R^2", xlab="iteration")
lines(x=1:num.it,y=res.iqr[1,],col='pink',lwd=0.5)
lines(x=1:num.it,y=res.iqr[3,],col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=res.iqr2[2,],col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=res.iqr2[1,],col='lightblue',lwd=0.5)
abline(h=hs.train, col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('right',legend = leglab,lty=c(1),col=c("red",'blue','magenta','navy'))
```


//sep26_sex_gpnn_bbig_init 28745219

```{r}
runs <- c(1:10)
res1 <- vector(mode = 'numeric')
#res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep26_sex_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
  #res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep14_M_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
}

plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 400 iterations", ylab="RMSE", xlab="Run Number",ylim=c(4,8))
#lines(x = runs,y=sqrt(res2),col='blue',lwd=2, type = 'b')
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Female','Male', 'response sd'),lty=c(1),col=c('red','blue','black'))
```

[FAILED] sep26_sex_gpnn_bbig_init_bbs 28806874 ===> I ACCIDENTALLY RAN sep26_sex_gpnn_bbig_init instead


#26 sep
What to do

1. Split model: Try mixed model but with similar distribution
2. Try interaction model vs no interaction
  2.1 when measuring rmse, split gender
  2.2 Increase number of expansion
  
##Get new indicies
```{r}
#write_feather(balanced_age_tab, '/well/nichols/users/qcv214/KGPNN/age_sex_strat.feather')
age_tab <- as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat.feather'))
```
###Actually what I can do is finding a new, more balanced indices .... changed my mind, I think the model can learn the systematic difference between the gender
```{r}
library(readr)
library(ggplot2)
ggplot(age_tab, aes(x = age, fill = factor(sex))) +
  
  # Define the bin width (5 years)
  geom_histogram(binwidth = 5, position = "dodge", color = "black") +
  
  # Add labels and theme options for better visualization
  labs(title = "Histogram of Age by Sex",
       x = "Age (Years)", y = "Frequency") +
  
  theme_minimal()
```

`age_sex_strat.feather` is sorted by age and grouped by sex, how about I take every 2nd (every 2nd rather than 3rd to keep training set not large)
Each has length 1971
```{r}
write.csv(x = seq(1,nrow(age_tab),2), file = '/well/nichols/users/qcv214/KGPNN/sex_train_index.csv', row.names = FALSE)
write.csv(x = seq(2,nrow(age_tab),2), file = '/well/nichols/users/qcv214/KGPNN/sex_test_index.csv', row.names = FALSE)
```
```{r}
library(readr)
library(ggplot2)
ggplot(age_tab[seq(1,nrow(age_tab),2),], aes(x = age, fill = factor(sex))) +
  
  # Define the bin width (5 years)
  geom_histogram(binwidth = 5, position = "dodge", color = "black") +
  
  # Add labels and theme options for better visualization
  labs(title = "Train Histogram of Age by Sex",
       x = "Age (Years)", y = "Frequency") +
  
  theme_minimal()

ggplot(age_tab[seq(2,nrow(age_tab),2),], aes(x = age, fill = factor(sex))) +
  
  # Define the bin width (5 years)
  geom_histogram(binwidth = 5, position = "dodge", color = "black") +
  
  # Add labels and theme options for better visualization
  labs(title = "Test Histogram of Age by Sex",
       x = "Age (Years)", y = "Frequency") +
  
  theme_minimal()
```

##Plot BBS of long run for interaction model


sep26_gender_gpnn_bbig_init 28850789
sep26_nogender_gpnn_bbig_init  28851189


#28 sep

##Plot data dist of original dataset
```{r}
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')
age_tab <- age_tab[order(age_tab$id),]
age <- age_tab$age
#
ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"))
train.test.ind <- list()
train.test.ind$test <-  unlist(ind.temp[2,])
train.test.ind$train <-  unlist(ind.temp[1,])
```
```{r}
# Assuming age_data is your data.frame, and indices1 and indices2 are your lists of indices
# If not, replace them with the actual names

# Load the necessary libraries
library(ggplot2)

# Define the bin width and breaks
bin_width <- 5
breaks <- seq(0, max(age_tab$age) + bin_width, by = bin_width)

# Create histograms for each group
hist_group1 <- hist(age_tab$age[train.test.ind$train], plot = FALSE, breaks = breaks)
hist_group2 <- hist(age_tab$age[train.test.ind$test], plot = FALSE, breaks = breaks)

# Combine the histograms
combined_hist <- data.frame(
  age = rep(hist_group1$mids, 2),
  count = c(hist_group1$counts, hist_group2$counts),
  group = rep(c("Train", "Test"), each = length(hist_group1$mids))
)

# Create a ggplot object
ggplot(combined_hist, aes(x = age, y = count, fill = group)) +
  geom_bar(stat = "identity", position = "dodge", color = "black") +
  labs(title = "Histogram of Age with Dodge Position",
       x = "Age (Years)", y = "Frequency") +
  theme_minimal() +
  scale_fill_manual(name = "Groups", values = c("Train" = "blue", "Test" = "red")) +
  xlim(42.5, max(combined_hist$age))  # Set x-axis limits
```
So the previous indexing of data was actually really good. 




#28 sep

##Plot the results for bbs... they haven't fully ended
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 1200 #500*4
runs <- c(1,2,5,6,9,10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep26_gender_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(2,6:7,8,9)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep26_nogender_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
}
runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))



#define legends
leglab <- c(paste0("Gender")
                             ,paste0("No-gender (original)"),"GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.4,5.7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.test, col='magenta',lwd=2)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('right',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,6))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.train, col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('right',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
``` 

```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-1200
runs <- c(1,2,5,6,9,10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep26_gender_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-c(1,2,5,6,9,10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep26_gender_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(2,6:7,8,9)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep26_nogender_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- c(2,6:7,8,9)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep26_nogender_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Interact-Male")
                             ,paste0("Interact-Female")
                             ,paste0("Original-Male"), 'Original-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.4,5))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,0.6))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 

Look at held-out BAG

```{r}
train.test.ind <- list()
train.test.ind$test <- read.csv('/well/nichols/users/qcv214/KGPNN/sex_test_index.csv')$x
n.test <- length(train.test.ind$test)
age_tab<-as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat.feather'))

wb2.pred.train <- age_tab$age[train.test.ind$test]
pred.test <- as.matrix(read_feather('/well/nichols/users/qcv214/KGPNN/pile/re_sep26_gender_gpnn_bbig_init_bbs_outpred__jobid_2.feather'))
hs.pred.train <- tail(pred.test[2,],n.test)
rd.pred <- round(hs.pred.train)
hs.pred.train <- hs.pred.train - wb2.pred.train
missing.pred <- setdiff(43:88,rd.pred)
rd.pred <- c(rd.pred,missing.pred)
hs.pred.train <- c(hs.pred.train,rep(100,length(missing.pred)))
boxplot(hs.pred.train ~rd.pred, ylab="BAG (years)", xlab = "Age Prediction (years)", main = "Brain Age Gap of GPNN-Linear-GP-ext",ylim=c(-15,22))
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
boxplot(hs.pred.train ~rd.pred, ylab="BAG (years)", xlab = "Age Prediction (years)", main = "Brain Age Gap of GPNN-Linear-GP-ext",ylim=c(-15,22),add=T)

```
```{r}
train.test.ind <- list()
train.test.ind$test <- read.csv('/well/nichols/users/qcv214/KGPNN/sex_test_index.csv')$x
n.test <- length(train.test.ind$test)
age_tab<-as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat.feather'))

wb2.pred.train <- age_tab$age[train.test.ind$test][which(age_tab$sex[train.test.ind$test] == 1)]
pred.test <- as.matrix(read_feather('/well/nichols/users/qcv214/KGPNN/pile/re_sep26_gender_gpnn_bbig_init_bbs_outpred__jobid_2.feather'))
hs.pred.train <- tail(pred.test[2,],n.test)[which(age_tab$sex[train.test.ind$test] == 1)]
rd.pred <- round(hs.pred.train)
hs.pred.train <- hs.pred.train - wb2.pred.train
missing.pred <- setdiff(43:88,rd.pred)
rd.pred <- c(rd.pred,missing.pred)
hs.pred.train <- c(hs.pred.train,rep(100,length(missing.pred)))
boxplot(hs.pred.train ~rd.pred, ylab="BAG (years)", xlab = "Age Prediction (years)", main = "Brain Age Gap of GPNN-Linear-GP-ext",ylim=c(-15,22))
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
boxplot(hs.pred.train ~rd.pred, ylab="BAG (years)", xlab = "Age Prediction (years)", main = "Brain Age Gap of GPNN-Linear-GP-ext",ylim=c(-15,22),add=T)

wb2.pred.train <- age_tab$age[train.test.ind$test][which(age_tab$sex[train.test.ind$test] == 0)]
pred.test <- as.matrix(read_feather('/well/nichols/users/qcv214/KGPNN/pile/re_sep26_gender_gpnn_bbig_init_bbs_outpred__jobid_2.feather'))
hs.pred.train <- tail(pred.test[2,],n.test)[which(age_tab$sex[train.test.ind$test] == 0)]
rd.pred <- round(hs.pred.train)
hs.pred.train <- hs.pred.train - wb2.pred.train
missing.pred <- setdiff(43:88,rd.pred)
rd.pred <- c(rd.pred,missing.pred)
hs.pred.train <- c(hs.pred.train,rep(100,length(missing.pred)))
boxplot(hs.pred.train ~rd.pred, ylab="BAG (years)", xlab = "Age Prediction (years)", main = "Brain Age Gap of GPNN-Linear-GP-ext",ylim=c(-15,22))
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
boxplot(hs.pred.train ~rd.pred, ylab="BAG (years)", xlab = "Age Prediction (years)", main = "Brain Age Gap of GPNN-Linear-GP-ext",ylim=c(-15,22),add=T)

```
```{r}
# Load the necessary libraries
library(ggplot2)

# Assuming age_tab is your data.frame and train.test.ind$test is your test indices
# If not, replace them with the actual names

# Generate the data
wb2.pred.train <- age_tab$age[train.test.ind$test][which(age_tab$sex[train.test.ind$test] == 1)]
pred.test <- as.matrix(read_feather('/well/nichols/users/qcv214/KGPNN/pile/re_sep26_gender_gpnn_bbig_init_bbs_outpred__jobid_2.feather'))
hs.pred.train <- tail(pred.test[2,], n.test)[which(age_tab$sex[train.test.ind$test] == 1)]
rd.pred <- round(hs.pred.train)
hs.pred.train <- hs.pred.train - wb2.pred.train
missing.pred <- setdiff(43:88,rd.pred)
rd.pred <- c(rd.pred,missing.pred)
hs.pred.train <- c(hs.pred.train,rep(100,length(missing.pred)))

# Combine the data into a data frame
combined_data <- data.frame(rd.pred = rd.pred, hs.pred.train = hs.pred.train)

# Create a ggplot object
ggplot(combined_data, aes(x = factor(rd.pred), y = hs.pred.train)) +
  geom_boxplot(position = position_dodge(width = 0.75)) +
  labs(title = "Brain Age Gap of GPNN-Linear-GP-ext",
       x = "Age Prediction (years)", y = "BAG (years)") +
  ylim(-15, 22) +
  theme_minimal() +
  scale_fill_manual(name = "Sex", values = c("0" = "blue", "1" = "red"))
```

```{r}
# Load the necessary libraries
library(ggplot2)

# Generate the data for sex == 1
wb2.pred.train <- age_tab$age[train.test.ind$test][which(age_tab$sex[train.test.ind$test] == 1)]
pred.test <- as.matrix(read_feather('/well/nichols/users/qcv214/KGPNN/pile/re_sep26_gender_gpnn_bbig_init_bbs_outpred__jobid_2.feather'))
hs.pred.train <- tail(pred.test[2,], n.test)[which(age_tab$sex[train.test.ind$test] == 1)]
rd.pred <- round(hs.pred.train)
hs.pred.train <- hs.pred.train - wb2.pred.train
missing.pred <- setdiff(43:88,rd.pred)
rd.pred <- c(rd.pred,missing.pred)
hs.pred.train <- c(hs.pred.train,rep(100,length(missing.pred)))

# Combine the data into a data frame for sex == 1
combined_data_sex1 <- data.frame(rd.pred = rd.pred, hs.pred.train = hs.pred.train, sex = "Male")

# Generate the data for sex == 0
wb2.pred.train <- age_tab$age[train.test.ind$test][which(age_tab$sex[train.test.ind$test] == 0)]
pred.test <- as.matrix(read_feather('/well/nichols/users/qcv214/KGPNN/pile/re_sep26_gender_gpnn_bbig_init_bbs_outpred__jobid_2.feather'))
hs.pred.train <- tail(pred.test[2,], n.test)[which(age_tab$sex[train.test.ind$test] == 0)]
rd.pred <- round(hs.pred.train)
hs.pred.train <- hs.pred.train - wb2.pred.train
missing.pred <- setdiff(43:88,rd.pred)
rd.pred <- c(rd.pred,missing.pred)
hs.pred.train <- c(hs.pred.train,rep(100,length(missing.pred)))

# Combine the data into a data frame for sex == 0
combined_data_sex0 <- data.frame(rd.pred = rd.pred, hs.pred.train = hs.pred.train, sex = "Female")

# Combine the data frames
combined_data <- rbind(combined_data_sex1, combined_data_sex0)

# Create a ggplot object
ggplot(combined_data, aes(x = factor(rd.pred), y = hs.pred.train, fill = sex)) +
  geom_boxplot(position = position_dodge(width = 0.75)) +
  labs(title = "(Test) Brain Age Gap of Interaction Model",
       x = "Age Prediction (years)", y = "BAG (years)") +
  ylim(-15, 22) +
  theme_minimal() +
  scale_fill_manual(name = "Sex", values = c("Female" = "lightblue", "Male" = "pink"))+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```

```{r}
# Load the necessary libraries
library(ggplot2)

# Generate the data for sex == 1
wb2.pred.train <- age_tab$age[train.test.ind$test][which(age_tab$sex[train.test.ind$test] == 1)]
pred.test <- as.matrix(read_feather('/well/nichols/users/qcv214/KGPNN/pile/re_sep26_nogender_gpnn_bbig_init_bbs_outpred__jobid_2.feather'))
hs.pred.train <- tail(pred.test[2,], n.test)[which(age_tab$sex[train.test.ind$test] == 1)]
rd.pred <- round(hs.pred.train)
hs.pred.train <- hs.pred.train - wb2.pred.train
missing.pred <- setdiff(43:88,rd.pred)
rd.pred <- c(rd.pred,missing.pred)
hs.pred.train <- c(hs.pred.train,rep(100,length(missing.pred)))

# Combine the data into a data frame for sex == 1
combined_data_sex1 <- data.frame(rd.pred = rd.pred, hs.pred.train = hs.pred.train, sex = "Male")

# Generate the data for sex == 0
wb2.pred.train <- age_tab$age[train.test.ind$test][which(age_tab$sex[train.test.ind$test] == 0)]
pred.test <- as.matrix(read_feather('/well/nichols/users/qcv214/KGPNN/pile/re_sep26_nogender_gpnn_bbig_init_bbs_outpred__jobid_2.feather'))
hs.pred.train <- tail(pred.test[2,], n.test)[which(age_tab$sex[train.test.ind$test] == 0)]
rd.pred <- round(hs.pred.train)
hs.pred.train <- hs.pred.train - wb2.pred.train
missing.pred <- setdiff(43:88,rd.pred)
rd.pred <- c(rd.pred,missing.pred)
hs.pred.train <- c(hs.pred.train,rep(100,length(missing.pred)))

# Combine the data into a data frame for sex == 0
combined_data_sex0 <- data.frame(rd.pred = rd.pred, hs.pred.train = hs.pred.train, sex = "Female")

# Combine the data frames
combined_data <- rbind(combined_data_sex1, combined_data_sex0)

# Create a ggplot object
ggplot(combined_data, aes(x = factor(rd.pred), y = hs.pred.train, fill = sex)) +
  geom_boxplot(position = position_dodge(width = 0.75)) +
  labs(title = "(Test) Brain Age Gap of Original Model",
       x = "Age Prediction (years)", y = "BAG (years)") +
  ylim(-15, 22) +
  theme_minimal() +
  scale_fill_manual(name = "Sex", values = c("Female" = "lightblue", "Male" = "pink"))+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```




#29 sep

doing GPGP
I think `gpnn_gpgp_bbig_init_com` is the faster version of `gpnn_gpgp_bbig_init` by doing pre-computation.

[FAILED, didnt save correctly] [node 1,3,10 too slow, the rest were fine] sep29_gender_gpgp_bbig_init.  29355757
// sep29_nogender_gpgp_bbig_init.  29355747

Note that I changed from 4 memories to 8 memories

//sep29_nogender_gpgp_bbig_init_bbs.  29382227.  [I forgot to split male and female when saving]
//sep29_gender_gpgp_bbig_init. 29382649 [I forgot to split male and female when saving]

#1 Oct
##Observe min loss
```{r}
runs <- c(1:2,4:7,9)
res1 <- vector(mode = 'numeric')
res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep29_gender_gpgp_bbig_init_minloss__jobid_",i,".csv"))$x)
  res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep29_nogender_gpgp_bbig_init_minloss__jobid_",i,".csv"))$x)
}

plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "GPGP Minimum Test RMSE across 2000 iterations", ylab="RMSE", xlab="Run Number",ylim=c(4,8))
lines(x = runs,y=sqrt(res2),col='blue',lwd=2, type = 'b')
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Interaction','Original', 'response sd'),lty=c(1),col=c('red','blue','black'))
```
##Observe BBS
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-2000
runs <- c(1,2,5,6,7,10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep29_gender_gpgp_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-c(1,2,4:9)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep29_nogender_gpgp_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Interaction model")
                             ,paste0("Original model"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.4,7))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')

abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,7))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')

abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'navy','lightblue','magenta','black'))
``` 
Weird behaviour

##To do
###1. SGLD for gpnn and gpgp
Running
oct2_gender_gpnn_sgld_a4_b0_near. 29454776
oct2_nogender_gpnn_sgld_a4_b0_near. 29454786
//oct2_gender_gpgp_sgld_a4_b0_near. 29454796
//oct2_nogender_gpgp_sgld_a4_b0_near  29454806

###2. build a nn
oct2_gender_nn_bbig_init. 29454830
oct2_nogender_nn_bbig_init. 29456033

Min loss of interaction
```{r}
runs <- c(1:10)
res1 <- vector(mode = 'numeric')
#res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct2_gender_nn_bbig_init_minloss__jobid_",i,".csv"))$x)
  #res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep29_nogender_gpgp_bbig_init_minloss__jobid_",i,".csv"))$x)
}

plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "NN Minimum Test RMSE across 1200 iterations", ylab="RMSE", xlab="Run Number",ylim=c(4,8))
#lines(x = runs,y=sqrt(res2),col='blue',lwd=2, type = 'b')
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Interaction','Original', 'response sd'),lty=c(1),col=c('red','blue','black'))
```
```{r}
runs <- c(1:10)
res1 <- vector(mode = 'numeric')
res2 <- vector(mode = 'numeric')
res3 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct2_gender_nn_bbig_init_minloss__jobid_",i,".csv"))$x)
  res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct2_nogender_nn_bbig_init_minloss__jobid_",i,".csv"))$x)
  res3 <- c(res3,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep26_sex_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
}

plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 1200 iterations", ylab="RMSE", xlab="Run Number",ylim=c(4,7.5))
lines(x = runs,y=sqrt(res2),col='blue',lwd=2, type = 'b')
lines(x = runs,y=sqrt(res3),col='darkgreen',lwd=2, type = 'b')

abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('NN-Interaction','NN-Original','GPNN-Interction', 'response sd'),lty=c(1),col=c('red','blue','darkgreen','black'))
```

Do Bayes cal


Currently
//oct3_gender_nn_bbig_init_bbs. 29528602
//oct3_nogender_nn_bbig_init_bbs.  29528612


#4 Oct
After meeting with Jian on tues 3rd

## Want to Increase number of training.
I will first try like before. So run bb on 2k dataset, then increase the number of training to 4k and 6k during bbs
look at `gpnn_init_ext_bbs_addtrain.R` and  `bnn2/res3/age_add1.feather`

### Load up `age_add1` and find corresponding gender
```{r}
#The extra 4258 participants age tab
age_tab_add<- read_feather('/well/nichols/users/qcv214/bnn2/res3/age_add1.feather')

#Add raw age tab file
agetab<-read.table(file = '/well/nichols/projects/UKB/SMS/ukb_latest-Age.tsv', sep = '\t', header = TRUE) #This is 42940 x 11

```

```{r}
age_tab_add$sex <- rep(NA, nrow(age_tab_add))
for(i in 1:nrow(age_tab_add)){
  age_tab_add$sex[i]<-agetab$X31.0.0[agetab$eid_8107==sub(".", "",age_tab_add$id[i])]
}
#To check empty gender => sum(is.na(age_tab_add$sex))
```
To check quick summary, type `summary(age_tab_add[,2:3])` which shows that 46% is female
Save 
```{r}
write_feather(age_tab_add, '/well/nichols/users/qcv214/KGPNN/age_sex_add1.feather')
```

Addtrain
Running 
oct4_gender_gpnn_bbig_init_bbs_addtrain2k_75  29531291
oct4_gender_gpnn_bbig_init_bbs_addtrain4k_50  29531321
oct4_gender_gpgp_bbig_init_bbs_addtrain2k_75 29531403
oct4_gender_gpgp_bbig_init_bbs_addtrain4k_50 29531393



#5 oct
Plot
oct3_gender_nn_bbig_init_bbs
oct3_nogender_nn_bbig_init_bbs
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-1200
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct3_gender_nn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct3_gender_nn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <-1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct3_nogender_nn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- 1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct3_nogender_nn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Interact-Male")
                             ,paste0("Interact-Female")
                             ,paste0("Original-Male"), 'Original-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.4,5))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,0.6))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 
This hasn't converged. And it is better than than GPNN!! I am gonna let it run for longer


oct3_gender_nn_bbig_init_bbs. 29854715
oct3_nogender_nn_bbig_init_bbs.  29854778
##Longer run of NN
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-2000
runs <- c(1,2,3,7,8,10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct5_gender_nn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-c(1,2,3,7,8,10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct5_gender_nn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(1,2,3,5,6,10)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct5_nogender_nn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- c(1,2,3,5,6,10)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct5_nogender_nn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Interact-Male")
                             ,paste0("Interact-Female")
                             ,paste0("Original-Male"), 'Original-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.4,5))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,0.6))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 


//oct4_gender_gpnn_bbig_init_bbs_addtrain2k_50  29855151
//oct4_gender_gpnn_bbig_init_bbs_addtrain4k_25  29854984
// (some) oct4_gender_gpgp_bbig_init_bbs_addtrain2k_50. 29855476.  ==> I forgot to split male/female
//(some) oct4_gender_gpgp_bbig_init_bbs_addtrain4k_25. 29855331. ==> I forgot to split male/female
 
oct5_male_nogender_gpnn_bbig_init.   29952513
oct5_female_nogender_gpnn_bbig_init.  29952499

#6 oct

##Plot add train gnn
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-300
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct4_gender_gpnn_bbig_init_bbs_addtrain2k_50_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct4_gender_gpnn_bbig_init_bbs_addtrain2k_50_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <-1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct4_gender_gpnn_bbig_init_bbs_addtrain4k_25_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- 1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct4_gender_gpnn_bbig_init_bbs_addtrain4k_25_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("4k-Male")
                             ,paste0("4k-Female")
                             ,paste0("6k-Male"), '6k-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE of interaction model", ylab="RMSE", xlab="iteration",ylim=c(4,6))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE of interaction model", ylab="RMSE", xlab="iteration",ylim=c(0,4))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 


Running
//oct6_gender_gpgp_bbig_init_bbs_addtrain2k_50 29952547
//oct6_gender_gpgp_bbig_init_bbs_addtrain4k_25 29952557


##Plot add train GPGP
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-300
runs <- c(2:7,9:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct6_gender_gpgp_bbig_init_bbs_addtrain2k_50_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(2:7,9:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct6_gender_gpgp_bbig_init_bbs_addtrain2k_50_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(2,3,4,7,9)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct6_gender_gpgp_bbig_init_bbs_addtrain4k_25_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <-c(2,3,4,7,9)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct6_gender_gpgp_bbig_init_bbs_addtrain4k_25_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("4k-Male")
                             ,paste0("4k-Female")
                             ,paste0("6k-Male"), '6k-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE of interaction model", ylab="RMSE", xlab="iteration",ylim=c(4,8))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE of interaction model", ylab="RMSE", xlab="iteration",ylim=c(4,6))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 
This doesnt look so good...

//oct6_male_nogender_gpnn_bbig_init_bbs 30002394
//oct6_female_nogender_gpnn_bbig_init_bbs 30002329
//oct6_gender_gpgp_sgld_5a5_b0_near 30002900
//oct6_gender_gpgp_sgld_a5_b0_near. 30002868


#8 oct
##Compare interaction vs separate fitting
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-600
runs <- c(1,2,5,6,9,10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep26_gender_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-c(1,2,5,6,9,10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep26_gender_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(2,3,5:9)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct6_male_nogender_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- 1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct6_female_nogender_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Interact-Male")
                             ,paste0("Interact-Female")
                             ,paste0("Separate-Male"), 'Separate-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.4,5))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,4))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 


//oct9_gender_gpgp_sgld_5a4_b0_near. 30261140
//oct9_gender_gpgp_sgld_a3_b0_near. 30261162

#11 Oct

##Re running for saliency
sep26_nogender_gpnn_bbig_init_bbs is already correct

//oct11_gender_gpnn_bbig_init_bbs. 30550901
//oct11_gender_nn_bbig_init_bbs.  30551007
//oct11_gender_gpgp_bbig_init_bbs. 30551140

##Re run gpgp add train
oct11_gender_gpgp_bbig_init_bbs_addtrain2k_250 30551441
oct11_gender_gpgp_bbig_init_bbs_addtrain4k_167. 30551457

#21 Oct
Re-plot gpgp add train
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-2000
runs <- c(2:7,9:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct11_gender_gpgp_bbig_init_bbs_addtrain2k_250_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(2:7,9:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct11_gender_gpgp_bbig_init_bbs_addtrain2k_250_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(2,3,4,7,9)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct11_gender_gpgp_bbig_init_bbs_addtrain4k_167_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <-c(2,3,4,7,9)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct11_gender_gpgp_bbig_init_bbs_addtrain4k_167_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("4k-Male")
                             ,paste0("4k-Female")
                             ,paste0("6k-Male"), '6k-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE of interaction model", ylab="RMSE", xlab="iteration",ylim=c(4,8))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE of interaction model", ylab="RMSE", xlab="iteration",ylim=c(4,6))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 
##I should also re-run 3 versions of sgld... to keep training at 95%
//oct21_gender_gpnn_sgld_a3_b0_near. 32533480
//oct21_gender_gpnn_sgld_5a3_b0_near.  32533441
[failed] oct21_gender_gpgp_sgld_5a3_b0_near  32533457 ==> 500 epochs [time limit exceeded]

oct21_gender_gpgp_sgld_5a3_b0_near. 32578261 ==> 300 epochs


#30 Oct
I've checked the saliency of gpgp in 32808407, everything was fine I will disect it into beta and interaction effects
running oct30_gender_gpgp_bbig_init_bbs 32846320

Running 
//nov2_cov_gpnn_bbig_init 33036684 ==> 100 epochs
//nov3_cov_gpnn_bbig_init 33042133 ==> 500 epochs [only a few survived due to time limit] [4,5,7,10]


#5 Nov
##Plot minimum loss of cov 100 epochs
```{r}
runs <- c(1:10)
res1 <- vector(mode = 'numeric')
#res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov2_cov_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
  #res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep29_nogender_gpgp_bbig_init_minloss__jobid_",i,".csv"))$x)
}

plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "NN Minimum Test RMSE across 2000 iterations", ylab="RMSE", xlab="Run Number",ylim=c(3,8))
#lines(x = runs,y=sqrt(res2),col='blue',lwd=2, type = 'b')
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Interaction','Original', 'response sd'),lty=c(1),col=c('red','blue','black'))
```
I have to run it 300 times and see, rather than 100 or 500. 


Currently running 
nov5_cov_gpnn_bbig_init_bbs  33242023 (300 epochs, on top of wrongly nov2_cov)
nov5_cov_gpnn_bbig_init  