---
title: "kGPNN"
author: "Kan Keeratimahat"
date: "14/09/2023"
output: pdf_document
---

#First idea is to link the id-age-GENDER.

```{r}
part_list<-read.table('/well/nichols/users/qcv214/Placement_2/participant_list.txt', header = FALSE, sep = "", dec = ".") #4529 participants
part_list$exist_vbm <- file.exists(paste0('/well/win-biobank/projects/imaging/data/data3/subjectsAll/',part_list[,1],'/T1/T1_vbm/T1_GM_to_template_GM_mod.nii.gz'))
part_use<-part_list[part_list$exist_vbm==1,] #4263 participants left
# 
agetab<-read.table(file = '/well/nichols/projects/UKB/SMS/ukb_latest-Age.tsv', sep = '\t', header = TRUE)
age_tab<-as.data.frame(matrix(,nrow = length(part_use$V1),ncol = 3)) #id, age, number of masked voxels
colnames(age_tab)[1:3]<-c('id','age','sex')
age_tab$id<-part_use$V1
for(i in 1:length(part_use$V1)){
  age_tab$age[i]<-agetab$X21003.2.0[agetab$eid_8107==sub(".", "",age_tab$id[i])]
  age_tab$sex[i]<-agetab$X31.0.0[agetab$eid_8107==sub(".", "",age_tab$id[i])]
}
write_feather(age_tab, '/well/nichols/users/qcv214/KGPNN/age_sex.feather')
```

```{r}
age_tab <- as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex.feather'))
```

##EDA for age-sex
```{r}
library(readr)
library(ggplot2)
ggplot(age_tab, aes(x = age, fill = factor(sex))) +
  
  # Define the bin width (5 years)
  geom_histogram(binwidth = 5, position = "stack", color = "black") +
  
  # Add labels and theme options for better visualization
  labs(title = "Stacked Histogram of Age by Sex",
       x = "Age (Years)", y = "Frequency") +
  
  theme_minimal()
```

```{r}
mean(age_tab$sex)
summary(age_tab$age[age_tab$sex==0])
summary(age_tab$age[age_tab$sex==1])
```
We can see that the data distribution is almost identical so it's good to go.

I tihnk we need same amount of male and female to assess uncertainty. and compare accuracy
###Stratify the data by using downsampling on sex
```{r}
# Check the counts of each sex category
sex_counts <- table(age_tab$sex)
# Determine the minimum count
min_count <- min(sex_counts)
# Stratify the data
balanced_age_tab <- age_tab %>%
  group_by(sex) %>%
  sample_n(size = min_count)
```
This `balanced_age_tab` is stratified correctly, and ordered by sex. amount is 1971 in each.

Sort age by sex
```{r}
# Sort the entire dataframe by age and group by sex
balanced_age_tab <- balanced_age_tab %>%
  split(.$sex) %>%
  lapply(function(x) x[order(x$age),]) %>%
  bind_rows()
```

```{r}
#write_feather(balanced_age_tab, '/well/nichols/users/qcv214/KGPNN/age_sex_strat.feather')
age_tab <- as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat.feather'))
```
##EDA for age-sex
```{r}
library(readr)
library(ggplot2)
ggplot(age_tab, aes(x = age, fill = factor(sex))) +
  
  # Define the bin width (5 years)
  geom_histogram(binwidth = 5, position = "stack", color = "black") +
  
  # Add labels and theme options for better visualization
  labs(title = "Stacked Histogram of Age by Sex",
       x = "Age (Years)", y = "Frequency") +
  
  theme_minimal()
```
```{r}
library(readr)
library(ggplot2)
ggplot(age_tab, aes(x = age, fill = factor(sex))) +
  
  # Define the bin width (5 years)
  geom_histogram(binwidth = 5, position = "dodge", color = "black") +
  
  # Add labels and theme options for better visualization
  labs(title = "Histogram of Age by Sex",
       x = "Age (Years)", y = "Frequency") +
  
  theme_minimal()
```
```{r}
# Load the necessary libraries
library(ggplot2)

# Assuming age_tab is your data.frame
# If not, replace it with the actual data.frame name

# Create a ggplot object
ggplot(age_tab, aes(x = factor(age), fill = factor(sex))) +
  
  # Define the bin width (5 years)
  geom_histogram(binwidth = 5, position = "dodge", color = "black") +
  
  # Add labels and theme options for better visualization
  labs(title = "Double Bar Histogram of Age by Sex",
       x = "Age (Years)", y = "Frequency") +
  
  theme_minimal() +
  
  # Adjust legend labels
  scale_fill_manual(values = c("0" = "blue", "1" = "red"), 
                    name = "Sex",
                    labels = c("Female", "Male"))

```

```{r}
mean(age_tab$sex)
summary(age_tab$age[age_tab$sex==0])
summary(age_tab$age[age_tab$sex==1])
```

```{r}
write_feather(age_tab[1:1971,], '/well/nichols/users/qcv214/KGPNN/age_F.feather')
write_feather(age_tab[1972:3942,], '/well/nichols/users/qcv214/KGPNN/age_M.feather')
```

#Now split each `age_F` and `age_M` into training and tests. using the same sampling should achieve similar distribution for both.
```{r}
sample(1971,0.3*1971)
```
Previously I had 50/50 split for train/test, so 2k each.
Let's do 70%-30%
```{r}
set.seed(4)
train.ind <- sample(1971,0.7*1971)
test.ind <- setdiff(1:1971,train.ind)
write.csv(x = train.ind, file = '/well/nichols/users/qcv214/KGPNN/train_index.csv', row.names = FALSE)
write.csv(x = test.ind, file = '/well/nichols/users/qcv214/KGPNN/test_index.csv', row.names = FALSE)
```

##Do I need to assess similarity of distribution of train/test... I tried viewing density plots already.

#Pipeline

0. Note that I am not refitting individual GP parameters, I just use the same ones from before.

1. Run gpnn_bb_ig to explore optima
2. On top, run gpnn_bb(_ig)_ext_bbs to exploit global optimum




Running
//f_gpnn_bbig_init.R  27609396
//m_gpnn_bbig_init.R  27609386
Note that I initially ask for 500 epochs, I will reduce to 1 as I already observe somegood results by 40 epochs

##Now I have to do extended bbs

###First assess the miniumum loss achieved in each model.

There seems to be an essential split between Male and Female with Male having higher lowest test RMSE
```{r}
runs <- c(1:10)
res1 <- vector(mode = 'numeric')
res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep14_F_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
  res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep14_M_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
}

plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 400 iterations", ylab="RMSE", xlab="Run Number",ylim=c(4,8))
lines(x = runs,y=sqrt(res2),col='blue',lwd=2, type = 'b')
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Female','Male', 'response sd'),lty=c(1),col=c('red','blue','black'))
```


##I am going to do extended bbs, but I will reduce the number of epoch AND ALLOW. random starting point

Currently running
//f_gpnn_bbig_init_bbs.R  27655397
//m_gpnn_bbig_init_bbs.R  27627738


Plot gpnn_bbig_init_bbs
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 400 #500*4
runs <- c(1:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep14_F_gpnn_bbig_init_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep14_M_gpnn_bbig_init_loss__jobid_",i,".csv")))[,1:num.it]
}


#define legends
leglab <- c(paste0("F_Ridge+GP")
                             ,paste0("M_Ridge+GP"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.4,5.9))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','orange','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,6.1))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue'))
``` 

#Lets do
1. GPR for each gender
2. SGLD gor each gender => I've looked at prev results `/well/nichols/users/qcv214/bnn2/res3/pile/re_summary_jun9_sgld2k_a7.csv` for comparsion, lets use a = 1e-4, 300 epochs
**** I have just remembered that `sgld_bbig_ab_gsd_V2` is the "near mode" version, so it will start with initialisation from BB and NOT BBS.
*** Also bear in mind that eventually im only interested in 200 samples. This is because of MALA
** But I will run full data first anyway


3. Orginial GPNN


#15 Sept
I have realised that all of my code so far re-order the `id`, which messes up the train-test split. I will fix it all now.
//f_gpnn_bbig_init.R  28190035
//m_gpnn_bbig_init.R  28190867
//f_gpr 28199099
//m_gpr 28198911


Currently running
//f_sgld_n sep15_f_sgld_bbig_a4_b0_near 28438243
//m_sgld_n sep15_m_sgld_bbig_a4_b0_near 28438254
//f_gpnn_bbig_init_bbs  28438266
//m_gpnn_bbig_init_bbs 28438278

//f_sgld_n  sep15_f_sgld_bbig_a6_b0_near 28446442 => false result, wrong a
//m_sgld_n  sep15_m_sgld_bbig_a6_b0_near 28446429 =>false result, wrong a

//f_gpnn_bbig_init_bbs sep18_F_gpnn_bbig_init_bbs ==> 300 epochs.  28446401
//m_gpnn_bbig_init_bbs sep18_M_gpnn_bbig_init_bbs ==> 300 epochs.  28446414

//f_gpr 28450774 ==>coverage fixed.  coverage 97.8, 91.4
//m_gpr 28450770 ==>coverage fixed.  coverage 98, 93


#Visualise GPR-40 of male and female on top of BBS
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 400 #500*4
runs <- c(1:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep14_F_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep14_M_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
}
#Female GPR
runs.hs <- c(1:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_f_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.5)) #Just median
hs.test <-quantile(hs.int[,6],c(0.5)) #just median
#Male GPR
runs.hs2 <- c(1:10)
hs.int2<-matrix(,nrow=length(runs.hs2),ncol=13)
for(i in runs.hs2){
  hs.int2[which(i==runs.hs2),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_m_gpr_noscale_",i,".csv"))))
}
hs.train2 <- quantile(hs.int2[,5],c(0.5)) #Just median
hs.test2 <-quantile(hs.int2[,6],c(0.5)) #just median



#define legends
leglab <- c(paste0("F_Ridge+GP")
                             ,paste0("M_Ridge+GP"),"F_GPR-40","M_GPR-40")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.4,5.9))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.test, col='red4',lwd=2)
abline(h=hs.test2, col='navy',lwd=2)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('right',legend = leglab,lty=c(1),col=c("red",'blue','red4','navy'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,6.5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.train, col='red4',lwd=2)
abline(h=hs.train2, col='navy',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('right',legend = leglab,lty=c(1),col=c("red",'blue','red4','navy'))
``` 
On training we can see that there is no difference for GPNN, while for GPR, female is fitted better than male
On test, we can see same thing for GPR but also applies to GPNN.

let's look at R^2
```{r}
#GPNN
num.it <- 400
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep14_F_gpnn_bbig_init_bbs_rsq__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep14_M_gpnn_bbig_init_bbs_rsq__jobid_",i,".csv")))[,1:num.it]
}

#Female GPR
runs.hs <- c(1:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_f_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,1],c(0.5)) #Just median
hs.test <-quantile(hs.int[,3],c(0.5)) #just median
#Male GPR
runs.hs2 <- c(1:10)
hs.int2<-matrix(,nrow=length(runs.hs2),ncol=13)
for(i in runs.hs2){
  hs.int2[which(i==runs.hs2),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_m_gpr_noscale_",i,".csv"))))
}
hs.train2 <- quantile(hs.int2[,1],c(0.5)) #Just median
hs.test2 <-quantile(hs.int2[,3],c(0.5)) #just median

#Legends
leglab <- c(paste0("F_Ridge+GP")
                             ,paste0("M_Ridge+GP"),"F_GPR-40","M_GPR-40")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=res.iqr[2,],col='red',lwd=2, type = 'l',main = "Test R^2", ylab="R^2", xlab="iteration")
lines(x=1:num.it,y=res.iqr[1,],col='pink',lwd=0.5)
lines(x=1:num.it,y=res.iqr[3,],col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=res.iqr2[2,],col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=res.iqr2[1,],col='lightblue',lwd=0.5)
lines(x=1:num.it,y=res.iqr2[3,],col='lightblue',lwd=0.5)
abline(h=hs.test, col='red4',lwd=2)
abline(h=hs.test2, col='navy',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('right',legend = leglab,lty=c(1),col=c("red",'blue','red4','navy'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=res.iqr[2,],col='red',lwd=2, type = 'l',main = "Train R^2", ylab="R^2", xlab="iteration")
lines(x=1:num.it,y=res.iqr[1,],col='pink',lwd=0.5)
lines(x=1:num.it,y=res.iqr[3,],col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=res.iqr2[2,],col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=res.iqr2[1,],col='lightblue',lwd=0.5)
lines(x=1:num.it,y=res.iqr2[3,],col='lightblue',lwd=0.5)
abline(h=hs.train, col='red4',lwd=2)
abline(h=hs.train2, col='navy',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('right',legend = leglab,lty=c(1),col=c("red",'blue','red4','navy'))
```

See that for R^2, the performance is opposite for GPR in train and test


This isn't working very well. I think it hasn't converged. Basically the trainig RMSE is not 0 and training R^2 is not 100%.
2 main differences here: number of iterations is reduced 5-fold. 

Previously it was 2k train - 2k test
Now it's 1379 train (reduced by 31%), 539 test.



#Meeting with Tom 18 sep
Re-write SALSA code in R. Look at feat5, fastfeat, and code that pre-process the input in fastfeat (something like CleanNIFTI...)



For SGLD, what if I do lr reduction with smoothing.

***Important, check GPR200 coverage. It has 2000 samples but the t-dist only uses 500-1 parameters. this doesn't make so much diff as it should be arouund 1.96-1.97
BUT what's important is the propotion (/2000)




#19 sep

BBS with 1200 iterations

##Visualise GPR-40 of male and female on top of BBS
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 1200 #500*4
runs <- c(1:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep18_F_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep18_M_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
}
#Female GPR
runs.hs <- c(1:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_f_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.5)) #Just median
hs.test <-quantile(hs.int[,6],c(0.5)) #just median
#Male GPR
runs.hs2 <- c(1:10)
hs.int2<-matrix(,nrow=length(runs.hs2),ncol=13)
for(i in runs.hs2){
  hs.int2[which(i==runs.hs2),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_m_gpr_noscale_",i,".csv"))))
}
hs.train2 <- quantile(hs.int2[,5],c(0.5)) #Just median
hs.test2 <-quantile(hs.int2[,6],c(0.5)) #just median



#define legends
leglab <- c(paste0("F_Ridge+GP")
                             ,paste0("M_Ridge+GP"),"F_GPR-40","M_GPR-40")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.4,5.9))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.test, col='red4',lwd=2)
abline(h=hs.test2, col='navy',lwd=2)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','red4','navy'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,6.5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.train, col='red4',lwd=2)
abline(h=hs.train2, col='navy',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','red4','navy'))
``` 
let's look at R^2
```{r}
#GPNN
num.it <- 1200
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep18_F_gpnn_bbig_init_bbs_rsq__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep18_M_gpnn_bbig_init_bbs_rsq__jobid_",i,".csv")))[,1:num.it]
}

#Female GPR
runs.hs <- c(1:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_f_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,1],c(0.5)) #Just median
hs.test <-quantile(hs.int[,3],c(0.5)) #just median
#Male GPR
runs.hs2 <- c(1:10)
hs.int2<-matrix(,nrow=length(runs.hs2),ncol=13)
for(i in runs.hs2){
  hs.int2[which(i==runs.hs2),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_m_gpr_noscale_",i,".csv"))))
}
hs.train2 <- quantile(hs.int2[,1],c(0.5)) #Just median
hs.test2 <-quantile(hs.int2[,3],c(0.5)) #just median

#Legends
leglab <- c(paste0("F_Ridge+GP")
                             ,paste0("M_Ridge+GP"),"F_GPR-40","M_GPR-40")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=res.iqr[2,],col='red',lwd=2, type = 'l',main = "Test R^2", ylab="R^2", xlab="iteration")
lines(x=1:num.it,y=res.iqr[1,],col='pink',lwd=0.5)
lines(x=1:num.it,y=res.iqr[3,],col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=res.iqr2[2,],col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=res.iqr2[1,],col='lightblue',lwd=0.5)
lines(x=1:num.it,y=res.iqr2[3,],col='lightblue',lwd=0.5)
abline(h=hs.test, col='red4',lwd=2)
abline(h=hs.test2, col='navy',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','red4','navy'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=res.iqr[2,],col='red',lwd=2, type = 'l',main = "Train R^2", ylab="R^2", xlab="iteration")
lines(x=1:num.it,y=res.iqr[1,],col='pink',lwd=0.5)
lines(x=1:num.it,y=res.iqr[3,],col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=res.iqr2[2,],col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=res.iqr2[1,],col='lightblue',lwd=0.5)
lines(x=1:num.it,y=res.iqr2[3,],col='lightblue',lwd=0.5)
abline(h=hs.train, col='red4',lwd=2)
abline(h=hs.train2, col='navy',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','red4','navy'))
```
NOTE: I accidentally looked at the wrong graphs. BBS converge in 100 epochs

## SGLD wrong setting
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 1200 #500*4
runs <- c(1:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_f_sgld_bbig_a4_b0_near_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_m_sgld_bbig_a4_b0_near_loss__jobid_",i,".csv")))[,1:num.it]
}
#Female GPR
runs.hs <- c(1:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_f_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.5)) #Just median
hs.test <-quantile(hs.int[,6],c(0.5)) #just median
#Male GPR
runs.hs2 <- c(1:10)
hs.int2<-matrix(,nrow=length(runs.hs2),ncol=13)
for(i in runs.hs2){
  hs.int2[which(i==runs.hs2),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_m_gpr_noscale_",i,".csv"))))
}
hs.train2 <- quantile(hs.int2[,5],c(0.5)) #Just median
hs.test2 <-quantile(hs.int2[,6],c(0.5)) #just median



#define legends
leglab <- c(paste0("F_Ridge+GP")
                             ,paste0("M_Ridge+GP"),"F_GPR-40","M_GPR-40")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.4,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.test, col='red4',lwd=2)
abline(h=hs.test2, col='navy',lwd=2)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','red4','navy'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.train, col='red4',lwd=2)
abline(h=hs.train2, col='navy',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','red4','navy'))
``` 
```{r}
#GPNN
num.it <- 1200
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_f_sgld_bbig_a4_b0_near_rsq__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_m_sgld_bbig_a4_b0_near_rsq__jobid_",i,".csv")))[,1:num.it]
}

#Female GPR
runs.hs <- c(1:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_f_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,1],c(0.5)) #Just median
hs.test <-quantile(hs.int[,3],c(0.5)) #just median
#Male GPR
runs.hs2 <- c(1:10)
hs.int2<-matrix(,nrow=length(runs.hs2),ncol=13)
for(i in runs.hs2){
  hs.int2[which(i==runs.hs2),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_m_gpr_noscale_",i,".csv"))))
}
hs.train2 <- quantile(hs.int2[,1],c(0.5)) #Just median
hs.test2 <-quantile(hs.int2[,3],c(0.5)) #just median

#Legends
leglab <- c(paste0("F_Ridge+GP")
                             ,paste0("M_Ridge+GP"),"F_GPR-40","M_GPR-40")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=res.iqr[2,],col='red',lwd=2, type = 'l',main = "Test R^2", ylab="R^2", xlab="iteration")
lines(x=1:num.it,y=res.iqr[1,],col='pink',lwd=0.5)
lines(x=1:num.it,y=res.iqr[3,],col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=res.iqr2[2,],col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=res.iqr2[1,],col='lightblue',lwd=0.5)
lines(x=1:num.it,y=res.iqr2[3,],col='lightblue',lwd=0.5)
abline(h=hs.test, col='red4',lwd=2)
abline(h=hs.test2, col='navy',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','red4','navy'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=res.iqr[2,],col='red',lwd=2, type = 'l',main = "Train R^2", ylab="R^2", xlab="iteration")
lines(x=1:num.it,y=res.iqr[1,],col='pink',lwd=0.5)
lines(x=1:num.it,y=res.iqr[3,],col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=res.iqr2[2,],col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=res.iqr2[1,],col='lightblue',lwd=0.5)
lines(x=1:num.it,y=res.iqr2[3,],col='lightblue',lwd=0.5)
abline(h=hs.train, col='red4',lwd=2)
abline(h=hs.train2, col='navy',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','red4','navy'))
```

***Important - note that R^2 presented in graph and calculated in bayescal are entirely different.....

Currently running
//sep18_f_sgld_bbig_a6_b0_near 28463679
//sep18_m_sgld_bbig_a6_b0_near 28463689
//sep18_f_sgld_bbig_a8_b0_near 28463709
//sep18_m_sgld_bbig_a8_b0_near 28463699

#SGLD a6
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 1200 #500*4
runs <- c(1:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep18_f_sgld_bbig_a6_b0_near_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep18_m_sgld_bbig_a6_b0_near_loss__jobid_",i,".csv")))[,1:num.it]
}
#Female GPR
runs.hs <- c(1:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_f_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.5)) #Just median
hs.test <-quantile(hs.int[,6],c(0.5)) #just median
#Male GPR
runs.hs2 <- c(1:10)
hs.int2<-matrix(,nrow=length(runs.hs2),ncol=13)
for(i in runs.hs2){
  hs.int2[which(i==runs.hs2),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_m_gpr_noscale_",i,".csv"))))
}
hs.train2 <- quantile(hs.int2[,5],c(0.5)) #Just median
hs.test2 <-quantile(hs.int2[,6],c(0.5)) #just median



#define legends
leglab <- c(paste0("F_Ridge+GP")
                             ,paste0("M_Ridge+GP"),"F_GPR-40","M_GPR-40")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.4,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.test, col='red4',lwd=2)
abline(h=hs.test2, col='navy',lwd=2)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','red4','navy'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.train, col='red4',lwd=2)
abline(h=hs.train2, col='navy',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','red4','navy'))
``` 
This is decent

##SGLD a8
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 1200 #500*4
runs <- c(1:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep18_f_sgld_bbig_a8_b0_near_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep18_m_sgld_bbig_a8_b0_near_loss__jobid_",i,".csv")))[,1:num.it]
}
#Female GPR
runs.hs <- c(1:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_f_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.5)) #Just median
hs.test <-quantile(hs.int[,6],c(0.5)) #just median
#Male GPR
runs.hs2 <- c(1:10)
hs.int2<-matrix(,nrow=length(runs.hs2),ncol=13)
for(i in runs.hs2){
  hs.int2[which(i==runs.hs2),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep15_m_gpr_noscale_",i,".csv"))))
}
hs.train2 <- quantile(hs.int2[,5],c(0.5)) #Just median
hs.test2 <-quantile(hs.int2[,6],c(0.5)) #just median



#define legends
leglab <- c(paste0("F_Ridge+GP")
                             ,paste0("M_Ridge+GP"),"F_GPR-40","M_GPR-40")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.4,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.test, col='red4',lwd=2)
abline(h=hs.test2, col='navy',lwd=2)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','red4','navy'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.train, col='red4',lwd=2)
abline(h=hs.train2, col='navy',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','red4','navy'))
``` 

learning rate too low

Let's look at bayescal?





Currently running
[failed] sep22_sex_gpnn_bbig_init. 28572454
Error in rep.int(rep.int(seq_len(nx), rep.int(rep.fac, nx)), orep) :
  invalid 'times' value
Calls: model.matrix ... poly -> do.call -> <Anonymous> -> do.call -> <Anonymous>

sep22_sex_gpnn_bbig_init. 28595709



#24 sep
Note that in `sex_gpnn_bbig_init` a participant disappears from the `age` list, resulting in old indexing having 4263 max index but age only has 4262. This has happened but I can't find it. there is also a file called `age_add1` which im not sure about.
What I will do is remove the index 4263, and leave the test index to have 4263... but then idk who left... let's investigate

Look at 
```{r}
age_tab2<-as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex.feather'))
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')

setdiff(age_tab$id,age_tab2$id)

which(age_tab$id == 24612030)

ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"))
train.test.ind <- list()
train.test.ind$test <-  unlist(ind.temp[2,])
train.test.ind$train <-  unlist(ind.temp[1,])

which(age_tab$id == 24612030) %in% train.test.ind$test
which(age_tab$id == 24612030) %in% train.test.ind$train 
```
Since the missing point is in test set, we can just reduce test set to 1999
Create an empty row
```{r}
age_temp <- rbind(age_tab2[1:(which(age_tab$id == 24612030) -1),], c(24612030,NA,NA),age_tab2[(which(age_tab$id == 24612030)):nrow(age_tab2),] )
```

```{r}
age_temp <- rbind(age_tab2[1:3101,], c(24612030,NA,NA),age_tab2[3102:nrow(age_tab2),] )
```


[// failed, not saved correctly] sep22_sex_gpnn_bbig_init 28666880

[failed]sep25_sex_gpnn_bbig_init_bbs. 28715381, should finish 9pm

[failed, not saved correctly] sep22_sex_gpnn_bbig_init 28715470 ===> 100 epochs

//sep22_sex_gpnn_bbig_init 28721002 ===> 50 epochs should finish at 6pm. 
sep25_sex_gpnn_bbig_init_bbs. 28732835  ===> 50 epochs should finish at 9.30pm. 



#25 Sep
Turns out for sgld,  a4 is just right. Compare a4 to a6 for all measures, e.g. rmse, rsq and coverage
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 200 #500*4
runs <- c(1:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep25_sex_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1:4,7:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb27_gpnn_bb_ig_init_ext_bbs_test_loss__jobid_",i,".csv")))[,1:num.it]
}
runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))



#define legends
leglab <- c(paste0("Gender")
                             ,paste0("No-gender (original)"),"GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.4,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.test, col='magenta',lwd=2)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('right',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.train, col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('right',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
``` 

let's look at R^2
```{r}
#GPNN
num.it <- 200
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep25_sex_gpnn_bbig_init_bbs_rsq__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1:4,7:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb27_gpnn_bb_ig_init_ext_bbs_test_rsq__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,1],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,3],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Gender")
                             ,paste0("No-gender (original)"),"GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=res.iqr[2,],col='red',lwd=2, type = 'l',main = "Test R^2", ylab="R^2", xlab="iteration")
lines(x=1:num.it,y=res.iqr[1,],col='pink',lwd=0.5)
lines(x=1:num.it,y=res.iqr[3,],col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=res.iqr2[2,],col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=res.iqr2[1,],col='lightblue',lwd=0.5)
lines(x=1:num.it,y=res.iqr2[3,],col='lightblue',lwd=0.5)
abline(h=hs.test, col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('right',legend = leglab,lty=c(1),col=c("red",'blue','magenta','navy'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=res.iqr[2,],col='red',lwd=2, type = 'l',main = "Train R^2", ylab="R^2", xlab="iteration")
lines(x=1:num.it,y=res.iqr[1,],col='pink',lwd=0.5)
lines(x=1:num.it,y=res.iqr[3,],col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=res.iqr2[2,],col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=res.iqr2[1,],col='lightblue',lwd=0.5)
abline(h=hs.train, col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('right',legend = leglab,lty=c(1),col=c("red",'blue','magenta','navy'))
```


//sep26_sex_gpnn_bbig_init 28745219

```{r}
runs <- c(1:10)
res1 <- vector(mode = 'numeric')
#res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep26_sex_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
  #res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep14_M_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
}

plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 400 iterations", ylab="RMSE", xlab="Run Number",ylim=c(4,8))
#lines(x = runs,y=sqrt(res2),col='blue',lwd=2, type = 'b')
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Female','Male', 'response sd'),lty=c(1),col=c('red','blue','black'))
```

[FAILED] sep26_sex_gpnn_bbig_init_bbs 28806874 ===> I ACCIDENTALLY RAN sep26_sex_gpnn_bbig_init instead


#26 sep
What to do

1. Split model: Try mixed model but with similar distribution
2. Try interaction model vs no interaction
  2.1 when measuring rmse, split gender
  2.2 Increase number of expansion
  
##Get new indicies
```{r}
#write_feather(balanced_age_tab, '/well/nichols/users/qcv214/KGPNN/age_sex_strat.feather')
age_tab <- as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat.feather'))
```
###Actually what I can do is finding a new, more balanced indices .... changed my mind, I think the model can learn the systematic difference between the gender
```{r}
library(readr)
library(ggplot2)
ggplot(age_tab, aes(x = age, fill = factor(sex))) +
  
  # Define the bin width (5 years)
  geom_histogram(binwidth = 5, position = "dodge", color = "black") +
  
  # Add labels and theme options for better visualization
  labs(title = "Histogram of Age by Sex",
       x = "Age (Years)", y = "Frequency") +
  
  theme_minimal()
```

`age_sex_strat.feather` is sorted by age and grouped by sex, how about I take every 2nd (every 2nd rather than 3rd to keep training set not large)
Each has length 1971
```{r}
write.csv(x = seq(1,nrow(age_tab),2), file = '/well/nichols/users/qcv214/KGPNN/sex_train_index.csv', row.names = FALSE)
write.csv(x = seq(2,nrow(age_tab),2), file = '/well/nichols/users/qcv214/KGPNN/sex_test_index.csv', row.names = FALSE)
```
```{r}
library(readr)
library(ggplot2)
ggplot(age_tab[seq(1,nrow(age_tab),2),], aes(x = age, fill = factor(sex))) +
  
  # Define the bin width (5 years)
  geom_histogram(binwidth = 5, position = "dodge", color = "black") +
  
  # Add labels and theme options for better visualization
  labs(title = "Train Histogram of Age by Sex",
       x = "Age (Years)", y = "Frequency") +
  
  theme_minimal()

ggplot(age_tab[seq(2,nrow(age_tab),2),], aes(x = age, fill = factor(sex))) +
  
  # Define the bin width (5 years)
  geom_histogram(binwidth = 5, position = "dodge", color = "black") +
  
  # Add labels and theme options for better visualization
  labs(title = "Test Histogram of Age by Sex",
       x = "Age (Years)", y = "Frequency") +
  
  theme_minimal()
```

##Plot BBS of long run for interaction model


sep26_gender_gpnn_bbig_init 28850789
sep26_nogender_gpnn_bbig_init  28851189


#28 sep

##Plot data dist of original dataset
```{r}
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')
age_tab <- age_tab[order(age_tab$id),]
age <- age_tab$age
#
ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"))
train.test.ind <- list()
train.test.ind$test <-  unlist(ind.temp[2,])
train.test.ind$train <-  unlist(ind.temp[1,])
```
```{r}
# Assuming age_data is your data.frame, and indices1 and indices2 are your lists of indices
# If not, replace them with the actual names

# Load the necessary libraries
library(ggplot2)

# Define the bin width and breaks
bin_width <- 5
breaks <- seq(0, max(age_tab$age) + bin_width, by = bin_width)

# Create histograms for each group
hist_group1 <- hist(age_tab$age[train.test.ind$train], plot = FALSE, breaks = breaks)
hist_group2 <- hist(age_tab$age[train.test.ind$test], plot = FALSE, breaks = breaks)

# Combine the histograms
combined_hist <- data.frame(
  age = rep(hist_group1$mids, 2),
  count = c(hist_group1$counts, hist_group2$counts),
  group = rep(c("Train", "Test"), each = length(hist_group1$mids))
)

# Create a ggplot object
ggplot(combined_hist, aes(x = age, y = count, fill = group)) +
  geom_bar(stat = "identity", position = "dodge", color = "black") +
  labs(title = "Histogram of Age with Dodge Position",
       x = "Age (Years)", y = "Frequency") +
  theme_minimal() +
  scale_fill_manual(name = "Groups", values = c("Train" = "blue", "Test" = "red")) +
  xlim(42.5, max(combined_hist$age))  # Set x-axis limits
```
So the previous indexing of data was actually really good. 




#28 sep

##Plot the results for bbs... they haven't fully ended
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 1200 #500*4
runs <- c(1,2,5,6,9,10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep26_gender_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(2,6:7,8,9)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep26_nogender_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
}
runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))



#define legends
leglab <- c(paste0("Gender")
                             ,paste0("No-gender (original)"),"GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.4,5.7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.test, col='magenta',lwd=2)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('right',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,6))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.train, col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('right',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
``` 

```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-1200
runs <- c(1,2,5,6,9,10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep26_gender_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-c(1,2,5,6,9,10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep26_gender_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(2,6:7,8,9)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep26_nogender_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- c(2,6:7,8,9)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep26_nogender_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Interact-Male")
                             ,paste0("Interact-Female")
                             ,paste0("Original-Male"), 'Original-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.4,5))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,0.6))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 

Look at held-out BAG

```{r}
train.test.ind <- list()
train.test.ind$test <- read.csv('/well/nichols/users/qcv214/KGPNN/sex_test_index.csv')$x
n.test <- length(train.test.ind$test)
age_tab<-as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat.feather'))

wb2.pred.train <- age_tab$age[train.test.ind$test]
pred.test <- as.matrix(read_feather('/well/nichols/users/qcv214/KGPNN/pile/re_sep26_gender_gpnn_bbig_init_bbs_outpred__jobid_2.feather'))
hs.pred.train <- tail(pred.test[2,],n.test)
rd.pred <- round(hs.pred.train)
hs.pred.train <- hs.pred.train - wb2.pred.train
missing.pred <- setdiff(43:88,rd.pred)
rd.pred <- c(rd.pred,missing.pred)
hs.pred.train <- c(hs.pred.train,rep(100,length(missing.pred)))
boxplot(hs.pred.train ~rd.pred, ylab="BAG (years)", xlab = "Age Prediction (years)", main = "Brain Age Gap of GPNN-Linear-GP-ext",ylim=c(-15,22))
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
boxplot(hs.pred.train ~rd.pred, ylab="BAG (years)", xlab = "Age Prediction (years)", main = "Brain Age Gap of GPNN-Linear-GP-ext",ylim=c(-15,22),add=T)

```
```{r}
train.test.ind <- list()
train.test.ind$test <- read.csv('/well/nichols/users/qcv214/KGPNN/sex_test_index.csv')$x
n.test <- length(train.test.ind$test)
age_tab<-as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat.feather'))

wb2.pred.train <- age_tab$age[train.test.ind$test][which(age_tab$sex[train.test.ind$test] == 1)]
pred.test <- as.matrix(read_feather('/well/nichols/users/qcv214/KGPNN/pile/re_sep26_gender_gpnn_bbig_init_bbs_outpred__jobid_2.feather'))
hs.pred.train <- tail(pred.test[2,],n.test)[which(age_tab$sex[train.test.ind$test] == 1)]
rd.pred <- round(hs.pred.train)
hs.pred.train <- hs.pred.train - wb2.pred.train
missing.pred <- setdiff(43:88,rd.pred)
rd.pred <- c(rd.pred,missing.pred)
hs.pred.train <- c(hs.pred.train,rep(100,length(missing.pred)))
boxplot(hs.pred.train ~rd.pred, ylab="BAG (years)", xlab = "Age Prediction (years)", main = "Brain Age Gap of GPNN-Linear-GP-ext",ylim=c(-15,22))
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
boxplot(hs.pred.train ~rd.pred, ylab="BAG (years)", xlab = "Age Prediction (years)", main = "Brain Age Gap of GPNN-Linear-GP-ext",ylim=c(-15,22),add=T)

wb2.pred.train <- age_tab$age[train.test.ind$test][which(age_tab$sex[train.test.ind$test] == 0)]
pred.test <- as.matrix(read_feather('/well/nichols/users/qcv214/KGPNN/pile/re_sep26_gender_gpnn_bbig_init_bbs_outpred__jobid_2.feather'))
hs.pred.train <- tail(pred.test[2,],n.test)[which(age_tab$sex[train.test.ind$test] == 0)]
rd.pred <- round(hs.pred.train)
hs.pred.train <- hs.pred.train - wb2.pred.train
missing.pred <- setdiff(43:88,rd.pred)
rd.pred <- c(rd.pred,missing.pred)
hs.pred.train <- c(hs.pred.train,rep(100,length(missing.pred)))
boxplot(hs.pred.train ~rd.pred, ylab="BAG (years)", xlab = "Age Prediction (years)", main = "Brain Age Gap of GPNN-Linear-GP-ext",ylim=c(-15,22))
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
boxplot(hs.pred.train ~rd.pred, ylab="BAG (years)", xlab = "Age Prediction (years)", main = "Brain Age Gap of GPNN-Linear-GP-ext",ylim=c(-15,22),add=T)

```
```{r}
# Load the necessary libraries
library(ggplot2)

# Assuming age_tab is your data.frame and train.test.ind$test is your test indices
# If not, replace them with the actual names

# Generate the data
pred.test <- as.matrix(read_feather('/well/nichols/users/qcv214/KGPNN/pile/re_sep26_gender_gpnn_bbig_init_bbs_outpred__jobid_2.feather'))
hs.pred.train <- tail(pred.test[2,], n.test)[which(age_tab$sex[train.test.ind$test] == 1)]
rd.pred <- round(hs.pred.train)
wb2.pred.train <- age_tab$age[train.test.ind$test][which(age_tab$sex[train.test.ind$test] == 1)]
hs.pred.train <- hs.pred.train - wb2.pred.train
missing.pred <- setdiff(43:88,rd.pred)
rd.pred <- c(rd.pred,missing.pred)
hs.pred.train <- c(hs.pred.train,rep(100,length(missing.pred)))

# Combine the data into a data frame
combined_data <- data.frame(rd.pred = rd.pred, hs.pred.train = hs.pred.train)

# Create a ggplot object
ggplot(combined_data, aes(x = factor(rd.pred), y = hs.pred.train)) +
  geom_boxplot(position = position_dodge(width = 0.75)) +
  labs(title = "Brain Age Gap of GPNN-Linear-GP-ext",
       x = "Age Prediction (years)", y = "BAG (years)") +
  ylim(-15, 22) +
  theme_minimal() +
  scale_fill_manual(name = "Sex", values = c("0" = "blue", "1" = "red"))
```

```{r}
# Load the necessary libraries
library(ggplot2)

# Generate the data for sex == 1
wb2.pred.train <- age_tab$age[train.test.ind$test][which(age_tab$sex[train.test.ind$test] == 1)]
pred.test <- as.matrix(read_feather('/well/nichols/users/qcv214/KGPNN/pile/re_sep26_gender_gpnn_bbig_init_bbs_outpred__jobid_2.feather'))
hs.pred.train <- tail(pred.test[2,], n.test)[which(age_tab$sex[train.test.ind$test] == 1)]
rd.pred <- round(hs.pred.train)
hs.pred.train <- hs.pred.train - wb2.pred.train
missing.pred <- setdiff(43:88,rd.pred)
rd.pred <- c(rd.pred,missing.pred)
hs.pred.train <- c(hs.pred.train,rep(100,length(missing.pred)))

# Combine the data into a data frame for sex == 1
combined_data_sex1 <- data.frame(rd.pred = rd.pred, hs.pred.train = hs.pred.train, sex = "Male")

# Generate the data for sex == 0
wb2.pred.train <- age_tab$age[train.test.ind$test][which(age_tab$sex[train.test.ind$test] == 0)]
pred.test <- as.matrix(read_feather('/well/nichols/users/qcv214/KGPNN/pile/re_sep26_gender_gpnn_bbig_init_bbs_outpred__jobid_2.feather'))
hs.pred.train <- tail(pred.test[2,], n.test)[which(age_tab$sex[train.test.ind$test] == 0)]
rd.pred <- round(hs.pred.train)
hs.pred.train <- hs.pred.train - wb2.pred.train
missing.pred <- setdiff(43:88,rd.pred)
rd.pred <- c(rd.pred,missing.pred)
hs.pred.train <- c(hs.pred.train,rep(100,length(missing.pred)))

# Combine the data into a data frame for sex == 0
combined_data_sex0 <- data.frame(rd.pred = rd.pred, hs.pred.train = hs.pred.train, sex = "Female")

# Combine the data frames
combined_data <- rbind(combined_data_sex1, combined_data_sex0)

# Create a ggplot object
ggplot(combined_data, aes(x = factor(rd.pred), y = hs.pred.train, fill = sex)) +
  geom_boxplot(position = position_dodge(width = 0.75)) +
  labs(title = "(Test) Brain Age Gap of Interaction Model",
       x = "Age Prediction (years)", y = "BAG (years)") +
  ylim(-15, 22) +
  theme_minimal() +
  scale_fill_manual(name = "Sex", values = c("Female" = "lightblue", "Male" = "pink"))+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```

```{r}
# Load the necessary libraries
library(ggplot2)

# Generate the data for sex == 1
wb2.pred.train <- age_tab$age[train.test.ind$test][which(age_tab$sex[train.test.ind$test] == 1)]
pred.test <- as.matrix(read_feather('/well/nichols/users/qcv214/KGPNN/pile/re_sep26_nogender_gpnn_bbig_init_bbs_outpred__jobid_2.feather'))
hs.pred.train <- tail(pred.test[2,], n.test)[which(age_tab$sex[train.test.ind$test] == 1)]
rd.pred <- round(hs.pred.train)
hs.pred.train <- hs.pred.train - wb2.pred.train
missing.pred <- setdiff(43:88,rd.pred)
rd.pred <- c(rd.pred,missing.pred)
hs.pred.train <- c(hs.pred.train,rep(100,length(missing.pred)))

# Combine the data into a data frame for sex == 1
combined_data_sex1 <- data.frame(rd.pred = rd.pred, hs.pred.train = hs.pred.train, sex = "Male")

# Generate the data for sex == 0
wb2.pred.train <- age_tab$age[train.test.ind$test][which(age_tab$sex[train.test.ind$test] == 0)]
pred.test <- as.matrix(read_feather('/well/nichols/users/qcv214/KGPNN/pile/re_sep26_nogender_gpnn_bbig_init_bbs_outpred__jobid_2.feather'))
hs.pred.train <- tail(pred.test[2,], n.test)[which(age_tab$sex[train.test.ind$test] == 0)]
rd.pred <- round(hs.pred.train)
hs.pred.train <- hs.pred.train - wb2.pred.train
missing.pred <- setdiff(43:88,rd.pred)
rd.pred <- c(rd.pred,missing.pred)
hs.pred.train <- c(hs.pred.train,rep(100,length(missing.pred)))

# Combine the data into a data frame for sex == 0
combined_data_sex0 <- data.frame(rd.pred = rd.pred, hs.pred.train = hs.pred.train, sex = "Female")

# Combine the data frames
combined_data <- rbind(combined_data_sex1, combined_data_sex0)

# Create a ggplot object
ggplot(combined_data, aes(x = factor(rd.pred), y = hs.pred.train, fill = sex)) +
  geom_boxplot(position = position_dodge(width = 0.75)) +
  labs(title = "(Test) Brain Age Gap of Original Model",
       x = "Age Prediction (years)", y = "BAG (years)") +
  ylim(-15, 22) +
  theme_minimal() +
  scale_fill_manual(name = "Sex", values = c("Female" = "lightblue", "Male" = "pink"))+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```




#29 sep

doing GPGP
I think `gpnn_gpgp_bbig_init_com` is the faster version of `gpnn_gpgp_bbig_init` by doing pre-computation.

[FAILED, didnt save correctly] [node 1,3,10 too slow, the rest were fine] sep29_gender_gpgp_bbig_init.  29355757
// sep29_nogender_gpgp_bbig_init.  29355747

Note that I changed from 4 memories to 8 memories

//sep29_nogender_gpgp_bbig_init_bbs.  29382227.  [I forgot to split male and female when saving]
//sep29_gender_gpgp_bbig_init. 29382649 [I forgot to split male and female when saving]

#1 Oct
##Observe min loss
```{r}
runs <- c(1:2,4:7,9)
res1 <- vector(mode = 'numeric')
res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep29_gender_gpgp_bbig_init_minloss__jobid_",i,".csv"))$x)
  res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep29_nogender_gpgp_bbig_init_minloss__jobid_",i,".csv"))$x)
}

plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "GPGP Minimum Test RMSE across 2000 iterations", ylab="RMSE", xlab="Run Number",ylim=c(4,8))
lines(x = runs,y=sqrt(res2),col='blue',lwd=2, type = 'b')
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Interaction','Original', 'response sd'),lty=c(1),col=c('red','blue','black'))
```
##Observe BBS
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-2000
runs <- c(1,2,5,6,7,10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep29_gender_gpgp_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-c(1,2,4:9)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep29_nogender_gpgp_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Interaction model")
                             ,paste0("Original model"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.4,7))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')

abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,7))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')

abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'navy','lightblue','magenta','black'))
``` 
Weird behaviour

##To do
###1. SGLD for gpnn and gpgp
Running
oct2_gender_gpnn_sgld_a4_b0_near. 29454776
oct2_nogender_gpnn_sgld_a4_b0_near. 29454786
//oct2_gender_gpgp_sgld_a4_b0_near. 29454796
//oct2_nogender_gpgp_sgld_a4_b0_near  29454806

###2. build a nn
oct2_gender_nn_bbig_init. 29454830
oct2_nogender_nn_bbig_init. 29456033

Min loss of interaction
```{r}
runs <- c(1:10)
res1 <- vector(mode = 'numeric')
#res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct2_gender_nn_bbig_init_minloss__jobid_",i,".csv"))$x)
  #res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep29_nogender_gpgp_bbig_init_minloss__jobid_",i,".csv"))$x)
}

plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "NN Minimum Test RMSE across 1200 iterations", ylab="RMSE", xlab="Run Number",ylim=c(4,8))
#lines(x = runs,y=sqrt(res2),col='blue',lwd=2, type = 'b')
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Interaction','Original', 'response sd'),lty=c(1),col=c('red','blue','black'))
```
```{r}
runs <- c(1:10)
res1 <- vector(mode = 'numeric')
res2 <- vector(mode = 'numeric')
res3 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct2_gender_nn_bbig_init_minloss__jobid_",i,".csv"))$x)
  res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct2_nogender_nn_bbig_init_minloss__jobid_",i,".csv"))$x)
  res3 <- c(res3,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep26_sex_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
}

plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 1200 iterations", ylab="RMSE", xlab="Run Number",ylim=c(4,7.5))
lines(x = runs,y=sqrt(res2),col='blue',lwd=2, type = 'b')
lines(x = runs,y=sqrt(res3),col='darkgreen',lwd=2, type = 'b')

abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('NN-Interaction','NN-Original','GPNN-Interction', 'response sd'),lty=c(1),col=c('red','blue','darkgreen','black'))
```

Do Bayes cal


Currently
//oct3_gender_nn_bbig_init_bbs. 29528602
//oct3_nogender_nn_bbig_init_bbs.  29528612


#4 Oct
After meeting with Jian on tues 3rd

## Want to Increase number of training.
I will first try like before. So run bb on 2k dataset, then increase the number of training to 4k and 6k during bbs
look at `gpnn_init_ext_bbs_addtrain.R` and  `bnn2/res3/age_add1.feather`

### Load up `age_add1` and find corresponding gender
```{r}
#The extra 4258 participants age tab
age_tab_add<- read_feather('/well/nichols/users/qcv214/bnn2/res3/age_add1.feather')

#Add raw age tab file
agetab<-read.table(file = '/well/nichols/projects/UKB/SMS/ukb_latest-Age.tsv', sep = '\t', header = TRUE) #This is 42940 x 11

```

```{r}
age_tab_add$sex <- rep(NA, nrow(age_tab_add))
for(i in 1:nrow(age_tab_add)){
  age_tab_add$sex[i]<-agetab$X31.0.0[agetab$eid_8107==sub(".", "",age_tab_add$id[i])]
}
#To check empty gender => sum(is.na(age_tab_add$sex))
```
To check quick summary, type `summary(age_tab_add[,2:3])` which shows that 46% is female
Save 
```{r}
write_feather(age_tab_add, '/well/nichols/users/qcv214/KGPNN/age_sex_add1.feather')
```

Addtrain
Running 
oct4_gender_gpnn_bbig_init_bbs_addtrain2k_75  29531291
oct4_gender_gpnn_bbig_init_bbs_addtrain4k_50  29531321
oct4_gender_gpgp_bbig_init_bbs_addtrain2k_75 29531403
oct4_gender_gpgp_bbig_init_bbs_addtrain4k_50 29531393



#5 oct
Plot
oct3_gender_nn_bbig_init_bbs
oct3_nogender_nn_bbig_init_bbs
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-1200
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct3_gender_nn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct3_gender_nn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <-1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct3_nogender_nn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- 1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct3_nogender_nn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Interact-Male")
                             ,paste0("Interact-Female")
                             ,paste0("Original-Male"), 'Original-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.4,5))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,0.6))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 
This hasn't converged. And it is better than than GPNN!! I am gonna let it run for longer


oct3_gender_nn_bbig_init_bbs. 29854715
oct3_nogender_nn_bbig_init_bbs.  29854778
##Longer run of NN
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-2000
runs <- c(1,2,3,7,8,10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct5_gender_nn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-c(1,2,3,7,8,10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct5_gender_nn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(1,2,3,5,6,10)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct5_nogender_nn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- c(1,2,3,5,6,10)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct5_nogender_nn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Interact-Male")
                             ,paste0("Interact-Female")
                             ,paste0("Original-Male"), 'Original-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.4,5))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,0.6))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 


//oct4_gender_gpnn_bbig_init_bbs_addtrain2k_50  29855151
//oct4_gender_gpnn_bbig_init_bbs_addtrain4k_25  29854984
// (some) oct4_gender_gpgp_bbig_init_bbs_addtrain2k_50. 29855476.  ==> I forgot to split male/female
//(some) oct4_gender_gpgp_bbig_init_bbs_addtrain4k_25. 29855331. ==> I forgot to split male/female
 
oct5_male_nogender_gpnn_bbig_init.   29952513
oct5_female_nogender_gpnn_bbig_init.  29952499

#6 oct

##Plot add train gnn
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-300
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct4_gender_gpnn_bbig_init_bbs_addtrain2k_50_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct4_gender_gpnn_bbig_init_bbs_addtrain2k_50_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <-1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct4_gender_gpnn_bbig_init_bbs_addtrain4k_25_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- 1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct4_gender_gpnn_bbig_init_bbs_addtrain4k_25_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("4k-Male")
                             ,paste0("4k-Female")
                             ,paste0("6k-Male"), '6k-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE of interaction model", ylab="RMSE", xlab="iteration",ylim=c(4,6))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE of interaction model", ylab="RMSE", xlab="iteration",ylim=c(0,4))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 


Running
//oct6_gender_gpgp_bbig_init_bbs_addtrain2k_50 29952547
//oct6_gender_gpgp_bbig_init_bbs_addtrain4k_25 29952557


##Plot add train GPGP
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-300
runs <- c(2:7,9:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct6_gender_gpgp_bbig_init_bbs_addtrain2k_50_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(2:7,9:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct6_gender_gpgp_bbig_init_bbs_addtrain2k_50_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(2,3,4,7,9)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct6_gender_gpgp_bbig_init_bbs_addtrain4k_25_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <-c(2,3,4,7,9)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct6_gender_gpgp_bbig_init_bbs_addtrain4k_25_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("4k-Male")
                             ,paste0("4k-Female")
                             ,paste0("6k-Male"), '6k-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE of interaction model", ylab="RMSE", xlab="iteration",ylim=c(4,8))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE of interaction model", ylab="RMSE", xlab="iteration",ylim=c(4,6))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 
This doesnt look so good...

//oct6_male_nogender_gpnn_bbig_init_bbs 30002394
//oct6_female_nogender_gpnn_bbig_init_bbs 30002329
//oct6_gender_gpgp_sgld_5a5_b0_near 30002900
//oct6_gender_gpgp_sgld_a5_b0_near. 30002868


#8 oct
##Compare interaction vs separate fitting
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-600
runs <- c(1,2,5,6,9,10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep26_gender_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-c(1,2,5,6,9,10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep26_gender_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(2,3,5:9)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct6_male_nogender_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- 1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct6_female_nogender_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Interact-Male")
                             ,paste0("Interact-Female")
                             ,paste0("Separate-Male"), 'Separate-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.4,5))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,4))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 


//oct9_gender_gpgp_sgld_5a4_b0_near. 30261140
//oct9_gender_gpgp_sgld_a3_b0_near. 30261162

#11 Oct

##Re running for saliency
sep26_nogender_gpnn_bbig_init_bbs is already correct

//oct11_gender_gpnn_bbig_init_bbs. 30550901
//oct11_gender_nn_bbig_init_bbs.  30551007
//oct11_gender_gpgp_bbig_init_bbs. 30551140

##Re run gpgp add train
oct11_gender_gpgp_bbig_init_bbs_addtrain2k_250 30551441
oct11_gender_gpgp_bbig_init_bbs_addtrain4k_167. 30551457

#21 Oct
Re-plot gpgp add train
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-2000
runs <- c(2:7,9:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct11_gender_gpgp_bbig_init_bbs_addtrain2k_250_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(2:7,9:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct11_gender_gpgp_bbig_init_bbs_addtrain2k_250_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(2,3,4,7,9)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct11_gender_gpgp_bbig_init_bbs_addtrain4k_167_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <-c(2,3,4,7,9)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_oct11_gender_gpgp_bbig_init_bbs_addtrain4k_167_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("4k-Male")
                             ,paste0("4k-Female")
                             ,paste0("6k-Male"), '6k-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE of interaction model", ylab="RMSE", xlab="iteration",ylim=c(4,8))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE of interaction model", ylab="RMSE", xlab="iteration",ylim=c(4,6))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 
##I should also re-run 3 versions of sgld... to keep training at 95%
//oct21_gender_gpnn_sgld_a3_b0_near. 32533480
//oct21_gender_gpnn_sgld_5a3_b0_near.  32533441
[failed] oct21_gender_gpgp_sgld_5a3_b0_near  32533457 ==> 500 epochs [time limit exceeded]

oct21_gender_gpgp_sgld_5a3_b0_near. 32578261 ==> 300 epochs


#30 Oct
I've checked the saliency of gpgp in 32808407, everything was fine I will disect it into beta and interaction effects
running oct30_gender_gpgp_bbig_init_bbs 32846320

Running 
//nov2_cov_gpnn_bbig_init 33036684 ==> 100 epochs
//nov3_cov_gpnn_bbig_init 33042133 ==> 500 epochs [only a few survived due to time limit] [4,5,7,10]


#5 Nov
##Plot minimum loss of cov 100 epochs
```{r}
runs <- c(1:10)
res1 <- vector(mode = 'numeric')
#res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov2_cov_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
  #res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep29_nogender_gpgp_bbig_init_minloss__jobid_",i,".csv"))$x)
}

plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "NN Minimum Test RMSE across 2000 iterations", ylab="RMSE", xlab="Run Number",ylim=c(3,8))
#lines(x = runs,y=sqrt(res2),col='blue',lwd=2, type = 'b')
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Interaction','Original', 'response sd'),lty=c(1),col=c('red','blue','black'))
```
I have to run it 300 times and see, rather than 100 or 500. 


Currently running 
nov5_cov_gpnn_bbig_init_bbs  33251791 (300 epochs) on top of nov2 100 epochs
//nov5_cov_gpnn_bbig_init  33242677

##Plot minimum loss of cov 300 epochs
```{r}
runs <- c(1:10)
res1 <- vector(mode = 'numeric')
#res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov5_cov_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
  #res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep29_nogender_gpgp_bbig_init_minloss__jobid_",i,".csv"))$x)
}

plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 1200 iterations", ylab="RMSE", xlab="Run Number",ylim=c(3,8))
#lines(x = runs,y=sqrt(res2),col='blue',lwd=2, type = 'b')
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model', 'response sd'),lty=c(1),col=c('red','black'))
```
This looks exactly like the init with 100 epochs??.
##Have a look at the co-weights
```{r}
runs <- c(1:10)
res1 <- matrix(,ncol=2,nrow=10)
res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1[i,] <- unlist(c(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov5_cov_gpnn_bbig_init_mincoweights__jobid_",i,".csv"))))
  res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov5_cov_gpnn_bbig_init_mincobias__jobid_",i,".csv"))$x)
}


#The good ones are the ones with strong magnitude
```

write.csv(min.co.weights,paste0( '/well/nichols/users/qcv214/KGPNN/pile/re_',filename,'_mincoweights_',"_jobid_",JobId,".csv"), row.names = FALSE)


##Plot bbs on top of 100
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-1200
runs <- c(1,2,5,6,9,10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep26_gender_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-c(1,2,5,6,9,10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep26_gender_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <-  1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov5_cov_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- 1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov5_cov_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Interact-Male")
                             ,paste0("Interact-Female")
                             ,paste0("Separate-Male"), 'Separate-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.4,8))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 

Running
//nov6_cov_gpnn_bbig_init_bbs 33323450 (on top of 100 init with JobId 2)
//nov7_covbn_gpnn_bbig_init 33431543 (Batch normalisation. Initial co-weights and co-bias change to N(0,0.1))

##Plot 
nov6_cov_gpnn_bbig_init_bbs (on top of 100 init with JobId 2)
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-1200
runs <- c(1,2,5,6,9,10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep26_gender_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-c(1,2,5,6,9,10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep26_gender_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <-  c(1,2,4:9)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov6_cov_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- c(1,2,4:9)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov6_cov_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Interact-Male")
                             ,paste0("Interact-Female")
                             ,paste0("Separate-Male"), 'Separate-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.4,8))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 
Much higher train RMSE but same test RMSE??. Note that test RMSE rose somehow

#8 nov
##Plot batchnorm
```{r}
runs <- c(4,6,7,8)
res1 <- vector(mode = 'numeric')
#res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov7_covbn_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
  #res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep29_nogender_gpgp_bbig_init_minloss__jobid_",i,".csv"))$x)
}

plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 1200 iterations", ylab="RMSE", xlab="Run Number",ylim=c(3,8))
#lines(x = runs,y=sqrt(res2),col='blue',lwd=2, type = 'b')
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model', 'response sd'),lty=c(1),col=c('red','black'))
```
Most run failed due to 
`Error in fast_normal_lm(age[mini.batch$train[[b]]], z.nb) : matrix multiplication: incompatible matrix dimensions: 0x0 and 471x1`

Look at min weights and biases
```{r}
runs <- c(4,6,7,8)
res1 <- matrix(,ncol=2,nrow=length(runs))
res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1[which(i==runs),] <- unlist(c(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov7_covbn_gpnn_bbig_init_mincoweights__jobid_",i,".csv"))))
  res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov7_covbn_gpnn_bbig_init_mincobias__jobid_",i,".csv"))$x)
}
#Best run (6) is obtained when co.weights and co.bias are huge (1e+4)
```

Currently running
//nov8_covbn_gpnn_bbig_init_bbs. 33860556 ==> i wanna see if it runs in the right direction (100 epochs) => bad
[didn't run] nov6_cov_gpnn_bbig_init_bbs_t 33866099 => delete - from the bias


#Let's look covbn init
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-400
runs <- c(1:3,5:7,9:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov8_covbn_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1:3,5:7,9:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov8_covbn_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <-  c(1,2,4:9)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov6_cov_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- c(1,2,4:9)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov6_cov_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("with BN-Male")
                             ,paste0("with BN-Female")
                             ,paste0("without BN-Male"), 'without BN-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.4,8))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 


Running 
//nov6_cov_gpnn_bbig_init_bbs_t 33926277  => delete - from the bias
//nov9_gender_gpnn_bbig_init_bbs_t 33926646 => 300 epochs, test for change in bias sign (compare against gender_gpnn)
nov9_cov_gpnn_bbig_init 33939442 => fix gradient of sigmoid prime

#10 Nov
## Compare change of bias sign in gender gpnn
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-1200
runs <- c(1,2,5,6,9,10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep26_gender_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-c(1,2,5,6,9,10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep26_gender_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <-  c(1,4:10)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov9_gender_gpnn_bbig_init_bbs_t_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <-  c(1,4:10)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov9_gender_gpnn_bbig_init_bbs_t_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Interact-Male")
                             ,paste0("Interact-Female")
                             ,paste0("Interact-biascorrect-Male"), 'Interact-biascorrect-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.4,5.5))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,4))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 

Correcting the bias sign makes it marginally better for both gender.

## Compare change of bias sign in cov gpnn
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-400
runs <- c(1:3,5:7,9:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov6_cov_gpnn_bbig_init_bbs_t_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1:3,5:7,9:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov6_cov_gpnn_bbig_init_bbs_t_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <-  c(1,2,4:9)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov6_cov_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- c(1,2,4:9)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov6_cov_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("cov-falseBias-Male")
                             ,paste0("cov-falseBias-Female")
                             ,paste0("cov-Male"), 'cov-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.4,8))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 
This case, wrong bias specification is marginally better.

###We can conclude that there's no effect here.

##Correcting sigmoid gradient
```{r}
runs <- c(1:5,7:10)
res1 <- vector(mode = 'numeric')
#res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov9_cov_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
  #res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep29_nogender_gpgp_bbig_init_minloss__jobid_",i,".csv"))$x)
}

plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 1200 iterations", ylab="RMSE", xlab="Run Number",ylim=c(3,8))
#lines(x = runs,y=sqrt(res2),col='blue',lwd=2, type = 'b')
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model', 'response sd'),lty=c(1),col=c('red','black'))
```

Currently running

[failed] nov9_cov_gpnn_bbig_init_bbs 34045119   note run6 is missing. THIS IS WRONG INITIAL RUN, RE-RUN AGAIN
[failed] nov10_covbn_gpnn_bbig_init  34045156.   correcting sigmoid update. EITHER FAULTY OR RUN TOO LONG. but only 300 epochs tho, I will decrease it to 200.
//nov11_cov_gpnn_bbig_init_bbs  34314269. running on nov9 init, run 6 is missing
//nov12_covbn_gpnn_bbig_init 34341911


The strange behaviour is due to wrong initialisation

##Look at  nov11 cov bbs
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-1200
runs <- c(1,4:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov9_gender_gpnn_bbig_init_bbs_t_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-c(1,4:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov9_gender_gpnn_bbig_init_bbs_t_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <-  c(1:5,7:10)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov11_cov_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <-  c(1:5,7:10)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov11_cov_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Interact-Male")
                             ,paste0("Interact-Female")
                             ,paste0("Interact-biascorrect-Male"), 'Interact-biascorrect-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.4,8))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 
## Plot nov11 cov against  nov 6 cov (wrong sigmoid prime I think, and run on a good initial)

Look at median case
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-1200
runs <- c(1:3,5:7,9:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov6_cov_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-c(1:3,5:7,9:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov6_cov_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <-  c(1:5,7:10)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov11_cov_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <-  c(1:5,7:10)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov11_cov_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Interact-Male")
                             ,paste0("Interact-Female")
                             ,paste0("Interact-biascorrect-Male"), 'Interact-biascorrect-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(3,8))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,1))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 
Look at best case
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-1200
runs <- c(1:3,5:7,9:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov6_cov_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-c(1:3,5:7,9:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov6_cov_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <-  c(1:5,7:10)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov11_cov_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <-  c(1:5,7:10)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov11_cov_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Interact-Male")
                             ,paste0("Interact-Female")
                             ,paste0("Interact-biascorrect-Male"), 'Interact-biascorrect-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(3,8))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 
##Let's compare gender to cov

###Median cases

```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-1200
runs <- c(1,4:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov9_gender_gpnn_bbig_init_bbs_t_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-c(1,4:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov9_gender_gpnn_bbig_init_bbs_t_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <-  c(1:5,7:10)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov11_cov_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <-  c(1:5,7:10)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov11_cov_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("GenderModel-Male")
                             ,paste0("GenderModel-Female")
                             ,paste0("LatentModel-Male"), 'LatentModel-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(3,8))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 

###Best cases
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-1200
runs <- c(1,4:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov9_gender_gpnn_bbig_init_bbs_t_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-c(1,4:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov9_gender_gpnn_bbig_init_bbs_t_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <-  c(1:5,7:10)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov11_cov_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <-  c(1:5,7:10)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov11_cov_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0,0))
hs.test <-quantile(hs.int[,6],c(0,0))

#define legends
leglab <- c(paste0("GenderModel-Male")
                             ,paste0("GenderModel-Female")
                             ,paste0("LatentModel-Male"), 'LatentModel-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(3,8))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 
Note that for the above, BBS Smoothing is still wrong

####Let's observe the weights of gender
l_weights
```{r}
runs <-  c(1,4:10)
#res1 <- matrix(,ncol=2,nrow=length(runs))
res1 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,unlist(read_feather(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov9_gender_gpnn_bbig_init_bbs_t_lweights__jobid_",i,".feather")))[13])
}
summary(res1)
```


####Observe the latent and first-level weights of non-imaging
l_weights

```{r}
runs <- c(1:5,7:10)
res1 <- matrix(,ncol=2,nrow=length(runs))
res1 <- vector(mode = 'numeric')
for (i in runs){ 

  res1 <- c(res1,unlist(read_feather(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov11_cov_gpnn_bbig_init_bbs_lweights__jobid_",i,".feather")))[13])
}
summary(res1)
```
co.weights
```{r}
runs <- c(1:5,7:10)
res1 <- matrix(,ncol=2,nrow=length(runs))
res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1[which(i==runs),] <- unlist(c(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov11_cov_gpnn_bbig_init_bbs_coweights__jobid_",i,".csv"))))
  res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov11_cov_gpnn_bbig_init_bbs_cobias__jobid_",i,".csv"))$x)
}
summary(res1)
summary(res2)
```

#13 nov

##Plot init of batchnorm
```{r}
runs <- c(1,3,5,6)
res1 <- vector(mode = 'numeric')
#res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov12_covbn_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
  #res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep29_nogender_gpgp_bbig_init_minloss__jobid_",i,".csv"))$x)
}

plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 1200 iterations", ylab="RMSE", xlab="Run Number",ylim=c(3,8))
#lines(x = runs,y=sqrt(res2),col='blue',lwd=2, type = 'b')
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model', 'response sd'),lty=c(1),col=c('red','black'))
```
BN is numerically unstable, but it seems to achieve the same minimum test

Currently running
//nov13_covbn_gpnn_bbig_init_bbs.  34370127 ==> 150 epochs, corrected sigmoid, grad.b, and BBS to account for non-img input
//nov13_cov_gpnn_bbig_init_bbs. 34370476 ===> 150 epochs, corrected BBS and co.weights loading

I should also correct for BB learning rate of the initialisation of 
-gender ==> I think this doesn't require... because we don't use gradient update here.
-cov
-cov bn


Running
[only 8 survived.. how] nov13_cov_gpnn_bbig_init  34372126  => 200 epochs, correcting BB
nov13_covbn_gpnn_bbig_init  34372127 => 200 epochs, correcting BB


##Look nov13 covbn vs cov
###Median cases

```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-600
runs <- c(1:5,7:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov13_cov_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1:5,7:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov13_cov_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <-   1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov13_covbn_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <-  1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov13_covbn_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("LatentModel-Male")
                             ,paste0("LatentModel-Female")
                             ,paste0("LatentModel-BN-Male"), 'LatentModel-BN-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(3,8))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 

###Best cases
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-600
runs <- c(1:5,7:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov13_cov_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1:5,7:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov13_cov_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <-   1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov13_covbn_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <-  1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov13_covbn_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0,0))
hs.test <-quantile(hs.int[,6],c(0,0))

#define legends
leglab <- c(paste0("LatentModel-Male")
                             ,paste0("LatentModel-Female")
                             ,paste0("LatentModel-BN-Male"), 'LatentModel-BN-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(3,8))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 
#### coef of cov
l_weights
```{r}
runs <- c(1,2,8)#c(1:5,7:10)
res1 <- matrix(,ncol=2,nrow=length(runs))
res1 <- vector(mode = 'numeric')
for (i in runs){ 

  res1 <- c(res1,unlist(read_feather(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov13_cov_gpnn_bbig_init_bbs_lweights__jobid_",i,".feather")))[13])
}
summary(res1)
res1
```
co.weights
```{r}
runs <- c(1,2,8)#c(1:5,7:10)
res1 <- matrix(,ncol=2,nrow=length(runs))
res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1[which(i==runs),] <- unlist(c(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov13_cov_gpnn_bbig_init_bbs_coweights__jobid_",i,".csv"))))
  res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov13_cov_gpnn_bbig_init_bbs_cobias__jobid_",i,".csv"))$x)
}
summary(res1)
res1
#summary(res2)
```


#### coef of cov BN
l_weights
```{r}
runs <- c(1,3,5,7,9)#1:10
res1 <- matrix(,ncol=2,nrow=length(runs))
res1 <- vector(mode = 'numeric')
for (i in runs){ 

  res1 <- c(res1,unlist(read_feather(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov13_covbn_gpnn_bbig_init_bbs_lweights__jobid_",i,".feather")))[13])
}
summary(res1)
res1
```
co.weights
```{r}
runs <- c(1,3,5,7,9)#1:10
res1 <- matrix(,ncol=2,nrow=length(runs))
res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1[which(i==runs),] <- unlist(c(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov13_covbn_gpnn_bbig_init_bbs_coweights__jobid_",i,".csv"))))
  res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov13_covbn_gpnn_bbig_init_bbs_cobias__jobid_",i,".csv"))$x)
}
#summary(res1)
res1
summary(res2)
```


#15 Nov
Currently running:
[6]nov13_cov_gpnn_bbig_init  34614594  => 200 epochs, correcting BB, steep sigmoid
[2,4]nov135_covbn_gpnn_bbig_init  34614568 => 200 epochs, correcting BB, steep sigmoid [Note I accidentally put 135 instead of 15]

##Look at mind loss
###nov13 cov
```{r}
runs <- c(6)
res1 <- vector(mode = 'numeric')
#res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov15_cov_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
  #res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep29_nogender_gpgp_bbig_init_minloss__jobid_",i,".csv"))$x)
}
plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 1200 iterations", ylab="RMSE", xlab="Run Number",ylim=c(3,8))
#lines(x = runs,y=sqrt(res2),col='blue',lwd=2, type = 'b')
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model', 'response sd'),lty=c(1),col=c('red','black'))
```

###nov135 covbn
```{r}
runs <- c(2,4)
res1 <- vector(mode = 'numeric')
#res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov135_covbn_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
  #res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep29_nogender_gpgp_bbig_init_minloss__jobid_",i,".csv"))$x)
}

plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 1200 iterations", ylab="RMSE", xlab="Run Number",ylim=c(3,8))
#lines(x = runs,y=sqrt(res2),col='blue',lwd=2, type = 'b')
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model', 'response sd'),lty=c(1),col=c('red','black'))
```


Currently running 
//nov16_covbn_gpnn_bbig_init_bbs 34672791 ==> on top of nov135, 150 epochs
//nov16_cov_gpnn_bbig_init_bbs 34672788 ==> on top ov nov15

##Look nov16covbn vs cov ==> changing activation function of latent subclass


###Median cases

```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-600
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov16_cov_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov16_cov_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <-   c(1,9,10)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov16_covbn_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <-  c(1,9,10)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov16_covbn_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("LatentModel-Male")
                             ,paste0("LatentModel-Female")
                             ,paste0("LatentModel-BN-Male"), 'LatentModel-BN-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(3,8))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 

###Best cases
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-600
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov16_cov_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov16_cov_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <-   c(1,9,10)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov16_covbn_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <-  c(1,9,10)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov16_covbn_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0,0))
hs.test <-quantile(hs.int[,6],c(0,0))

#define legends
leglab <- c(paste0("LatentModel-Male")
                             ,paste0("LatentModel-Female")
                             ,paste0("LatentModel-BN-Male"), 'LatentModel-BN-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(3,8))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 
When looked at best cases, there is not much difference between BN and non BN

#18 nov 
Getting Saliency
//nov18_covbn_gpnn_bbig_init_bbs  35219411
//nov18_cov_gpnn_bbig_init_bbs  35219449



#20 nov

##Look at identifiability of after changing sigmoid to be steeper

###cov 
main latent coef
```{r}
runs <- c(1:10)
res1 <- matrix(,ncol=2,nrow=length(runs))
res1 <- vector(mode = 'numeric')
for (i in runs){ 

  res1 <- c(res1,unlist(read_feather(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov16_cov_gpnn_bbig_init_bbs_lweights__jobid_",i,".feather")))[13])
}
summary(res1)
```
co.weights
```{r}
runs <- c(1:10)
res1 <- matrix(,ncol=2,nrow=length(runs))
res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1[which(i==runs),] <- unlist(c(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov16_cov_gpnn_bbig_init_bbs_coweights__jobid_",i,".csv"))))
  res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov16_cov_gpnn_bbig_init_bbs_cobias__jobid_",i,".csv"))$x)
}
summary(res1)
summary(res2)
```

###covBN
main latent coef
```{r}
runs <- c(1,9,10)
res1 <- matrix(,ncol=2,nrow=length(runs))
res1 <- vector(mode = 'numeric')
for (i in runs){ 

  res1 <- c(res1,unlist(read_feather(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov16_covbn_gpnn_bbig_init_bbs_lweights__jobid_",i,".feather")))[13])
}
summary(res1)
```
co.weights
```{r}
runs <-  c(1,9,10)
res1 <- matrix(,ncol=2,nrow=length(runs))
res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1[which(i==runs),] <- unlist(c(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov16_covbn_gpnn_bbig_init_bbs_coweights__jobid_",i,".csv"))))
  res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov16_covbn_gpnn_bbig_init_bbs_cobias__jobid_",i,".csv"))$x)
}
summary(res1)
summary(res2)
```
###Compare performance of steep sigmoid on cov
####Median cases
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-600
runs <- c(1:5,7:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov13_cov_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1:5,7:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov13_cov_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <-1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov16_cov_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <-1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov16_cov_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("LatentModel-Male")
                             ,paste0("LatentModel-Female")
                             ,paste0("LatentModel-SteepAct-Male"), 'LatentModel-SteepAct-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(3,8))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 

####Best cases
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-600
runs <- c(1:5,7:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov13_cov_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1:5,7:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov13_cov_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <-1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov16_cov_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <-1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov16_cov_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0,0))
hs.test <-quantile(hs.int[,6],c(0,0))

#define legends
leglab <- c(paste0("LatentModel-Male")
                             ,paste0("LatentModel-Female")
                             ,paste0("LatentModel-SteepAct-Male"), 'LatentModel-SteepAct-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(3,8))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 

###I am investigating the effect of BN

*note i just realised i have been using a factor of var(BN) rather than sd(BN)!!
I've updated it now.

#22nov
scrap BN ideas. Not feasible to do without auto differentiation

I plan to evaluate the effect for imaging variable

Currently
nov22_covdummy_gpnn_bbig_init 36336362 == >We should not expect better test performance than gender inter model. 
[All failed]nov22_covage_gpnn_bbig_init  36364151 ==> This should work well. dissert age group into 8 bins between 45-85 `[Error in fast_normal_lm(age[mini.batch$train[[b]]], z.nb) : matrix multiplication: incompatible matrix dimensions: 0x0 and 500x1]`
//nov22_covage_gpnn_bbig_init 36558008 ==> initialise co.weights to n(0,0.01)

#23 nov
##plot min loss of dummy
```{r}
runs <- c(3,4,9,10)
res1 <- vector(mode = 'numeric')
#res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov22_covdummy_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
  #res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep29_nogender_gpgp_bbig_init_minloss__jobid_",i,".csv"))$x)
}

plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 800 iterations", ylab="RMSE", xlab="Run Number",ylim=c(3,8))
#lines(x = runs,y=sqrt(res2),col='blue',lwd=2, type = 'b')
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model', 'response sd'),lty=c(1),col=c('red','black'))
```
Very stable... okay performance. let's run optimisation

##plot min loss of covage
```{r}
runs <- c(1,3,6,7,10)
res1 <- vector(mode = 'numeric')
#res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov22_covage_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
  #res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_sep29_nogender_gpgp_bbig_init_minloss__jobid_",i,".csv"))$x)
}

plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 800 iterations", ylab="RMSE", xlab="Run Number",ylim=c(1,8))
#lines(x = runs,y=sqrt(res2),col='blue',lwd=2, type = 'b')
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model', 'response sd'),lty=c(1),col=c('red','black'))
```
run number 3 is incredible.

Currently running
//nov23_covdummy_gpnn_bbig_init_bbs 36592078
//nov23_covage_gpnn_bbig_init_bbs. 36679399

#27 Nov

##Look at MultiClass age
####Median cases
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-600
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov16_cov_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov16_cov_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <-1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov23_covage_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <-1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov23_covage_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("LatentModel-BinAge-Male")
                             ,paste0("LatentModel-BinAge-Female")
                             ,paste0("LatentModel-MultAge-Male"), 'LatentModel-MultAge-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 

####Best cases
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-600
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov16_cov_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov16_cov_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <-1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov23_covage_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <-1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov23_covage_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0,0))
hs.test <-quantile(hs.int[,6],c(0,0))

#define legends
leglab <- c(paste0("LatentModel-BinAge-Male")
                             ,paste0("LatentModel-BinAge-Female")
                             ,paste0("LatentModel-MultAge-Male"), 'LatentModel-MultAge-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 


###Dummy variable
Best cases of dummy vs bin age
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-600
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov16_cov_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov16_cov_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <-1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov23_covdummy_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <-1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov23_covdummy_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("LatentModel-BinAge-Male")
                             ,paste0("LatentModel-BinAge-Female")
                             ,paste0("LatentModel-Dummy-Male"), 'LatentModel-Dummy-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(3,8))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 

Best cases of dummy vs gender
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-600
runs <- c(1,4:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov9_gender_gpnn_bbig_init_bbs_t_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-c(1,4:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov9_gender_gpnn_bbig_init_bbs_t_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <-1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov23_covdummy_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <-1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov23_covdummy_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("GenderModel-Male")
                             ,paste0("GenderModel-Female")
                             ,paste0("LatentModel-Dummy-Male"), 'LatentModel-Dummy-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(3,8))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 



#1 Dec

Correcting theta updates for latent model. The models were using sex to update interaction rather than latent
Running
Haven't fixed updates for bias
dec1_cov_gpnn_bbig_init 38984709
dec1_covage_gpnn_bbig_init 38985171
dec1_covdummy_gpnn_bbig_init 38985169

I think I've mistakenly put result of Relu into Relu prime function, rather than pre-relu into relu prime. I think because of relu, this shouldn't affect the outcome. 
I've mistakenly used wrong gradients.
All encountered gradient vanishing.

Testing dec1_covage_gpnn_bbig_init 38994597 with original shifted sigmoid
dec1_sm_gpnn_bbig_init 38998370 ==>first ver of softmax...... *nn.e39007226.004* I think got test rmse below ~1.4
dec2_sm_gpnn_bbig_init 39015328 ==> change softmax to original. RMSE ~ 1.3
dec1_covage_gpnn_bbig_init. 39015483 ==> constrain original sigmoid prime


I am going to observe gradient vanishing with contrained modified sigmoid prime. It's not even vanishing, it's just NA
dec1_covage_gpnn_bbig_init 39073254
dec2_sm_gpnn_bbig_init 39039348 observe gradient vanishing


According to 39073254 => job failed right when the co.pre.hidden.layer, co.weights, co.bias exploded (going from ~0.1 to 1000 in 1 step)
dec1_covage_gpnn_bbig_init 39095387 ==> capping BB to max 5

Latest Currently runnung
//dec4_covage_gpnn_bbig_init 39123511 ===> no cap on BB, but cap the input of sigmoid prime. The problem comes in due to numerical instability of sigmoid prime.
//dec4_cov_gpnn_bbig_init 39133631
//dec4_covdummy_gpnn_bbig_init 39133734
//dec4_sm_gpnn_bbig_init 39134005

#5 Dec
Plot lowest of each
cov_gpnn
```{r}
runs <- c(1,3,4,5,6,8,10)
res1 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec4_cov_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
}

plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 800 iterations", ylab="RMSE", xlab="Run Number",ylim=c(1,8))
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model', 'response sd'),lty=c(1),col=c('red','black'))
```
covage
```{r}
runs <- c(1,3:10)
res1 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec4_covage_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
}
plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 800 iterations", ylab="RMSE", xlab="Run Number",ylim=c(1,8))
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model', 'response sd'),lty=c(1),col=c('red','black'))
```
covdummy
```{r}
runs <- c(2:5,9:10)
res1 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec4_covdummy_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
}
plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 800 iterations", ylab="RMSE", xlab="Run Number",ylim=c(1,8))
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model', 'response sd'),lty=c(1),col=c('red','black'))
```


##Plot (min) loss of softmax
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-800
runs <- c(1:4,6:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec4_sm_gpnn_bbig_init_loss__jobid_",i,".csv")))[,1:num.it]
 }

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("GenderModel-Male")
                             ,paste0("GenderModel-Female")
                             ,paste0("LatentModel-Dummy-Male"), 'LatentModel-Dummy-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 
```{r}
num.it <-800
runs <- c(1:4,6:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec4_sm_gpnn_bbig_init_loss__jobid_",i,".csv")))[,1:num.it]
 }
res1<- c(apply(res.mat[2,,], 1, FUN = min))
plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 800 iterations", ylab="RMSE", xlab="Run Number",ylim=c(1,8))
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model', 'response sd'),lty=c(1),col=c('red','black'))
```






Currently running
//dec5_sm_gpnn_bbig_init. 39294968 ==> scaled softmax and correcting l.weight saving. 12 hours.
              I think softmax*10 is too harsh. it fails many cases I think from vanishing gradients. the best case `8` also happens when gradients are strongly non-zero, unlike `5`.
              
//dec5_cov_gpnn_bbig_init_bbs. 39317275
//dec5_covdummy_gpnn_bbig_init_bbs. 39317372 
//dec5_covage_gpnn_bbig_init_bbs 39317420

#6 dec 

##dummy
Best cases of dummy vs gender
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-600
runs <- c(1,4:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov9_gender_gpnn_bbig_init_bbs_t_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-c(1,4:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov9_gender_gpnn_bbig_init_bbs_t_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <-1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec5_covdummy_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <-1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec5_covdummy_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("GenderModel-Male")
                             ,paste0("GenderModel-Female")
                             ,paste0("LatentModel-Dummy-Male"), 'LatentModel-Dummy-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(3,8))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 

##Bin Age
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-600
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec5_cov_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec5_cov_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <-1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec5_covdummy_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <-1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec5_covdummy_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("LatentModel-BinAge-Male")
                             ,paste0("LatentModel-BinAge-Female")
                             ,paste0("LatentModel-Dummy-Male"), 'LatentModel-Dummy-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(3,8))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 


##Cov age
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-600
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec5_cov_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec5_cov_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <-c(1,3:10)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec5_covage_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <-c(1,3:10)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec5_covage_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0,0))
hs.test <-quantile(hs.int[,6],c(0,0))

#define legends
leglab <- c(paste0("LatentModel-BinAge-Male")
                             ,paste0("LatentModel-BinAge-Female")
                             ,paste0("LatentModel-MultAge-Male"), 'LatentModel-MultAge-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 

##Min loss of sm
```{r}
runs <- c(5,7,8,10)
res1 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec5_sm_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
}
plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 800 iterations", ylab="RMSE", xlab="Run Number",ylim=c(1,8))
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model', 'response sd'),lty=c(1),col=c('red','black'))
```


Currently running
//dec6_sm_gpnn_bbig_init_bbs  39390924 => no saliency effect for interactions [NOT saved correctly for the coef, also no proper saliency]


#7 dec
##SM
Best cases
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-600
runs <- c(1,3:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec5_covage_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-c(1,3:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec5_covage_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <-c(1:6,8,10)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec6_sm_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <-c(1:6,8,10)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec6_sm_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0,0))
hs.test <-quantile(hs.int[,6],c(0,0))

#define legends
leglab <- c(paste0("LatentModel-MultAge-Male")
                             ,paste0("LatentModel-MultAge-Female")
                             ,paste0("MultLatentModel-MultAge-Male"), 'MultLatentModel-MultAge-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 
Median cases
```{r}

#define legends
leglab <- c(paste0("LatentModel-MultAge-Male")
                             ,paste0("LatentModel-MultAge-Female")
                             ,paste0("MultLatentModel-MultAge-Male"), 'MultLatentModel-MultAge-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 


Currently running
//dec7_sm_gpnn_bbig_init_bbs 39546898 ==> correctly save coef

//dec8_sm_gpnn_bbig_init_bbs 39664492 ==> fixed saliency, can now get intersal1 to 4
//dec9_sm_gpnn_bbig_init_bbs. 39938910 ==> saliency for interactions are based on the last minibatch only.

#11 dec
##Plot loss to pick run num
Best cases
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-600
runs <- c(1,3:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec5_covage_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-c(1,3:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec5_covage_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(9,10)#(3,3)##1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec9_sm_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- c(9,10)#9,10)#1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec9_sm_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0,0))
hs.test <-quantile(hs.int[,6],c(0,0))

#define legends
leglab <- c(paste0("LatentModel-MultAge-Male")
                             ,paste0("LatentModel-MultAge-Female")
                             ,paste0("MultLatentModel-MultAge-Male"), 'MultLatentModel-MultAge-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 
Median cases
```{r}

#define legends
leglab <- c(paste0("LatentModel-MultAge-Male")
                             ,paste0("LatentModel-MultAge-Female")
                             ,paste0("MultLatentModel-MultAge-Male"), 'MultLatentModel-MultAge-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
es.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 

##Find best run
```{r}
num.it <-600
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec9_sm_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }
res1<- c(apply(res.mat[2,,], 1, FUN = min))
plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 600 iterations", ylab="RMSE", xlab="Run Number",ylim=c(1,8))
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model', 'response sd'),lty=c(1),col=c('red','black'))
```

From looking at the individual run's loss and saliency of runs 9 and 10, seems like the best run (9 and 10) suppresses all relu, resulting in empty saliency

##Investigate coeff
### Load in l.weights
main latent coef
```{r}
runs <- c(6,9,10)
res1 <- matrix(,ncol=64,nrow=length(runs))
for (i in runs){ 
  res1[which(i==runs),] <- unlist(read_feather(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec9_sm_gpnn_bbig_init_bbs_lweights__jobid_",i,".feather"))) #lweights is length 64
}

```

runs 9 and 10 have abnormally LARGE coef for main effects of non-imaging input, ie softmax output (scale of 1000s)

```{r}
runs <- c(1:10)
res1 <- matrix(,ncol=2,nrow=length(runs))
res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1[which(i==runs),] <- unlist(c(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov16_cov_gpnn_bbig_init_bbs_coweights__jobid_",i,".csv"))))
  res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov16_cov_gpnn_bbig_init_bbs_cobias__jobid_",i,".csv"))$x)
}
summary(res1)
summary(res2)
```

by looking at 
`read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec9_sm_gpnn_bbig_init_bbs_coweights__jobid_",6,".csv"))`
`read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec9_sm_gpnn_bbig_init_bbs_coweights__jobid_",9,".csv"))`
`read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec9_sm_gpnn_bbig_init_bbs_coweights__jobid_",10,".csv"))`
9 and 10 have much higher magnitudes of co weights. run 6 has a very low magnitude of coweights.... but then it all get normalised tho?
Same thing for cobias. 


I am gonna have to test my hypothesis by timing data by the `weights` and put it through relu.

Observe `hidden.cal`

```{r}
hid9 <- as.matrix(read_feather("/well/nichols/users/qcv214/KGPNN/pile/re_dec11_testhidden_sm_gpnn_bbig_init_bbs_hidden9__jobid_1.feather"))
sum(c(hid9))

hid10 <- as.matrix(read_feather("/well/nichols/users/qcv214/KGPNN/pile/re_dec11_testhidden_sm_gpnn_bbig_init_bbs_hidden10__jobid_1.feather"))
sum(c(hid10))

hid6 <- as.matrix(read_feather("/well/nichols/users/qcv214/KGPNN/pile/re_dec11_testhidden_sm_gpnn_bbig_init_bbs_hidden6__jobid_1.feather"))
sum(c(hid6)) #Only 1 relu is active
```



22189 Townsend deprivation index ===> ukb_latest_Confs.tsv INSTEAD of ukb_latest_age.tsv.
The info of age might need updating though... confs is more update. Need to do some data wrangling. to fix this.
We could also try only using townsend top and bottom 10% to stratify data, to amke predictions, see if it will do anything beneficial.

(head size/volume | centre of gradvity for head?)

***I should keep track of the resulting class of each subject as well


#13 December 

1. Need to cross check if the data is still the same for Age.tsv and `/well/nichols/projects/UKB/SMS/ukb_latest-Confs.tsv`
  1.2 26410:Index of Multiple Deprivation (England)	Indices of Multiple Deprivation  , 26427 Index of Multiple Deprivation (Scotland)	Indices of Multiple Deprivation  
 26426, Index of Multiple Deprivation (Wales)	Indices of Multiple Deprivation  
 
 1.3: I wonder if I should calibrate England, Scot and Wales to be on the same scale e.g. by standardising. Or should I just use the raw values?

  1.4
2. create a null model for non-imaging

##Look at Confs
```{r}
confs.dat<-read.table(file = '/well/nichols/projects/UKB/SMS/ukb_latest-Confs.tsv', sep = '\t', header = TRUE) #46535 53
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat.feather'))

#check intersection of the new deprivation index for each country, check if the sum of non NA is equal to the nrow
nrow(confs.dat) == sum(sum(!is.na(confs.dat$X26410.0.0))+sum(!is.na(confs.dat$X26427.0.0))+sum(!is.na(confs.dat$X26426.0.0)))
#46535 vs 45429 ===> meaning 1000 rows have all NA

#I will create a new combined column that takes the sum and ignore the NA
#length(apply(cbind(confs.dat$X26410.0.0,confs.dat$X26427.0.0,confs.dat$X26426.0.0),1,FUN = sum,na.rm=TRUE))
confs.dat$combDepInd <- apply(cbind(confs.dat$X26410.0.0,confs.dat$X26427.0.0,confs.dat$X26426.0.0),1,FUN = mean,na.rm=TRUE) 
# if we use `sum` instead of `mean` above then it will convert NA to 0. Using `mean` will keep `mean` the same.
#sum(is.na(confs.dat$combDepInd)) = 0 wtf
```

impute 3% of the missing index using mean
I will use MEDIAN since there is no other correlated data to predict this
```{r}
age_tab$DepInd <- vector(mode='numeric',length = nrow(age_tab))
for(i in 1:length(age_tab$id)){
  age_tab$DepInd[i] <- confs.dat$combDepInd[confs.dat$eid_8107==sub(".", "",age_tab$id[i])]
} 
summary(age_tab$DepInd) #NA's = 117 #only 3% is missing 

#Lets impute using means perhaps.
median_value <- median(age_tab$DepInd, na.rm = TRUE)
age_tab$DepInd[is.na(age_tab$DepInd)] <- median_value

#write_feather(age_tab, '/well/nichols/users/qcv214/KGPNN/age_sex_strat_depind.feather')
```

```{r}
boxplot(age_tab$DepInd~ as.factor(age_tab$sex), 
        xlab = "Sex", 
        ylab = "Values", 
        main = "Boxplot of Values by Sex")
```
```{r}
library(ggplot2)
# Assuming dep.vec and sex are defined as before
dep.vec_df <- data.frame(value = age_tab$DepInd, sex = as.factor(age_tab$sex))

# Create the histogram using ggplot
ggplot(dep.vec_df, aes(x = value, fill = sex)) +
  geom_histogram(position = "identity", alpha = 0.5, bins = 10) +
  labs(title = "Histogram of Values by Sex", x = "Values", y = "Frequency") +
  scale_fill_manual(values = c("red", "blue")) +
  theme_minimal()
```
Male and female have similar distributions. 

```{r}
# Assuming dep.vec is your numeric vector
dep.vec <- age_tab$DepInd
# Calculate the quantile thresholds (0%, 10%, 20%, ..., 100%)
quantile_thresholds <- quantile(dep.vec, probs = seq(0, 1, by = 0.1))
# Split dep.vec into quantiles
dep.vec_quantiles <- cut(dep.vec, breaks = quantile_thresholds, include.lowest = TRUE, labels = FALSE)
# Print the quantile group for each value in dep.vec
dep.vec_quantiles
```


Currently running
dec13_sm_intercept_gpnn_bbig_init 40532450 ==> intercept only. only cobias and NOT co.weights
[ran but not saved] dec13_sm_ones_gpnn_bbig_init 40557261 ==> co.dat is just nine 1's.  ===> ran successfully but not saved?? I can't spot why
dec13_sm_depind_gpnn_bbig_init 40557064 => note that the quantiles for deprivation index only make use of the train data.

//dec13_sm_ones_gpnn_bbig_init 40603561 ==> 1 epoch to test saving => everything is fine
dec13_sm_ones_gpnn_bbig_init  40604094 ==> 200 epochs, let's see if it works

I should try saving class assignments in the `bbs` version. Then i can observe stability of class assignment for each subject. => cant do that since classes are unordered

#14 dec 
## sm intercept
```{r}
runs <- c(1:6,8:10)
res1 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec13_sm_intercept_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
}
plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 800 iterations", ylab="RMSE", xlab="Run Number",ylim=c(1,8))
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model', 'response sd'),lty=c(1),col=c('red','black'))
```
This is useless. I swear it just means predicting everyone to be one class


## sm depind
```{r}
runs <- c(2:4,6,9)
res1 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec13_sm_depind_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
}
plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 800 iterations", ylab="RMSE", xlab="Run Number",ylim=c(1,8))
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model', 'response sd'),lty=c(1),col=c('red','black'))
```
This is also not working. Very weird. 
##Let's look at min loss
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-800
runs <-  c(2:4,6,9)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec13_sm_depind_gpnn_bbig_init_loss__jobid_",i,".csv")))[,1:num.it]
 }

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("GenderModel-Male")
                             ,paste0("GenderModel-Female")
                             ,paste0("LatentModel-Dummy-Male"), 'LatentModel-Dummy-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 
It can learn during training but test seems to be stuck. Let's run bbs anyway

//dec14_sm_intercept_gpnn_bbig_init_bbs. 40637582
//dec14_sm_depind_gpnn_bbig_init_bbs. 40638076

#15 dec
##Plot 
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-600
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec14_sm_intercept_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec14_sm_intercept_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 2:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec14_sm_depind_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- 2:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec14_sm_depind_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0,0))
hs.test <-quantile(hs.int[,6],c(0,0))

#define legends
leglab <- c(paste0("LatentModel-MultAge-Male")
                             ,paste0("LatentModel-MultAge-Female")
                             ,paste0("MultLatentModel-MultAge-Male"), 'MultLatentModel-MultAge-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 
Median cases
```{r}

#define legends
leglab <- c(paste0("LatentModel-MultAge-Male")
                             ,paste0("LatentModel-MultAge-Female")
                             ,paste0("MultLatentModel-MultAge-Male"), 'MultLatentModel-MultAge-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
es.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 
It's not working.

###Let's investigate class assignment... i think all got assigned to same class
... lost some work
using summary and table
Intercept assign all to the same classs => not surprising
DepInd assign exactly half to one and half to another
...

I am going to try using normal softmax
Currently running
...
dec15_sm_depind_gpnn_bbig_init. 40764913
dec15_sm_ones_gpnn_bbig_init. 40764966
dec15_sm_intercept_gpnn_bbig_init. 40764976


#dec 16
## sm intercept
```{r}
runs <- c(1,2,6)
res1 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec15_sm_intercept_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
}
plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 800 iterations", ylab="RMSE", xlab="Run Number",ylim=c(1,8))
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model', 'response sd'),lty=c(1),col=c('red','black'))
```
## sm ones
```{r}
runs <- c(2,3,6,7,8)
res1 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec15_sm_ones_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
}
plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 800 iterations", ylab="RMSE", xlab="Run Number",ylim=c(1,8))
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model', 'response sd'),lty=c(1),col=c('red','black'))
```
## sm depind
```{r}
runs <- c(1,3,4,7,8,9)
res1 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec15_sm_depind_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
}
plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 800 iterations", ylab="RMSE", xlab="Run Number",ylim=c(1,8))
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model', 'response sd'),lty=c(1),col=c('red','black'))
```

Why does it not have any effect at all


Currently
dec16_sm_intercept_gpnn_bbig_init_bbs  40934707
dec16_sm_ones_gpnn_bbig_init_bbs.  40934713
dec16_sm_depind_gpnn_bbig_init_bbs. 40934733


#17 dec 

##Plot intercept vs depind
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-600
runs <- c(1,2,4:6,8:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec16_sm_intercept_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-c(1,2,4:6,8:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec16_sm_intercept_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(1,5:10)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec16_sm_depind_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- c(1,5:10)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec16_sm_depind_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0,0))
hs.test <-quantile(hs.int[,6],c(0,0))

#define legends
leglab <- c(paste0("LatentModel-MultAge-Male")
                             ,paste0("LatentModel-MultAge-Female")
                             ,paste0("MultLatentModel-MultAge-Male"), 'MultLatentModel-MultAge-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 
##Plot intercept vs ones
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-600
runs <- c(1,2,4:6,8:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec16_sm_intercept_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-c(1,2,4:6,8:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec16_sm_intercept_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(1:3,7:10)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec16_sm_ones_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- c(1:3,7:10)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec16_sm_ones_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0,0))
hs.test <-quantile(hs.int[,6],c(0,0))

#define legends
leglab <- c(paste0("LatentModel-MultAge-Male")
                             ,paste0("LatentModel-MultAge-Female")
                             ,paste0("MultLatentModel-MultAge-Male"), 'MultLatentModel-MultAge-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 

Observe class assignment
###intercept
```{r}
train.test.ind <- list()
train.test.ind$test <- read.csv('/well/nichols/users/qcv214/KGPNN/sex_test_index.csv')$x
train.test.ind$train <-  read.csv('/well/nichols/users/qcv214/KGPNN/sex_train_index.csv')$x
n.train <- length(train.test.ind$train)

success.run <- c(1,2,4:6,8:10)

for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_dec16_sm_intercept_gpnn_bbig_init_bbs_inpred__jobid_',i,'.feather'))))[,3]
  dat.in <- tail(dat.in,n.train)
  print(paste0('run: ',i))
  print(table(dat.in))
}
```

###ones
```{r}
train.test.ind <- list()
train.test.ind$test <- read.csv('/well/nichols/users/qcv214/KGPNN/sex_test_index.csv')$x
train.test.ind$train <-  read.csv('/well/nichols/users/qcv214/KGPNN/sex_train_index.csv')$x
n.train <- length(train.test.ind$train)

success.run <- c(1:3,7:10)

for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_dec16_sm_ones_gpnn_bbig_init_bbs_inpred__jobid_',i,'.feather'))))[,3]
  dat.in <- tail(dat.in,n.train)
  print(paste0('run: ',i))
  print(table(dat.in))
}
```

Let's look at head
```{r}
train.test.ind <- list()
train.test.ind$test <- read.csv('/well/nichols/users/qcv214/KGPNN/sex_test_index.csv')$x
train.test.ind$train <-  read.csv('/well/nichols/users/qcv214/KGPNN/sex_train_index.csv')$x
n.train <- length(train.test.ind$train)

success.run <- c(1:3,7:10)

for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_dec16_sm_ones_gpnn_bbig_init_bbs_inpred__jobid_',i,'.feather'))))[,3]
  dat.in <- head(dat.in,n.train)
  print(paste0('run: ',i))
  print(table(dat.in))
}
```

###depind
```{r}
success.run <- c(1,5:10)

for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_dec16_sm_depind_gpnn_bbig_init_bbs_inpred__jobid_',i,'.feather'))))[,3]
  dat.in <- tail(dat.in,n.train)
  print(paste0('run: ',i))
  print(table(dat.in))
}
```

Let's look at head
```{r}
success.run <- c(1,5:10)

for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_dec16_sm_depind_gpnn_bbig_init_bbs_inpred__jobid_',i,'.feather'))))[,3]
  dat.in <- head(dat.in,n.train)
  print(paste0('run: ',i))
  print(table(dat.in))
}
```
There is some updating here in depind. Why does it not get better though...

Let's look at the minimum achieved in different runs for `depind`
##Find best run
```{r}
num.it <-600
runs <- c(1,5:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec16_sm_depind_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }
res1<- c(apply(res.mat[2,,], 1, FUN = min))
plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 600 iterations", ylab="RMSE", xlab="Run Number",ylim=c(1,8))
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model', 'response sd'),lty=c(1),col=c('red','black'))
```

It's weird because they have different class assignments but achieve the same RMSE

###Look at the weights?
#### Load in l.weights
main latent coef
```{r}
runs <- c(1,5:10)
res1 <- matrix(,ncol=64,nrow=length(runs))
for (i in runs){ 
  res1[which(i==runs),] <- unlist(read_feather(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec16_sm_depind_gpnn_bbig_init_bbs_lweights__jobid_",i,".feather"))) #lweights is length 64
}
```

There is *nothing* abnormal about the l.weights. The imaging effect of main non-imaging seem to be huge across all runs but that's normal for a class having just 1's


```{r}

read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec16_sm_depind_gpnn_bbig_init_bbs_coweights__jobid_",i,".csv"))
read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec16_sm_depind_gpnn_bbig_init_bbs_cobias__jobid_",i,".csv"))
# runs <- c(1,5:10)
# res1 <- matrix(,ncol=4,nrow=length(runs))
# res2 <- vector(mode = 'numeric')
# for (i in runs){ 
#   res1[which(i==runs),] <- unlist(c(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec16_sm_depind_gpnn_bbig_init_bbs_coweights__jobid_",i,".csv"))))
#   res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec16_sm_depind_gpnn_bbig_init_bbs_cobias__jobid_",i,".csv"))$x)
# }
# summary(res1)
# summary(res2)
```

Nothing seems to be wrong with the co.weights and co.bias. Especially when class assignments are being done.

###Look at class assignment for held-out
```{r}
success.run <- c(1,5:10)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sex_test_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_dec16_sm_depind_gpnn_bbig_init_bbs_outpred__jobid_',i,'.feather'))))[,3]
  dat.in <- tail(dat.in,n.test)
  print(paste0('run: ',i))
  print(table(dat.in))
}
```

Class assignments of held out are similar to train.  Also note that class assignments do not change in the last 5 epochs.


##Plot depind against gender interaction model
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-600
runs <- c(1,4:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov9_gender_gpnn_bbig_init_bbs_t_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-c(1,4:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_nov9_gender_gpnn_bbig_init_bbs_t_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(1,5:10)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec16_sm_depind_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- c(1,5:10)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec16_sm_depind_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("GenderModel-Male")
                             ,paste0("GenderModel-Female")
                             ,paste0("MultiLatent-Male"), 'MultiLatent-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,5.5))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 

Let's look some activated RELU
```{r}
hid9 <- as.matrix(read_feather("/well/nichols/users/qcv214/KGPNN/pile/re_dec18_testhidden_sm_depind_gpnn_bbig_init_bbs_hidden8__jobid_1.feather"))
sum(c(hid9))

hid10 <- as.matrix(read_feather("/well/nichols/users/qcv214/KGPNN/pile/re_dec18_testhidden_sm_depind_gpnn_bbig_init_bbs_hidden1__jobid_1.feather"))
sum(c(hid10))

hid6 <- as.matrix(read_feather("/well/nichols/users/qcv214/KGPNN/pile/re_dec18_testhidden_sm_depind_gpnn_bbig_init_bbs_hidden9__jobid_1.feather"))
sum(c(hid6)) #Only 1 relu is active
```

Everything seems well-behaved.... multiple activated regions unlike before.


Currently running
dec18_sm_depind_2class_gpnn_bbig_init. 41134556 ==> 2 subgroups



#18 dec
##Meeting with Tom
Tom mention using only top and bottom dep index, also uses this as predictors to validate
I should perhaps try ridge or lasso regression on the data, e.g. imaging + sex + categorical.

Plot min
```{r}
runs <- c(1,3,4,5,7,9,10)
res1 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec18_sm_depind_2class_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
}
plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 800 iterations", ylab="RMSE", xlab="Run Number",ylim=c(1,8))
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model', 'response sd'),lty=c(1),col=c('red','black'))
```

[failed when saving - saliency] dec19_sm_depind_2class_gpnn_bbig_init_bbs. 41149238

//dec19_sm_depind_lown_gpnn_bbig_init 41150116 ==> 500 training samples.
//re_dec19_lasso_decind and re_dec19_ridge_decind 41149999

```{r}
#lasso
runs.hs <- 1:10
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec19_lasso_decind_noscale_",i,".csv"))))
}
(hs.train <- quantile(hs.int[,1],c(0.25,0.5,0.75)))
(hs.test <-quantile(hs.int[,3],c(0.25,0.5,0.75)))

(hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75)))
(hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75)))

```

```{r}
#ridge
runs.hs <- 1:10
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec19_ridge_decind_noscale_",i,".csv"))))
}
(hs.train <- quantile(hs.int[,1],c(0.25,0.5,0.75)))
(hs.test <-quantile(hs.int[,3],c(0.25,0.5,0.75)))

(hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75)))
(hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75)))

```

Plot min 500 training
```{r}
runs <- 1:10
res1 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec19_sm_depind_lown_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
}
plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 800 iterations", ylab="RMSE", xlab="Run Number",ylim=c(1,8))
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model', 'response sd'),lty=c(1),col=c('red','black'))
```
Even worse....

//dec19_sm_depind_2class_gpnn_bbig_init_bbs 41174120
//dec19_sm_depind_lown_gpnn_bbig_init_bbs 41174389

#20 dec

##2 classes vs 4 classes
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-600
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec19_sm_depind_2class_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec19_sm_depind_2class_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(1,5:10)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec16_sm_depind_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- c(1,5:10)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec16_sm_depind_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("2LatentModel-Male")
                             ,paste0("2LatentModel-Female")
                             ,paste0("4Latent-Male"), '4Latent-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,5.5))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 
 What if I double...? epochs, 150 epochs only uses 10 hours

Plotting 500 train vs 2k train
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-600
runs <- c(1:2,4:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec19_sm_depind_lown_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1:2,4:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec19_sm_depind_lown_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(1,5:10)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec16_sm_depind_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- c(1,5:10)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec16_sm_depind_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("2LatentModel-Male")
                             ,paste0("2LatentModel-Female")
                             ,paste0("4Latent-Male"), '4Latent-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,5.5))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 
 Doesn't make sense. Reducing training samples to 1/4 increase RMSE during parameter search, but achieve lower RMSE during optimisation. 
 
 
 
 Running
// dec20_sm_depind_2class_gpnn_bbig_init_bbs 41199935 => 300 epochs
// dec20_sm_depind_lown_gpnn_bbig_init_bbs 41223344 => 300 epochs
//  41223793 => 300 epochs

#20 dec
Observe 300 epochs 

500 train vs 2k train
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-1200
runs <- c(5,8,9,10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec20_sm_depind_lown_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(5,8,9,10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec20_sm_depind_lown_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(2,3,9,10)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec20_sm_depind_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <-  c(2,3,9,10)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec20_sm_depind_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("500Model-Male")
                             ,paste0("500Model-Female")
                             ,paste0("2kt-Male"), '2k-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,5.5))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
```
 
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-1200
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec20_sm_depind_2class_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec20_sm_depind_2class_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(2,3,9,10)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec20_sm_depind_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <-  c(2,3,9,10)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec20_sm_depind_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("2LatentModel-Male")
                             ,paste0("2LatentModel-Female")
                             ,paste0("4Latent-Male"), '4Latent-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,5.5))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
```
 
 Double epochs did not help at all.
 
 Currently running
// dec27_sm_depind_gpgp_bbig_init 41561842
 
#28 dec
##Plot min loss of gpgp
```{r}
runs <- c(1:5,7:10)
res1 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec27_sm_depind_gpgp_bbig_init_minloss__jobid_",i,".csv"))$x)
}
plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 800 iterations", ylab="RMSE", xlab="Run Number",ylim=c(1,8))
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model', 'response sd'),lty=c(1),col=c('red','black'))
```

Runnung
//dec28_sm_depind_gpgp_bbig_init_bbs  41576097 => 1000 epochs

##Find best run
```{r}
num.it <-4000
runs <- c(1,5,6,8:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec28_sm_depind_gpgp_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }
res1<- c(apply(res.mat[2,,], 1, FUN = min))
plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 600 iterations", ylab="RMSE", xlab="Run Number",ylim=c(1,8))
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model', 'response sd'),lty=c(1),col=c('red','black'))
```
It's terrible.

```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-4000
runs <- c(1,5,6,8:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec28_sm_depind_gpgp_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1,5,6,8:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec28_sm_depind_gpgp_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

#define legends
leglab <- c(paste0("GPGP-Male")
                             ,paste0("GPGP-Female"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,5.6))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(3.5,5.2))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
```
It's over regularised 


#5 Jan
Lets have a look at lowest and highest dep ind
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat_depind.feather'))
#age_tab <- age_tab[order(age_tab$id),].     #DOES THIS MESS UP ORDER
age <- age_tab$age
sex <-  as.numeric(age_tab$sex)
sex <- sapply(sex, function(x) replace(x, x==0,-1)) #Change female to -1, male to 1

depind <- age_tab$DepInd
quantile_thresholds <- quantile(depind, probs = seq(0, 1, by = 0.1))
dep.group1 <- ifelse(depind >= quantile_thresholds[[1]] & depind <=quantile_thresholds[[2]], yes =1, no = 0)
dep.group2 <- ifelse(depind > quantile_thresholds[[2]] & depind <=quantile_thresholds[[3]], yes =1, no = 0)
dep.group3 <- ifelse(depind > quantile_thresholds[[3]] & depind <=quantile_thresholds[[4]], yes =1, no = 0)
dep.group4 <- ifelse(depind > quantile_thresholds[[4]] & depind <=quantile_thresholds[[5]], yes =1, no = 0)
dep.group5 <- ifelse(depind > quantile_thresholds[[5]] & depind <=quantile_thresholds[[6]], yes =1, no = 0)
dep.group6 <- ifelse(depind > quantile_thresholds[[6]] & depind <=quantile_thresholds[[7]], yes =1, no = 0)
dep.group7 <- ifelse(depind > quantile_thresholds[[7]] & depind <=quantile_thresholds[[8]], yes =1, no = 0)
dep.group8 <- ifelse(depind > quantile_thresholds[[8]] & depind <=quantile_thresholds[[9]], yes =1, no = 0)
dep.group9 <- ifelse(depind > quantile_thresholds[[9]] & depind <=quantile_thresholds[[10]], yes =1, no = 0)
dep.group10 <- ifelse(depind > quantile_thresholds[[10]] & depind <=quantile_thresholds[[11]], yes =1, no = 0)
co.dat <- cbind(sex,dep.group1,dep.group2,dep.group3,dep.group4,dep.group5,dep.group6,dep.group7,dep.group8,dep.group9,dep.group10)
```

```{r}
summary(age[dep.group1==1 | dep.group2==1])
summary(age[dep.group9==1 | dep.group10==1])

summary(age[dep.group1==1])
summary(age[dep.group10==1])

```
```{r}
quantile_thresholds.15 <- quantile(depind, probs = c(0.15,0.85))
dep.group1 <- ifelse(depind <= quantile_thresholds.15[[1]], yes =1, no = 0) #bottom 15
dep.group2 <- ifelse(depind >= quantile_thresholds.15[[2]], yes =1, no = 0) #top 15
```

Deprivation group looks similar, let's split 80% train, 20% test

```{r}
age_tab.filterdep15 <- age_tab[dep.group1==1 | dep.group2==1, ] #n = 1184
write_feather(age_tab.filterdep15, '/well/nichols/users/qcv214/KGPNN/age_sex_strat_depind15.feather')
```
```{r}
plot(density(age_tab.filterdep15$DepInd))
abline(v = median(age_tab.filterdep15$DepInd))
```

```{r}
test.ind <- seq(1,nrow(age_tab.filterdep15),5) #take every 5, so 20%
train.ind <- setdiff(seq(nrow(age_tab.filterdep15)), test.ind)

write.csv(x = train.ind, file = '/well/nichols/users/qcv214/KGPNN/dep15_train_index.csv', row.names = FALSE)
write.csv(x = test.ind , file = '/well/nichols/users/qcv214/KGPNN/dep15_test_index.csv', row.names = FALSE)
```

```{r}
plot(density(age_tab.filterdep15$DepInd[train.ind]))
abline(v = median(age_tab.filterdep15$DepInd))
```
```{r}
plot(density(age_tab.filterdep15$DepInd[test.ind]))
abline(v = median(age_tab.filterdep15$DepInd))
```
```{r}
library(ggplot2)
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat_depind15.feather'))

ggplot(age_tab, aes(x = DepInd)) +
  geom_histogram(binwidth = 0.5, fill = "blue", color = "black") +
  theme_minimal() +
  labs(title = "Histogram of combined Deprivation Index",
       x = "DepInd",
       y = "Count")
```

Check separation:
```{r}
(age_tab.filterdep15$DepInd[c(1184/2,1184/2+1)])
```

Since the separation is so clear, should I use the raw value rather than categorical? TBD

Currently running
jan5_sm_depind15_gpnn_bbig_init 42091035 => top/bot 15 dep ind, 4 subclasses


##Plot min loss
```{r}
runs <-  1:10
res1 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan5_sm_depind15_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
}
plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 800 iterations", ylab="RMSE", xlab="Run Number",ylim=c(1,8))
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model', 'response sd'),lty=c(1),col=c('red','black'))
```
All done in 7.5 hours, perhaps extend it further to 500 again?

jan6_sm_depind15_gpnn_bbig_init 42159761 ==> 500 epochs of searching
jan6_sm_depind15_gpnn_bbig_init_bbs 42159948 => bbs built upon jan5_sm_depind15_gpnn_bbig_init

##Plot min loss
```{r}
runs <-  c(1:4,6,8:10)
res1 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan6_sm_depind15_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
}
plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 800 iterations", ylab="RMSE", xlab="Run Number",ylim=c(1,8))
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model', 'response sd'),lty=c(1),col=c('red','black'))
```

Longer run doesnt help... 20 hours, got training rmse to almost 0



#11 Jan
##Focus on jan6_sm_depind15_gpnn_bbig_init_bbs
### Loss
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-600
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan6_sm_depind15_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan6_sm_depind15_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

#define legends
leglab <- c(paste0("2LatentModel-Male")
                             ,paste0("2LatentModel-Female"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,5.5))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
```
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 600
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan6_sm_depind15_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan6_sm_depind15_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(2,3,9,10)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec20_sm_depind_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <-  c(2,3,9,10)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec20_sm_depind_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("top/bot15%-Male")
                             ,paste0("top/bot15%-Female")
                             ,paste0("original-Male"), 'original-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,5.5))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
```

### Class predictions
Training
```{r}
success.run <- c(1:10)
n.train <- length(read.csv('/well/nichols/users/qcv214/KGPNN/dep15_train_index.csv')$x)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/dep15_test_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_jan6_sm_depind15_gpnn_bbig_init_bbs_inpred__jobid_',i,'.feather'))))[,3]
  dat.in <- tail(dat.in,n.train)
  print(paste0('run: ',i))
  print(table(dat.in))
}
```
Test
```{r}
success.run <- c(1,3,5)
n.train <- length(read.csv('/well/nichols/users/qcv214/KGPNN/dep15_train_index.csv')$x)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/dep15_test_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_jan6_sm_depind15_gpnn_bbig_init_bbs_outpred__jobid_',i,'.feather'))))[,3]
  dat.in <- tail(dat.in,n.test)
  print(paste0('run: ',i))
  print(table(dat.in))
}
```
Proportions look about right across 3 runs.

Let's dissect training of 1st run
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat_depind15.feather'))

success.run <- c(1)
n.train <- length(read.csv('/well/nichols/users/qcv214/KGPNN/dep15_train_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_jan6_sm_depind15_gpnn_bbig_init_bbs_inpred__jobid_',i,'.feather'))))[,c(1,3)]
  dat.in <- tail(dat.in,n.train)
  colnames(dat.in) <- c('id_ind','class')
}

age.in <- age_tab[dat.in$id_ind,c('age','sex','DepInd')]
age.in <- cbind(age.in,as.factor(dat.in$class))
colnames(age.in) <- c('age','sex','DepInd',"class")
```
```{r}
library(ggplot2)
library(tidyr)

# Assuming your dataframe is named age.in
# Reshape the data to long format
age.in_long <- pivot_longer(age.in, cols = c(age, sex, DepInd), names_to = "variable", values_to = "value")

# Create the boxplot
ggplot(age.in_long, aes(x = variable, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ class, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd by Class",
       x = "Variable",
       y = "Value")

```
```{r}
# Assuming your dataframe is named age.in
# Reshape the data to long format
age.in_long <- pivot_longer(age.in, cols = c(age, sex, DepInd), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")

```

So my latent doesn't distinguish gender, but uses just DepInd. Seems like low depInd is associated with longer age (by true values tho)
Let's look at held out

Look at test
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat_depind15.feather'))
success.run <- c(1)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/dep15_test_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_jan6_sm_depind15_gpnn_bbig_init_bbs_outpred__jobid_',i,'.feather'))))[,c(1,3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','class')
}
age.in <- age_tab[dat.in$id_ind,c('age','sex','DepInd')]
age.in <- cbind(age.in,as.factor(dat.in$class))
colnames(age.in) <- c('age','sex','DepInd',"class")

age.in_long <- pivot_longer(age.in, cols = c(age, sex, DepInd), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
```
It does correctly predicts class.

##Let's observe where there are 3 class predictions
train
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat_depind15.feather'))
success.run <- c(5)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/dep15_train_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_jan6_sm_depind15_gpnn_bbig_init_bbs_inpred__jobid_',i,'.feather'))))[,c(1,3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','class')
}
age.in <- age_tab[dat.in$id_ind,c('age','sex','DepInd')]
age.in <- cbind(age.in,as.factor(dat.in$class))
colnames(age.in) <- c('age','sex','DepInd',"class")

age.in_long <- pivot_longer(age.in, cols = c(age, sex, DepInd), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
```
test
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat_depind15.feather'))
success.run <- c(5)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/dep15_test_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_jan6_sm_depind15_gpnn_bbig_init_bbs_outpred__jobid_',i,'.feather'))))[,c(1,3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','class')
}
age.in <- age_tab[dat.in$id_ind,c('age','sex','DepInd')]
age.in <- cbind(age.in,as.factor(dat.in$class))
colnames(age.in) <- c('age','sex','DepInd',"class")

age.in_long <- pivot_longer(age.in, cols = c(age, sex, DepInd), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
```
We can see that training and test is consistent. 
Class 2 is consistently(train & test) male + low DepInd
Class 3 is consistently male + high DepInd
Class 4 is consistently female + all DepInd


##Let's see run 9 
train
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat_depind15.feather'))
success.run <- c(9)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/dep15_train_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_jan6_sm_depind15_gpnn_bbig_init_bbs_inpred__jobid_',i,'.feather'))))[,c(1,3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','class')
}
age.in <- age_tab[dat.in$id_ind,c('age','sex','DepInd')]
age.in <- cbind(age.in,as.factor(dat.in$class))
colnames(age.in) <- c('age','sex','DepInd',"class")

age.in_long <- pivot_longer(age.in, cols = c(age, sex, DepInd), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
```
test
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat_depind15.feather'))
success.run <- c(9)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/dep15_test_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_jan6_sm_depind15_gpnn_bbig_init_bbs_outpred__jobid_',i,'.feather'))))[,c(1,3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','class')
}
age.in <- age_tab[dat.in$id_ind,c('age','sex','DepInd')]
age.in <- cbind(age.in,as.factor(dat.in$class))
colnames(age.in) <- c('age','sex','DepInd',"class")

age.in_long <- pivot_longer(age.in, cols = c(age, sex, DepInd), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
```
Exact same detections in run 5 and 9.

##Let's focus on run 1 and 5. Look at the squared errors associated to each class
###Run 1
train
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat_depind15.feather'))
success.run <-6
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/dep15_train_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_jan6_sm_depind15_gpnn_bbig_init_bbs_inpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('age','sex','DepInd')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$age)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('age','sex','DepInd','pred','SqError',"class")

age.in_long <- pivot_longer(age.in, cols = c(age, sex, DepInd, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
```
test
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat_depind15.feather'))
success.run <- 6
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/dep15_test_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_jan6_sm_depind15_gpnn_bbig_init_bbs_outpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('age','sex','DepInd')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$age)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('age','sex','DepInd','pred','SqError',"class")

age.in_long <- pivot_longer(age.in, cols = c(age, sex, DepInd, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
```
Square error of training is almost 0, but held out is like huge

###Run 5
train
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat_depind15.feather'))
success.run <- c(5)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/dep15_train_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_jan6_sm_depind15_gpnn_bbig_init_bbs_inpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('age','sex','DepInd')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$age)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('age','sex','DepInd','pred','SqError',"class")

age.in_long <- pivot_longer(age.in, cols = c(age, sex, DepInd, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
```
test
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat_depind15.feather'))
success.run <- c(5)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/dep15_test_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_jan6_sm_depind15_gpnn_bbig_init_bbs_outpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('age','sex','DepInd')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$age)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('age','sex','DepInd','pred','SqError',"class")

age.in_long <- pivot_longer(age.in, cols = c(age, sex, DepInd, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
```
Looking at test data, we do see that class 2 can be predicted better than 3 and 4 respectively.


###Some diagnostic
```{r}
success.run <- 8
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat_depind15.feather'))
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/dep15_train_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_jan6_sm_depind15_gpnn_bbig_init_bbs_inpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('age','sex','DepInd')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$age)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('age','sex','DepInd','pred','SqError',"class")

age.in_long <- pivot_longer(age.in, cols = c(age, sex, DepInd, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")

```
```{r}
success.run <- 8
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat_depind15.feather'))
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/dep15_test_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_jan6_sm_depind15_gpnn_bbig_init_bbs_outpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('age','sex','DepInd')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$age)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('age','sex','DepInd','pred','SqError',"class")

age.in_long <- pivot_longer(age.in, cols = c(age, sex, DepInd, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")

```
Looking at the DepInd above, I think judging from distributions of DepInd, class 1 uses higher mixture of high DepInd




2 out of 10 times, model distinguish using sex into 2 latent classes.

#15 Jan
##Want to look at proportion of Male and Female according to DepIn
ggplot(dep.vec_df, aes(x = value, fill
= sex)) +
geom_histogram(position = "identity", alpha = 0.5, binwidth = 0.5) +
geom_vline(data = medians, aes(xintercept = value, color = sex), linetype = "dashed", size = 1) +
scale_color_manual(values = c("black", "black")) + # Adjust colors if needed
labs(title = "Histogram of Values by Sex", x = "Values", y = "Frequency") +
scale_fill_manual(values = c("red", "blue")) +
theme_minimal() +
guides(color = FALSE) # To remove the legend for the median lines

swift

```{r}
library(ggplot2)
# Assuming dep.vec and sex are defined as before
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat_depind15.feather'))
age_tab$sex <- factor(age_tab$sex, levels = c(0, 1), labels = c("Female", "Male"))

dep.vec_df <- data.frame(value = age_tab$DepInd, sex = as.factor(age_tab$sex))
medians <- aggregate(value ~ sex, data = dep.vec_df, FUN = median)

# Create the histogram using ggplot
ggplot(dep.vec_df, aes(x = value, fill = sex)) +
  geom_histogram(position = "identity", alpha = 0.5, binwidth = 0.5) +
  geom_vline(data = medians, aes(xintercept = value, color = sex), linetype = "dashed", size = 1) +
  scale_color_manual(values = c("red", "blue")) +
  labs(title = "Histogram of Values by Sex", x = "Values", y = "Frequency") +
  scale_fill_manual(values = c("red", "blue")) +
  theme_minimal()+
  guides(color = FALSE) 

```
```{r}
summary(dep.vec_df[dep.vec_df$sex==0,1])
```
```{r}
summary(dep.vec_df[dep.vec_df$sex==1,1])
```

#Jan 16
Look at the alpha,beta,gamma and posterior variance saved for the parameters and report it to Tom. Initially started off with 0.5/(11-1) = 0.05 which is really low for variance.
It's the conj gamma

write.csv(conj.invgamma,paste0( '/well/nichols/users/qcv214/KGPNN/pile/re_',filename,'_invgam_',"_jobid_",JobId,".csv"), row.names = FALSE)
```{r}
post.var  <- read.csv('/well/nichols/users/qcv214/KGPNN/pile/re_jan6_sm_depind15_gpnn_bbig_init_bbs_invgam__jobid_1.csv')
#This goes to 1199, at step 1200 it's just NA
#Variance all of scale 3e-06
```

```{r}
post.var  <- read.csv('/well/nichols/users/qcv214/KGPNN/pile/re_jan6_sm_depind15_gpnn_bbig_init_minpriorvar__jobid_1.csv')
#This goes to 1199, at step 1200 it's just NA
#Variance all of scale 6e-06
```

I will run
[failed] jan16_sm_depind15_hivar_gpnn_bbig_init 43074722 => with 300 epochs, variance starting of 4 (as opposed to 0.05) with alpha = 1.5 and beta = 2.
Above all crashed after 2 runs... why

[failed... must be from grad updates that's crashing it]  jan16_sm_depind15_hivar_gpnn_bbig_init 43080250 => with 300 epochs, variance starting of 4 (as opposed to 0.05) with alpha = 6 and beta = 20. f
[failed] jan16_sm_depind15_hivar_gpnn_bbig_init 43081164 => prior var = 1, alpha = 21, beta = 20.

//jan16_sm_depind15_hivar_gpnn_bbig_init 43081436 => prior var = 1, alpha = 21, beta = 10.

ALSO note that y.sigma is 10k ~ 500k


#18 Jan
Look at prior var = 0.5
##Plot min loss of gpnn
```{r}
runs <- c(2:7,9:10)
res1 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan16_sm_depind15_hivar_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
}
plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 800 iterations", ylab="RMSE", xlab="Run Number",ylim=c(1,8))
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model', 'response sd'),lty=c(1),col=c('red','black'))
```
This isn't good.
Look at the posterior var:
```{r}
post.var  <- read.csv('/well/nichols/users/qcv214/KGPNN/pile/re_jan16_sm_depind15_hivar_gpnn_bbig_init_minpriorvar__jobid_2.csv')
#Very interesting, this only converges to 1e-4, as opposed to 1e-6 in the case of 0.06 var
```

Currently running
`jan16_sm_depind18_lovar_gpnn_bbig_init` 43400255 , alpha = 101, and beta = 0.01 ie prior var = 1e-4

low variance seems to be inflating y.sigma. to enormous scale
###Let me cap the y.sigma
Let's see what happen if I cap y.sigma at 100
[failed] `jan18_sm_depind15_lovar_ysigcap_gpnn_bbig_init` 43401348
Capping the positive side of it will make it go to -5000 which crashes. Let me cap it between 0 and 100
`jan18_sm_depind15_lovar_ysigcap_gpnn_bbig_init` 43403555 ==> avoiding negative y.sigma


##To reduce overfitting
I will reduce the number of imaging hidden neurons. Previously hermite poly was 30, corresponding to 5456 params per regions (65k in total) then *4. 
I will change this to poly 10, 286 param per regions. (3432 in total) then *4
`partial_gp_centroids_fixed_100.540.feather`

`jan18_sm_depind_lowhid_gpnn_bbig_init` 43400323


#19 Jan
##Observe low prior var, in the case of top/bot 15
```{r}
runs <- c(1:5,8:10)
res1 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan16_sm_depind18_lovar_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
}
plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 800 iterations", ylab="RMSE", xlab="Run Number",ylim=c(1,8))
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model', 'response sd'),lty=c(1),col=c('red','black'))
```

##Capping y sigma
```{r}
runs <- c(1:10)
res1 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan18_sm_depind15_lovar_ysigcap_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
}
plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 800 iterations", ylab="RMSE", xlab="Run Number",ylim=c(1,8))
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model', 'response sd'),lty=c(1),col=c('red','black'))
```
A little worse than limiting variance

##Lowering hidden expansion in full model
```{r}
runs <- c(2,4:10)
runs2 <-c(1,3,4,7,8,9)
res1 <- vector(mode = 'numeric')
res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan18_sm_depind_lowhid_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
  }
for (i in runs2){ 
  res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec15_sm_depind_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
}
plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 800 iterations", ylab="RMSE", xlab="Run Number",ylim=c(1,8))
lines(x = runs2,y=sqrt(res2),col='blue',lwd=2, type = 'b')
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model', 'response sd'),lty=c(1),col=c('red','black'))
```

Min test RMSE doesn't change at all!!! even though the number of hidden neurons have decreased many folds

Let's look at training rmse
###Training rmse
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-800
runs <-  c(2,4:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan18_sm_depind_lowhid_gpnn_bbig_init_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-  c(2,4:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan18_sm_depind_lowhid_gpnn_bbig_init_lossF__jobid_",i,".csv")))[,1:num.it]
}

#define legends
leglab <- c(paste0("LowHidden-Male")
                             ,paste0("LowHidden-Female"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,5.5))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
```
Low hiddden is almost 0 but not 0 yet.
Though when looking at median score, training RMSE is around 2, so perhaps there's room for it to improve.

###Compare it to original model
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-800
runs <- c(1,3,4,7,8,9)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec15_sm_depind_gpnn_bbig_init_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-c(1,3,4,7,8,9)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec15_sm_depind_gpnn_bbig_init_lossF__jobid_",i,".csv")))[,1:num.it]
}

#define legends
leglab <- c(paste0("NormalHidden-Male")
                             ,paste0("NormalHidden-Female"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,5.5))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
```

In fact may be I will reduce the low hidden even further
I will just do 3, corresponds to 240 main effects (20 each).

`jan19_sm_depind_lowhid_gpnn_bbig_init`. 43582980 ===> expansion of 3 degrees.

Will need to try out continuous deprivation at some point

#20 Jan
##Min loss
```{r}
runs <- c(1:6,8:10)
runs2 <-c(1,3,4,7,8,9)
res1 <- vector(mode = 'numeric')
res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan19_sm_depind_lowhid_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
  }
for (i in runs2){ 
  res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec15_sm_depind_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
}
plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 800 iterations", ylab="RMSE", xlab="Run Number",ylim=c(1,8))
lines(x = runs2,y=sqrt(res2),col='blue',lwd=2, type = 'b')
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model', 'response sd'),lty=c(1),col=c('red','black'))
```
Why is it not working. 

```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-800
runs <- c(1:6,8:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan19_sm_depind_lowhid_gpnn_bbig_init_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-  c(1:6,8:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan19_sm_depind_lowhid_gpnn_bbig_init_lossF__jobid_",i,".csv")))[,1:num.it]
}

#define legends
leglab <- c(paste0("LowHidden-Male")
                             ,paste0("LowHidden-Female"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,5.5))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
```


I am gonna reduce it even further, change to 1 dimension `partial_gp_centroids_fixed_10.540.feather`

Currently running 
jan20_sm_depind_lowhid_gpnn_bbig_init   43872045
#21 Jan
##Min loss
```{r}
runs <- 1:10
runs2 <-c(1,3,4,7,8,9)
res1 <- vector(mode = 'numeric')
res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan20_sm_depind_lowhid_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
  }
for (i in runs2){ 
  res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec15_sm_depind_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
}
plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 800 iterations", ylab="RMSE", xlab="Run Number",ylim=c(1,8))
lines(x = runs2,y=sqrt(res2),col='blue',lwd=2, type = 'b')
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model', 'response sd'),lty=c(1),col=c('red','black'))
```
#Absolutely no imrpovement. it's bottlenecked. 
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-800
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan20_sm_depind_lowhid_gpnn_bbig_init_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-  c(2,4:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan20_sm_depind_lowhid_gpnn_bbig_init_lossF__jobid_",i,".csv")))[,1:num.it]
}

#define legends
leglab <- c(paste0("LowHidden-Male")
                             ,paste0("LowHidden-Female"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,5.5))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
```


#22 jan
I need to do diagnostic for the classes
###Run 5
train
```{r}
library(ggplot2)
library(tidyr)
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat_depind15.feather'))
success.run <- c(5)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/dep15_train_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_jan6_sm_depind15_gpnn_bbig_init_bbs_inpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('age','sex','DepInd')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$age)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('age','sex','DepInd','pred','SqError',"class")

age.in_long <- pivot_longer(age.in, cols = c(age, sex, DepInd, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
```
test
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat_depind15.feather'))
success.run <- c(5)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/dep15_test_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_jan6_sm_depind15_gpnn_bbig_init_bbs_outpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('age','sex','DepInd')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$age)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('age','sex','DepInd','pred','SqError',"class")

age.in_long <- pivot_longer(age.in, cols = c(age, sex, DepInd, pred, SqError), names_to = "variable", values_to = "value") #this is (237x5) x3

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
```
For test
```{r}
#Look at held out variance
var(age.in$age)
#Look at held out variance by class
var(age.in$age[age.in$class==2]) #Class 2
var(age.in$age[age.in$class==3]) #Class 3
var(age.in$age[age.in$class==4]) #Class 4

```
```{r}
#Look at held out variance
var(age.in$pred)
#Look at held out variance by class
var(age.in$pred[age.in$class==2]) #Class 2
var(age.in$pred[age.in$class==3]) #Class 3
var(age.in$pred[age.in$class==4]) #Class 4

```
##Look at histogram
```{r}
hist(age.in$SqError, breaks = seq(from=0, to=210, by=10))
hist(age.in$SqError[age.in$class==2], breaks = seq(from=0, to=210, by=10), ylim = c(0,50))
hist(age.in$SqError[age.in$class==3], breaks = seq(from=0, to=210, by=10), ylim = c(0,50))
hist(age.in$SqError[age.in$class==4], breaks = seq(from=0, to=210, by=10), ylim = c(0,50))
```
```{r}
hist(sqrt(age.in$SqError), breaks = seq(from=0, to=15, by=1))
hist(sqrt(age.in$SqError[age.in$class==2]), breaks = seq(from=0, to=15, by=1), ylim = c(0,50))
hist(sqrt(age.in$SqError[age.in$class==3]), breaks = seq(from=0, to=15, by=1), ylim = c(0,50))
hist(sqrt(age.in$SqError[age.in$class==4]), breaks = seq(from=0, to=15, by=1), ylim = c(0,50))
```

Now for these guys in class 2 and 3 that have squared error higher than 100, let's look at their true age
```{r}
summary(age.in[age.in$SqError > 100 & age.in$class == 2,]) #class 2
summary(age.in[age.in$SqError > 100 & age.in$class == 3,]) #class 3
```


Look at the errors without anomalies ==> but then this is just sugar-coating our results... Look at median squared error instead of RMSE
Look at root median squared error

```{r}
#Look at held out variance
mean((age.in$age-age.in$pred)^2)
#Look at held out variance by class
mean((age.in$age[age.in$class==2]-age.in$pred[age.in$class==2])^2) #Class 2
mean((age.in$age[age.in$class==3]-age.in$pred[age.in$class==3])^2) #Class 3
mean((age.in$age[age.in$class==4]-age.in$pred[age.in$class==4])^2) #Class 4
```
```{r}
#Look at held out variance
mean((age.in$age-age.in$pred)^2)
#Look at held out variance by class
mean((age.in$age[age.in$SqError < 100 &age.in$class==2]-age.in$pred[age.in$SqError < 100 &age.in$class==2])^2) #Class 2
mean((age.in$age[age.in$SqError < 100 &age.in$class==3]-age.in$pred[age.in$SqError < 100 &age.in$class==3])^2) #Class 3
mean((age.in$age[age.in$SqError < 100 &age.in$class==4]-age.in$pred[age.in$SqError < 100 &age.in$class==4])^2) #Class 4

```

```{r}
#Look at held out variance
median((age.in$age-age.in$pred)^2)
#Look at held out variance by class
median((age.in$age[age.in$class==2]-age.in$pred[age.in$class==2])^2) #Class 2
median((age.in$age[age.in$class==3]-age.in$pred[age.in$class==3])^2) #Class 3
median((age.in$age[age.in$class==4]-age.in$pred[age.in$class==4])^2) #Class 4

```

##Compare RMSE of the low prior var vs high prior var
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-800
runs <- c(1:5,8:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan16_sm_depind18_lovar_gpnn_bbig_init_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-  c(2:7,9:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan16_sm_depind15_hivar_gpnn_bbig_init_loss__jobid_",i,".csv")))[,1:num.it]
}

#define legends
leglab <- c(paste0("Low prior variance")
                             ,paste0("High prior variance"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.5,6.5))
lines(x = 1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=1, type = 'l')
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x = 1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=1, type = 'l')

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,6.5))
lines(x = 1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=1, type = 'l')
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x = 1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=1, type = 'l')
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'navy','lightblue','magenta','black'))
```

##Compare RMSE of the low hidden neurons vs original
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-800
runs <- c(1,3,4,7,8,9)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec15_sm_depind_gpnn_bbig_init_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan20_sm_depind_lowhid_gpnn_bbig_init_loss__jobid_",i,".csv")))[,1:num.it]
}

#define legends
leglab <- c(paste0("Original (327,364 hiddens)")
                             ,paste0("Few neurons (244 hiddens)"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.5,6.5))
lines(x = 1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=1, type = 'l')
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x = 1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=1, type = 'l')

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,6.5))
lines(x = 1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=1, type = 'l')
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x = 1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=1, type = 'l')
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'navy','lightblue','magenta','black'))
```



Running 
//jan26_sm_depind_lowhid_gpnn_bbig_init_bbs 44439983 16 hours
//jan26_sm_depind15_hivar_gpnn_bbig_init_bbs 44452721
//jan26_sm_depind15_lovar_gpnn_bbig_init_bbs  44458579


##Compare RMSE of the low hidden neurons vs original
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-1200
runs <- c(2,3,9,10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec20_sm_depind_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan26_sm_depind_lowhid_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
}

#define legends
leglab <- c(paste0("Original (327,364 hiddens)")
                             ,paste0("Few neurons (244 hiddens)"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.5,5))
lines(x = 1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=1, type = 'l')
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x = 1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=1, type = 'l')

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,2))
lines(x = 1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=1, type = 'l')
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x = 1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=1, type = 'l')
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'navy','lightblue','magenta','black'))
```


##Compare RMSE of the low prior var vs high prior var
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-1200
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan26_sm_depind15_lovar_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-  1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan26_sm_depind15_hivar_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
}

#define legends
leglab <- c(paste0("Low prior variance")
                             ,paste0("High prior variance"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.5,6.5))
lines(x = 1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=1, type = 'l')
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x = 1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=1, type = 'l')

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,6.5))
lines(x = 1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=1, type = 'l')
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x = 1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=1, type = 'l')
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'navy','lightblue','magenta','black'))
```

#Compare with not having gender or deprivation
//jan27_lowhid_gpnn_bbig_init 44811430

```{r}
runs <- 1:10
runs2 <- 1:10
res1 <- vector(mode = 'numeric')
res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan20_sm_depind_lowhid_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
  }
for (i in runs2){ 
  res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan27_lowhid_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
}
plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 800 iterations", ylab="RMSE", xlab="Run Number",ylim=c(4,5))
lines(x = runs2,y=sqrt(res2),col='blue',lwd=2, type = 'b')
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model', 'response sd'),lty=c(1),col=c('red','black'))
```


jan28_lowhid_gpnn_bbig_init_bbs 44846404

#29 Jan
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-1200
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan28_lowhid_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan26_sm_depind_lowhid_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:10
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec19_ridge_decind_noscale_",i,".csv"))))
}

#define legends
leglab <- c(paste0("Imaging-only (48 hiddens)")
                             ,paste0("Imaging+NonImaging (244 hiddens)"),'Ridge')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.5,5))
lines(x = 1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=1, type = 'l')
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x = 1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=1, type = 'l')
abline(h = mean(hs.int[,6]), col = 'magenta')

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'navy','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,2))
lines(x = 1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=1, type = 'l')
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x = 1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=1, type = 'l')
abline(h = mean(hs.int[,5]), col = 'magenta')

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'navy','magenta','black'))
```


##For the depind15 model
Jian asks to refit the model without anomalies, but then the anomalies don't matter in model fitting since it's in held-out.


#30 Jan

We will integrate default mode network into predicting Age

##Look at the current participant list with Default Mode
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat.feather'))

age_tab$dmn <- file.exists(paste0('/well/win-biobank/projects/imaging/data/data3/subjectsAll/',age_tab$id,'/fMRI/rfMRI_25.dr/dr_stage2.nii.gz')) #3444 subjects, 87%

age_tab_dmn <- age_tab[age_tab$dmn == TRUE, ]
#write_feather(age_tab_dmn, '/well/nichols/users/qcv214/KGPNN/age_dmn_sex_strat.feather')

```

```{r}
write.csv(x = seq(1,nrow(age_tab_dmn),2), file = '/well/nichols/users/qcv214/KGPNN/dmn_sex_train_index.csv', row.names = FALSE)
write.csv(x = seq(2,nrow(age_tab_dmn),2), file = '/well/nichols/users/qcv214/KGPNN/dmn_sex_test_index.csv', row.names = FALSE)
```

##IMPORTANT NOTES
I will use the same mask `'/well/nichols/users/qcv214/bnn2/res3/res3mask.nii.gz'` and same middle layer GP approx for both `structural` and `default mode` data. This can of course be changed.



Running
//jan31_bimodal_gpnn_bbig_init. 45370428 => 1 deg exp
//feb1_bimodal_gpnn_bbig_init 45401941 => 10 deg exp (1,5,6,9)


#1 feb
##Results of models with and without imaging covariates
`jan28_lowhid_gpnn_bbig_init_bbs`
####Find best run
```{r}
num.it <-1200
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan28_lowhid_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }
res1<- c(apply(res.mat[2,,], 1, FUN = min))
plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 1200 iterations", ylab="RMSE", xlab="Run Number",ylim=c(4.52,4.7))
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model', 'response sd'),lty=c(1),col=c('red','black'))
```

`jan26_sm_depind_lowhid_gpnn_bbig_init_bbs`
### Class predictions

First, find decent runs
####Find best run
```{r}
num.it <-1200
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan26_sm_depind_lowhid_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }
res1<- c(apply(res.mat[2,,], 1, FUN = min))
plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 1200 iterations", ylab="RMSE", xlab="Run Number",ylim=c(4.52,4.6))
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model', 'response sd'),lty=c(1),col=c('red','black'))
```
runs 3,8,9,10 are the ones with 3 class assignments but their performances arent the best.

```{r}
num.it<-1200
runs <- c(1:10)
runs2 <- 1:10
res1 <- vector(mode = 'numeric')
res2 <- vector(mode = 'numeric')
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan28_lowhid_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }
res1<- c(apply(res.mat[2,,], 1, FUN = min))
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan26_sm_depind_lowhid_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }
res2<- c(apply(res.mat2[2,,], 1, FUN = min))
plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 800 iterations", ylab="RMSE", xlab="Run Number",ylim=c(4.52,4.9))
lines(x = runs2,y=sqrt(res2),col='blue',lwd=2, type = 'b')
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Imaging','All', 'response sd'),lty=c(1),col=c('red','blue','black'))
```

Training
```{r}
success.run <- c(1:10)
n.train <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sex_train_index.csv')$x)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sex_test_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_jan26_sm_depind_lowhid_gpnn_bbig_init_bbs_inpred__jobid_',i,'.feather'))))[,3]
  dat.in <- tail(dat.in,n.train)
  print(paste0('run: ',i))
  print(table(dat.in))
}
```
test
```{r}
library(ggplot2)
library(tidyr)
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat_depind.feather'))
success.run <- c(7)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sex_test_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_jan26_sm_depind_lowhid_gpnn_bbig_init_bbs_outpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('age','sex','DepInd')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$age)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('age','sex','DepInd','pred','SqError',"class")
age.in_long <- pivot_longer(age.in, cols = c(age, sex, DepInd, pred, SqError), names_to = "variable", values_to = "value") #this is (237x5) x3
# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")

```


###We can compare the male-female split without doing any further exploration

####1 run
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 1200
runs <- 1
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan28_lowhid_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan28_lowhid_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan26_sm_depind_lowhid_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <-  1
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan26_sm_depind_lowhid_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Imaging-Male")
                             ,paste0("Imaging-Female")
                             ,paste0("All-Male"), 'All-Female')

#Test
res.iqr <- res.mat[2,,]
plot(x=1:num.it,y=sqrt(res.iqr),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.44,5))
res.iqr2 <- res.mat2[2,,]
lines(x = 1:num.it,y=sqrt(res.iqr2),col='pink',lwd=1, type = 'l')

res.iqr3 <-res.mat3[2,,]
lines(x = 1:num.it,y=sqrt(res.iqr3),col='navy',lwd=1, type = 'l')
res.iqr4 <-res.mat4[2,,]
lines(x = 1:num.it,y=sqrt(res.iqr4),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- res.mat[1,,]
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,0.1))
res.iqr2 <- res.mat2[1,,]
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- res.mat3[1,,]
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- res.mat4[1,,]
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
```

```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 1200
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan28_lowhid_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan28_lowhid_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan26_sm_depind_lowhid_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <-  1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan26_sm_depind_lowhid_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Imaging-Male")
                             ,paste0("Imaging-Female")
                             ,paste0("All-Male"), 'All-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.44,4.5))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,0.1))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
```
Something not adding up. The lowest shouldn't be that low. Oh actually nvm, it's low because it's female i think.

```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 1200
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan28_lowhid_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan28_lowhid_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan26_sm_depind_lowhid_gpnn_bbig_init_bbs_lossM__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <-  1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan26_sm_depind_lowhid_gpnn_bbig_init_bbs_lossF__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Imaging-Male")
                             ,paste0("Imaging-Female")
                             ,paste0("All-Male"), 'All-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.62,4.7))
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=1, type = 'l')

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=1, type = 'l')
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,0.1))
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='pink',lwd=2, type = 'l')

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='navy',lwd=2, type = 'l')
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='lightblue',lwd=2, type = 'l')
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
```




##Look at bimodal
```{r}
runs <- c(1:10)
runs2 <- c(1,5,6,9)
res1 <- vector(mode = 'numeric')
res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan31_bimodal_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
  }
for (i in runs2){
  res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_feb1_bimodal_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
}
plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 800 iterations", ylab="RMSE", xlab="Run Number",ylim=c(4.4,5.2))
lines(x = runs2,y=sqrt(res2),col='blue',lwd=2, type = 'b')
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('1-deg','10-deg', 'response sd'),lty=c(1),col=c('red','blue','black'))
```
Increasing number of expansion doesn't achieve lower RMSE but more stable?


Running 
// feb1_bimodal_gpnn_bbig_init_bbs 45733730 ==>  on top of 1 deg exp

Also I need to do a model with just DMN

###Get response sd

```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_dmn_sex_strat.feather'))
#age_tab <- age_tab[order(age_tab$id),].     #DOES THIS MESS UP ORDER
age <- age_tab$age

train.test.ind <- list()
train.test.ind$test <- read.csv('/well/nichols/users/qcv214/KGPNN/dmn_sex_test_index.csv')$x
train.test.ind$train <-  read.csv('/well/nichols/users/qcv214/KGPNN/dmn_sex_train_index.csv')$x
n.train <- length(train.test.ind$train)

print(sd(age[train.test.ind$test]))
print(sd(age[train.test.ind$train]))

```

//feb1_dmn_lowhid_gpnn_bbig_init  45597201  => DMN: 1 deg exp
```{r}
runs.hs <- 1:10
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_feb5_dmn_ridge_noscale_",i,".csv"))))
}
hs.test <-quantile(hs.int[,6],c(0.5))

runs <- c(1:10)
res1 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_feb1_dmn_lowhid_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
  }
plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 800 iterations", ylab="RMSE", xlab="Run Number",ylim=c(5.5,8))
abline(h=hs.test, lwd = 2,col='magenta')
abline(h=7.5, lwd = 2)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model','ridge','response sd'),lty=c(1),col=c('red','magenta','black'))
```
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-800
runs <-  1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_feb1_dmn_lowhid_gpnn_bbig_init_loss__jobid_",i,".csv")))[,1:num.it]
 }

runs.hs <- 1:5
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_test_may7_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("GenderModel-Male")
                             ,paste0("GenderModel-Female")
                             ,paste0("LatentModel-Dummy-Male"), 'LatentModel-Dummy-Female')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
abline(h=hs.train[2], col='magenta',lwd=2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'pink','navy','lightblue','magenta','black'))
``` 
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-800
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_feb1_bimodal_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan28_lowhid_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
}

#define legends
leglab <- c(paste0("T1+DMN")
                             ,paste0("T1"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.5,5))
lines(x = 1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=1, type = 'l')
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x = 1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=1, type = 'l')

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'navy','lightblue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,2))
lines(x = 1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=1, type = 'l')
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x = 1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=1, type = 'l')
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'navy','lightblue','magenta','black'))
```


#2 feb
I need to wait for bbs results to run and investigate whether the DMN actually contributes to the network at all or does it get pushed to 0.

#4 feb

## bbs
Look at
`feb1_bimodal_gpnn_bbig_init_bbs` 
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-800
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_feb1_bimodal_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan28_lowhid_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:10
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_feb5_bimodal_ridge_noscale_",i,".csv"))))
}
hs.train <-quantile(hs.int[,5],c(0.5))
hs.test <-quantile(hs.int[,6],c(0.5))


#define legends
leglab <- c(paste0("T1+DMN")
                             ,paste0("T1"), "ridge_T1+DMN","response sd")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.5,6.2))
lines(x = 1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=1, type = 'l')
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x = 1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=1, type = 'l')
abline(h=hs.test, lwd = 2,col='magenta')
abline(h=7.5, lwd = 2)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'navy','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,2))
lines(x = 1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=1, type = 'l')
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x = 1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=1, type = 'l')
abline(h=hs.train, lwd = 2,col='magenta')
abline(h=7.5, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   


legend('topright',legend = leglab,lty=c(1),col=c("red",'navy','magenta','black'))
```


#5 feb
Running ridge with DMN data
`feb5_dmn_ridge` and `lasso` using `dmn_ridge_lasso.R` 46223479
```{r}
#lasso
runs.hs <- 1:10
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_feb5_dmn_lasso_noscale_",i,".csv"))))
}
(hs.train <- quantile(hs.int[,1],c(0.25,0.5,0.75)))
(hs.test <-quantile(hs.int[,3],c(0.25,0.5,0.75)))

(hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75)))
(hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75)))

```

```{r}
#ridge
runs.hs <- 1:10
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_feb5_dmn_ridge_noscale_",i,".csv"))))
}
(hs.train <- quantile(hs.int[,1],c(0.25,0.5,0.75)))
(hs.test <-quantile(hs.int[,3],c(0.25,0.5,0.75)))

(hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75)))
(hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75)))

```
Also `bimodal_ridge_lasso` for `feb5` 46224013
```{r}
#lasso
runs.hs <- 1:10
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_feb5_bimodal_lasso_noscale_",i,".csv"))))
}
(hs.train <- quantile(hs.int[,1],c(0.25,0.5,0.75)))
(hs.test <-quantile(hs.int[,3],c(0.25,0.5,0.75)))

(hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75)))
(hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75)))

```

```{r}
#ridge
runs.hs <- 1:10
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_feb5_bimodal_ridge_noscale_",i,".csv"))))
}
(hs.train <- quantile(hs.int[,1],c(0.25,0.5,0.75)))
(hs.test <-quantile(hs.int[,3],c(0.25,0.5,0.75)))

(hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75)))
(hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75)))

```


Visualising Ridge and LASSO
`feb5_dmn_lasso_` and `feb5_dmn_ridge_` 46758246
`feb5_bimodal_t1_ridge_`, `feb5_bimodal_dmn_ridge_`, `feb5_bimodal_t1_lasso_`, `feb5_bimodal_dmn_lasso_` 46758475

#9 Feb
In the attempt of using R torch on local (not able to do it on clluster yet), I will grab a representative sample of size 200 (100 train, 100 test) using `to_local_200.R` and save it to directory called `tolocal`.


#18 Feb
//feb18_200_gpnn_bbig_init 47797995 => to compare to tolocal .... this takes 3 hours?? I think it's because of minibatches... yes since minibatch means doing it 4x times.
//feb18_200_gpnn_bbig_init_bbs 47811680 => I forgot to turn it into minibatch... basically train all data at once.... about 1.5 hours but then it converged early on
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-300
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_feb18_200_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }


#define legends
leglab <- c(paste0("T1+DMN")
                             ,paste0("T1"), "ridge_T1+DMN","response sd")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0.8,.9))
lines(x = 1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=1, type = 'l')
abline(h=0.855, lwd = 2)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'navy','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,0.5))
lines(x = 1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=1, type = 'l')
abline(h=0.855, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   


legend('topright',legend = leglab,lty=c(1),col=c("red",'navy','magenta','black'))
```
This is actually the same as torch, but keep in mind that this is the squareroot of loss.

torch takes about 10 minutes, with 11k iterations of full gradient descent coverge with training RMSE of 0.858, test rmse of 0.848)
My method takes about 3 hours, 500 iterations of full gradient descent. But test rmse converges a lot early on, and training hasn't fully converged. Could say that my method takes significantly less number of iterations compared to torch.

#22 feb

testing rcpp deployment 
feb22_200_rcpp_gpnn_bbig_init  48145987. ===> this is faster than original
feb22_lowhid_rcpp_gpnn_bbig_init. 48149178 ===> this is slower than original

lowhid_rcpp_gpnn_bbig_init_test.R 48166073 ==> look at the log file. Test for slowness ===> 12 minutes per epoch.

Re-impleted Armadillo apart from taking the mean part... .
lowhid_rcpp_gpnn_bbig_init_test.R 48446127 ===> this changes from the vanilla Rcpp from 12 mins per epochs to 3-4 mins. Computing grad weights and grad means cost 30 seconds each.... but why. Why is it slower than for loop in R? The for loop is actually looping over the same thing, n.mask.... *There is another for loop inside, will investigate*
  Need to compare above to jan27_lowhid_gpnn_bbig_init 44811430 ===> this takes sub 3 mins per epochs wtf. 



test_feb25_lowhid_rcpp_gpnn_bbig_init 48704369 ===> optimise grad calculations (wrong dimension, (n x p x m) instead of (n x m x p) ) and changing grad mean.

test_feb26_lowhid_rcpp_gpnn_bbig_init 48741781 ===> optimise grad mean. => 1 min per epochs, 11 seconds for grad cal and <1 sec for grad mean. I think what's holding back is Jian's MCMC function in fast_normal_lm



#26 feb
##Look at result of feb22_200_rcpp_gpnn_bbig_init
```{r}
runs <- c(1:10)
runs2 <- 1:10
res1 <- vector(mode = 'numeric')
res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_feb18_200_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
  }
for (i in runs2){
  res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_feb22_200_rcpp_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
}
plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 800 iterations", ylab="RMSE", xlab="Run Number",ylim=c(0.78,0.87))
lines(x = runs2,y=sqrt(res2),col='blue',lwd=2, type = 'b')
abline(h=0.855, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('original 200','rcpp 200', 'response sd'),lty=c(1),col=c('red','blue','black'))
```

They look about the same


//feb26_200_rcpp_gpnn_bbig_init_bbs 48751537 => test rcpp bbs upon normal 200 
//test_feb26_lowhid_rcpp_gpnn_bbig_init 48743171 => observe jian's fitting and prediction functions


## 2 things to do
1.Scale up gp approx

2. implement bimodal with rcpp
feb26_bimodal_rcpp_gpnn_bbig_init_bbs 48836950 => 2.1 min/epoch vs 5.6 min/epch previously (feb1_bimodal_gpnn_bbig_init_bbs 45733730) (so under 200 epochs, its 7.2 hours 17.7)


//feb29_bimodal_rcpp_gpnn_bbig_init ==> bimodal with 400 epochs of searching. Note that gp expansion deg is 10 [c(2,3,5:10)]

#Plot min loss of rcpp with 400 search vs original with 200 search
```{r}
runs <- c(2,3,5:10)
runs2 <- c(1,5,6,9)
res1 <- vector(mode = 'numeric')
res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_jan31_bimodal_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
  }
for (i in runs2){
  res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_feb1_bimodal_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
}
plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 800 iterations", ylab="RMSE", xlab="Run Number",ylim=c(4.4,5.2))
lines(x = runs2,y=sqrt(res2),col='blue',lwd=2, type = 'b')
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('400 epochs','200 epochs', 'response sd'),lty=c(1),col=c('red','blue','black'))
```

mar1_bimodal_rcpp_gpnn_bbig_init_bbs  49343563







#5 March

##Bimodal
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-500*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_mar1_bimodal_rcpp_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }


#define legends
leglab <- c(paste0("T1+DMN")
                             ,paste0("T1"), "ridge_T1+DMN","response sd")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,6))
lines(x = 1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=1, type = 'l')
abline(h=0.855, lwd = 2)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'navy','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,0.5))
lines(x = 1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=1, type = 'l')
abline(h=0.855, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   


legend('topright',legend = leglab,lty=c(1),col=c("red",'navy','magenta','black'))
```

```{r}
library(ggplot2)
library(tidyr)

# Assuming resdat is your dataframe
# Add a row identifier
resdat <- as.data.frame(sqrt(res.mat[2,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 200)) +
  ylim(4.57,4.8) +
  theme_minimal() +
  labs(title = "Test RMSE", x = "Column", y = "Value", color = "Row ID")

```

```{r}
resdat <- as.data.frame(sqrt(res.mat[1,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 200)) +
  ylim(0,0.1) +
  theme_minimal() +
  labs(title = "Test RMSE", x = "Column", y = "Value", color = "Row ID")

```

test_mar5_lowhid_rcpp_gpnn_bbig_init 49979127 ===> optimise functions further with Jian's advice.



#14 March

We want to move back to simulation to see if my model actually work, especially with subgroup idenfication.
Similar to my first simulation with GPNN, I can take a trained model as my "true" simulated model, this way, I should have the true values for the parameters and the predictions.
I will take a result where the trained model predict 3-4 classes with deprivation index. *IT IS NOT STRONG* tho, will later need a stronger effect
Also *note that I don't have rcpp version for SoftMax*

##Simulation
I will use 
`/well/nichols/users/qcv214/KGPNN/age_sex_strat_depind15.feather` ==>1184 x 4
`/well/nichols/users/qcv214/KGPNN/dep15_train_index.csv`
`/well/nichols/users/qcv214/KGPNN/dep15_test_index.csv`
Run 5 `/well/nichols/users/qcv214/KGPNN/pile/re_jan6_sm_depind15_gpnn_bbig_init_bbs_inpred__jobid_5.feather` as true
Config is 4 classes, 30 deg expansion.


```{r}
success.run <- c(5)
n.train <- length(read.csv('/well/nichols/users/qcv214/KGPNN/dep15_train_index.csv')$x)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/dep15_test_index.csv')$x)

for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_jan6_sm_depind15_gpnn_bbig_init_bbs_inpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.train)
  colnames(dat.in) <- c('id_ind','pred','class')
  
  dat.out <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_jan6_sm_depind15_gpnn_bbig_init_bbs_outpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.out <- tail(dat.out,n.test)
  colnames(dat.out) <- c('id_ind','pred','class')
}
```

By comparing `head(dat.in[order(dat.in$id_ind),])` and `dat.out`, it seems that held-out predictions are extremely conservative... always overpredict young and underpredict old. But overpredicting young is a lot more severe.

So to create a combined dataset, I can do 
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat_depind15.feather'))

combined.pred <- rbind(dat.in,dat.out)
combined.pred <- combined.pred[order(combined.pred$id_ind),]

combined.pred <- cbind(round(combined.pred), age_tab)
write_feather(combined.pred, '/well/nichols/users/qcv214/KGPNN/sim15_age.feather')
```

I will generate a new set of indices to use so our samples are nicely mixed. *NOTE* that every 5 indices, the predicted are badly fit due to outsample, if we keep them in then they will be just pure noise. But let's keep them first

##Set random indices
Let's split 75% and 25%
```{r}
ind.test <- seq(2,nrow(combined.pred),4)
ind.train <- setdiff(1:nrow(combined.pred), ind.test)

write.csv(x = ind.train, file = '/well/nichols/users/qcv214/KGPNN/sim15_train_index.csv', row.names = FALSE)
write.csv(x = ind.test, file = '/well/nichols/users/qcv214/KGPNN/sim15_test_index.csv', row.names = FALSE)
```




Running 
//sim_mar15_sm_depind15_gpnn_bbig_init 51405889 ==> grad update is not using Rcpp


```{r}
runs <- c(1:3,5:10)
res1 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/sim_mar15_sm_depind15_gpnn_bbig_init_minloss__jobid_",i,".csv"))$x)
  }
plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Minimum Test RMSE across 800 iterations", ylab="RMSE", xlab="Run Number",ylim=c(0,5))
#abline(h=hs.test, lwd = 2,col='magenta')
#abline(h=7.5, lwd = 2)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('Model','ridge','response sd'),lty=c(1),col=c('red','magenta','black'))
```
It always overfit no matter what

//mar15_sm_depind15_gpnn_bbig_init_bbs  51757565

##Plot bbs loss
```{r}
library(ggplot2)
library(tidyr)

num.it <-400*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/sim_mar15_sm_depind15_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }

# Assuming resdat is your dataframe
# Add a row identifier
resdat <- as.data.frame(sqrt(res.mat[2,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 200)) +
  ylim(4.25,4.5) +
  theme_minimal() +
  labs(title = "Test RMSE", x = "Column", y = "Value", color = "Row ID")

```

```{r}
resdat <- as.data.frame(sqrt(res.mat[1,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 200)) +
  ylim(0,0.5) +
  theme_minimal() +
  labs(title = "Test RMSE", x = "Column", y = "Value", color = "Row ID")

```
There is a bottleneck at 4.4X, which is very similar to real-data analysis.
Still need to look at the class assignment

```{r}
success.run <- c(5)
n.train <- length(read.csv('/well/nichols/users/qcv214/KGPNN/dep15_train_index.csv')$x)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/dep15_test_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_jan6_sm_depind15_gpnn_bbig_init_bbs_inpred__jobid_',i,'.feather'))))[,3]
  dat.in <- tail(dat.in,n.train)
  print(paste0('run: ',i))
  print(table(dat.in))
}
```

```{r}
success.run <- c(1:10)
n.train <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_train_index.csv')$x)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_test_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_mar15_sm_depind15_gpnn_bbig_init_bbs_inpred__jobid_',i,'.feather'))))[,3]
  dat.in <- tail(dat.in,n.train)
  print(paste0('run: ',i))
  print(table(dat.in))
}
```
Only 4 out of 10 times got similar class assignment to true labels, with similar proportion as well. However the model knows nothing about the true class assignment. 

Test
```{r}
success.run <- c(1:10)
n.train <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_train_index.csv')$x)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_test_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_mar15_sm_depind15_gpnn_bbig_init_bbs_outpred__jobid_',i,'.feather'))))[,3]
  dat.in <- tail(dat.in,n.test)
  print(paste0('run: ',i))
  print(table(dat.in))
}
```



```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))
success.run <- c(2)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_train_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_mar15_sm_depind15_gpnn_bbig_init_bbs_inpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('age','sex','DepInd')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$age)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('age','sex','DepInd','pred','SqError',"class")

age.in_long <- pivot_longer(age.in, cols = c(age, sex, DepInd, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
```

#20 Mar
##Look at the true labels again

```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat_depind15.feather'))
success.run <- c(5)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/dep15_train_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_jan6_sm_depind15_gpnn_bbig_init_bbs_inpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('age','sex','DepInd')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$age)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('age','sex','DepInd','pred','SqError',"class")

age.in_long <- pivot_longer(age.in, cols = c(age, sex, DepInd, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
```
These classes are well-separated. I will induce effects on each of them. 

Female (4): effect stay the same
Male-H (3): increase effect by a factor of x3
Male-L (2): subtract age by 40

```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))
age_tab$pred_amp <- ifelse(age_tab$class == 4, age_tab$pred, 
                            ifelse(age_tab$class == 3, age_tab$pred*3, 
                                   ifelse(age_tab$class == 2, age_tab$pred - 40, NA)))
#write_feather(age_tab, '/well/nichols/users/qcv214/KGPNN/sim15_age.feather')

```
//[only run 3 and 8 survived, the rest ran into failure] mar20_sm_depind15_gpnn_bbig_init 52193315 ==> amplified subclass effects

//mar21_sm_depind15_gpnn_bbig_init_bbs 52247641


#22 Mar
##Plot bbs loss
```{r}
library(ggplot2)
library(tidyr)

num.it <-400*4
runs <- 1:10#c(1:4,6:9)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/sim_mar21_sm_depind15_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }

# Assuming resdat is your dataframe
# Add a row identifier
resdat <- as.data.frame(sqrt(res.mat[2,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 200)) +
  ylim(4.25,50) +
  theme_minimal() +
  labs(title = "Test RMSE", x = "Column", y = "Value", color = "Row ID")

```

```{r}
resdat <- as.data.frame(sqrt(res.mat[1,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 200)) +
  ylim(0,50) +
  theme_minimal() +
  labs(title = "Train RMSE", x = "Column", y = "Value", color = "Row ID")
```


The behaviours are crazy, trained to some point then it gets stuck at very high loss.

Look at the class assignment
```{r}
success.run <- c(1:4,6:9)
n.train <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_train_index.csv')$x)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_test_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_mar21_sm_depind15_gpnn_bbig_init_bbs_inpred__jobid_',i,'.feather'))))[,3]
  dat.in <- tail(dat.in,n.train)
  print(paste0('run: ',i))
  print(table(dat.in))
}
```
It cannot detect classes
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))
success.run <- c(1)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_train_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_mar21_sm_depind15_gpnn_bbig_init_bbs_inpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('age','sex','DepInd')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$age)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('age','sex','DepInd','pred','SqError',"class")

age.in_long <- pivot_longer(age.in, cols = c(age, sex, DepInd, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
```
It doesn't even get the right class assignment
This one is 
(1) all high deprivation index
(3) female-low
(4) male-low

##look at non optimisation
##Plot bbs loss
```{r}
library(ggplot2)
library(tidyr)

num.it <-300*4
runs <- c(3,8)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/sim_mar20_sm_depind15_gpnn_bbig_init_loss__jobid_",i,".csv")))[,1:num.it]
 }

# Assuming resdat is your dataframe
# Add a row identifier
resdat <- as.data.frame(sqrt(res.mat[2,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 200)) +
  ylim(0,50) +
  theme_minimal() +
  labs(title = "Test RMSE", x = "Column", y = "Value", color = "Row ID")

```
```{r}
resdat <- as.data.frame(sqrt(res.mat[1,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 200)) +
  ylim(0,50) +
  theme_minimal() +
  labs(title = "Train RMSE", x = "Column", y = "Value", color = "Row ID")
```

I can get class assignments from the minimum parameters
```{r}
for(i in c(3,8)){
co.bias2<- read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/sim_mar20_sm_depind15_gpnn_bbig_init_mincobias__jobid_",i,".csv"))$x
co.weights2<- read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/sim_mar20_sm_depind15_gpnn_bbig_init_mincoweights__jobid_",i,".csv"))
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))
ind.train <- (read.csv('/well/nichols/users/qcv214/KGPNN/sim15_train_index.csv')$x)
ind.test <- (read.csv('/well/nichols/users/qcv214/KGPNN/sim15_test_index.csv')$x)


#extract relevant data
co.dat <- cbind(ifelse(age_tab$sex == 0,-1,1),ifelse(age_tab$DepInd>median(age_tab$DepInd),0,1),ifelse(age_tab$DepInd<median(age_tab$DepInd),0,1))

# co.dat2 <-  cbind(age_tab$sex,ifelse(age_tab$DepInd>median(age_tab$DepInd),0,1),ifelse(age_tab$DepInd<median(age_tab$DepInd),0,1))
#define softmax
softmax <-function(z){
  t(apply(z,1,function(x){
    xmax <- max(x)
    return(exp(x-max(x))/sum(exp(x-max(x))))
  }))
}
#Find class assignments;

co.pre.hidden.layer <- t(t(co.dat %*% t(co.weights)) + co.bias)
co.hidden.layer <- softmax(co.pre.hidden.layer)
co.class <- apply(co.hidden.layer,1,which.max)


#Before I can do matching, I need to look at the classes.
print(table(age_tab$class,co.class))
}
```
The class assignments are totally wrong

We still need to identify how test RMSE of 10 is achieved. since...
```{r}
print(paste0("sd of class 2: ", sd(age_tab$pred_amp[age_tab$class==2])))
print(paste0("sd of class 3: ", sd(age_tab$pred_amp[age_tab$class==3])))
print(paste0("sd of class 4: ", sd(age_tab$pred_amp[age_tab$class==4])))

```


Maybe I need to look at the class assignments ie why they are in those classes
```{r}
#I am using co.dat of run 8 found in the two chunks above
age.in <- age_tab[c('age','sex','DepInd',"class","pred_amp")]
age.in <- cbind(age.in,as.factor(co.class))
colnames(age.in) <- c('age','sex','DepInd',"true_class","pred_amp","class_assigned")

age.in_long <- pivot_longer(age.in, cols = c(age, sex, DepInd, true_class, pred_amp), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class_assigned, y = value, fill = class_assigned)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "class_assigned",
       y = "Value")
```
Run 8 only splits by depind


[I only want to look at 3 and 8] mar21_sm_depind15_gpnn_bbig_init_min 52950351 ===> get squared loss at minimum


sim_mar21_sm_depind15_gpnn_bbig_init_min_inpred__jobid_3.feather
sim_mar21_sm_depind15_gpnn_bbig_init_min_outpred__jobid_3.feather
sim_mar21_sm_depind15_gpnn_bbig_init_min_loss__jobid_3.csv

```{r}
res<- read.csv("/well/nichols/users/qcv214/KGPNN/pile/sim_mar21_sm_depind15_gpnn_bbig_init_min_loss__jobid_3.csv")
sqrt(res)
res<- read.csv("/well/nichols/users/qcv214/KGPNN/pile/sim_mar21_sm_depind15_gpnn_bbig_init_min_loss__jobid_8.csv")
sqrt(res)
```

```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))
success.run <- c(3)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_train_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_mar21_sm_depind15_gpnn_bbig_init_min_inpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('pred_amp','sex','DepInd','class')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$pred_amp)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('pred_amp','sex','DepInd','true_class','pred','SqError',"class")

library(ggplot2)
library(tidyr)
age.in_long <- pivot_longer(age.in, cols = c(pred_amp, sex, DepInd,true_class, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
```
held-out
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))
success.run <- c(3)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_test_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_mar21_sm_depind15_gpnn_bbig_init_min_outpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('pred_amp','sex','DepInd','class')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$pred_amp)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('pred_amp','sex','DepInd','true_class','pred','SqError',"class")

library(ggplot2)
library(tidyr)
age.in_long <- pivot_longer(age.in, cols = c(pred_amp, sex, DepInd,true_class, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
```

```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))
success.run <- c(8)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_train_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_mar21_sm_depind15_gpnn_bbig_init_min_inpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('pred_amp','sex','DepInd','class')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$pred_amp)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('pred_amp','sex','DepInd','true_class','pred','SqError',"class")

library(ggplot2)
library(tidyr)
age.in_long <- pivot_longer(age.in, cols = c(pred_amp, sex, DepInd,true_class, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
sqrt(mean(age.in$SqError))
sqrt(median(age.in$SqError))
```
held-out
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))
success.run <- c(8)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_test_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_mar21_sm_depind15_gpnn_bbig_init_min_outpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('pred_amp','sex','DepInd','class')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$pred_amp)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('pred_amp','sex','DepInd','true_class','pred','SqError',"class")

library(ggplot2)
library(tidyr)
age.in_long <- pivot_longer(age.in, cols = c(pred_amp, sex, DepInd,true_class, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
sqrt(mean(age.in$SqError))
sqrt(median(age.in$SqError))
```

Both run 3 and 8 seem tobe splitting by 
1 - High dep
2 - Male low dep
3 - female low dep

This isn't actually horrible, especially when looknig at median.


##I will create a class signal that are even stronger.
###The thing is ideal signal should exhaust all 4 combinations of sex and depreivation index.
####What if I induce female to be very strong effect?
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))
age_tab$pred_amp <- ifelse(age_tab$class == 4, age_tab$pred*6,  #Faemale x 10
                            ifelse(age_tab$class == 3, age_tab$pred*2,  #Male high dep x 2
                                   ifelse(age_tab$class == 2, age_tab$pred - 40, NA))) #male low dep -40
write_feather(age_tab, '/well/nichols/users/qcv214/KGPNN/sim15_age_femaleAmp.feather')
```
```{r}
print(paste0("sd of class 2: ", sd(age_tab$pred_amp[age_tab$class==2])))
print(paste0("sd of class 3: ", sd(age_tab$pred_amp[age_tab$class==3])))
print(paste0("sd of class 4: ", sd(age_tab$pred_amp[age_tab$class==4])))

```

[only 10 survived] apr1_sm_depind15_gpnn_bbig_init_famp 52952714 ===> Amplifying female.

#3 apr
##Look at female amp
##look at non optimisation
##Plot bbs loss

```{r}
num.it <-400*4
runs <- c(10)
res.mat <-as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/sim_apr1_sm_depind15_gpnn_bbig_init_famp_loss__jobid_",i,".csv")))[,1:num.it]
plot(res.mat[2,], type = 'b', ylim = c(300,2000))
plot(res.mat[1,], type = 'b', ylim = c(0,2000))

```
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age_femaleAmp.feather'))
success.run <- c(8)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_train_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_apr1_sm_depind15_gpnn_bbig_init_famp_min_inpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('pred_amp','sex','DepInd','class')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$pred_amp)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('pred_amp','sex','DepInd','true_class','pred','SqError',"class")

library(ggplot2)
library(tidyr)
age.in_long <- pivot_longer(age.in, cols = c(pred_amp, sex, DepInd,true_class, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
sqrt(mean(age.in$SqError))
sqrt(median(age.in$SqError))
```
held-out
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age_femaleAmp.feather'))
success.run <- c(8)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_test_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_apr1_sm_depind15_gpnn_bbig_init_famp_min_outpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('pred_amp','sex','DepInd','class')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$pred_amp)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('pred_amp','sex','DepInd','true_class','pred','SqError',"class")

library(ggplot2)
library(tidyr)
age.in_long <- pivot_longer(age.in, cols = c(pred_amp, sex, DepInd,true_class, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
sqrt(mean(age.in$SqError))
sqrt(median(age.in$SqError))
```
This exhaust all 4 classes, now it knows signal for each class



##Sub class splitting

Do I really need to do this if we have shown that the above works? 
But perhaps I should use this combo...

Right now co.dat is split into
Gender {-1,1}, low dep {0,1}, high dep {0,1}
I think I need either
1. Gender {-1,1}, dep {-1,1} ===> (-1,-1), (-1,1), (1,-1), (1,1). From this, we are required that female with high dep and male with low dep have to be distinguishable, I think it's doable.
  Note that in the current signal with 3 classes,  (-1,-1), (-1,1) are indisinguishable, meaning the coef of deprivation may not be so good?

or
2. Male {0,1}, female {0,1},low dep {0,1}, high dep {0,1}

#having {-1,1} assume symmetrical effect?, not really since there is nothing in the middle.


#11 Apr

## Incorporating latent class into hidden gp layer
```{r}
 #this is 12 x 5456
partial.gp.centroid<-t(as.matrix(read_feather(paste0("/well/nichols/users/qcv214/KGPNN/partial_gp_centroids_fixed_300.540.feather"))))
```
What I need to do is add *K* number of rows, with each row corresponding to 5456 (random) gp coef of each latent class. I am guessing they need to be ~N(,)?? should I include subtle change in mean? Maybe not for now.
I need to concatenate the result of Softmax to the hidden layer.

Let's create GP coefficients for *4* latent classes with 5456 latent terms (30 deg hermite poly)
```{r}
set.seed(4)
gp.coef <- matrix(rnorm(4*5456),nrow = 4 )

partial.mix <- t(rbind(partial.gp.centroid,gp.coef))
write_feather(as.data.frame(partial.mix),"/well/nichols/users/qcv214/KGPNN/partial_gp_centroids_fixed_300.540_mixed4Cl.feather")

```




#13 apr 
##Testing mixed model
[only 6,9 survived] apr11_sm_depind15_mixed_gpnn_bbig_init 53705353
Then I need to run the `min` calculation
apr11_sm_depind15_mixed_gpnn_bbig_init_min 53717109


```{r}
res<- read.csv("/well/nichols/users/qcv214/KGPNN/pile/sim_apr11_sm_depind15_mixed_gpnn_bbig_init_min_loss__jobid_6.csv")
sqrt(res)
res<- read.csv("/well/nichols/users/qcv214/KGPNN/pile/sim_apr11_sm_depind15_mixed_gpnn_bbig_init_min_loss__jobid_9.csv")
sqrt(res)
```
##Plot min loss
###Run 3
```{r}
num.it <-400*4
runs <- c(3)
res.mat <-as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/sim_apr11_sm_depind15_mixed_gpnn_bbig_init_loss__jobid_",i,".csv")))[,1:num.it]
plot(res.mat[2,], type = 'b', ylim = c(90,2000))
plot(res.mat[1,], type = 'b', ylim = c(0,2000))

```
###run 9
```{r}
num.it <-400*4
runs <- c(9)
res.mat <-as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/sim_apr11_sm_depind15_mixed_gpnn_bbig_init_loss__jobid_",i,".csv")))[,1:num.it]
plot(res.mat[2,], type = 'b', ylim = c(90,2000))
plot(res.mat[1,], type = 'b', ylim = c(0,2000))

```
##Plot loss
```{r}
library(ggplot2)
library(tidyr)

num.it <-400*4
runs <- c(6,9)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/sim_apr11_sm_depind15_mixed_gpnn_bbig_init_loss__jobid_",i,".csv")))[,1:num.it]
 }

# Assuming resdat is your dataframe
# Add a row identifier
resdat <- as.data.frame(sqrt(res.mat[2,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 200)) +
  ylim(0,50) +
  theme_minimal() +
  labs(title = "Test RMSE", x = "iterations", y = "Value", color = "Run number")

```
```{r}
resdat <- as.data.frame(sqrt(res.mat[1,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 200)) +
  ylim(0,50) +
  theme_minimal() +
  labs(title = "Train RMSE",x = "iterations", y = "Value", color = "Run number")
```


```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))
success.run <- c(6)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_train_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_apr11_sm_depind15_mixed_gpnn_bbig_init_min_inpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('pred_amp','sex','DepInd','class')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$pred_amp)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('pred_amp','sex','DepInd','true_class','pred','SqError',"class")

library(ggplot2)
library(tidyr)
age.in_long <- pivot_longer(age.in, cols = c(pred_amp, sex, DepInd,true_class, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
```
held-out
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))
success.run <- c(6)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_test_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_apr11_sm_depind15_mixed_gpnn_bbig_init_min_outpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('pred_amp','sex','DepInd','class')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$pred_amp)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('pred_amp','sex','DepInd','true_class','pred','SqError',"class")

library(ggplot2)
library(tidyr)
age.in_long <- pivot_longer(age.in, cols = c(pred_amp, sex, DepInd,true_class, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
```

```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))
success.run <- c(9)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_train_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_apr11_sm_depind15_mixed_gpnn_bbig_init_min_inpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('pred_amp','sex','DepInd','class')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$pred_amp)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('pred_amp','sex','DepInd','true_class','pred','SqError',"class")

library(ggplot2)
library(tidyr)
age.in_long <- pivot_longer(age.in, cols = c(pred_amp, sex, DepInd,true_class, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
sqrt(mean(age.in$SqError))
sqrt(median(age.in$SqError))
```
held-out
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))
success.run <- c(9)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_test_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_apr11_sm_depind15_mixed_gpnn_bbig_init_min_outpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('pred_amp','sex','DepInd','class')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$pred_amp)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('pred_amp','sex','DepInd','true_class','pred','SqError',"class")

library(ggplot2)
library(tidyr)
age.in_long <- pivot_longer(age.in, cols = c(pred_amp, sex, DepInd,true_class, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
sqrt(mean(age.in$SqError))
sqrt(median(age.in$SqError))
```
Run 9 can discover the right latent classes. 

###Note
Note that I haven't thought about how to interpret interactions or saliency of interactions yet.+

Running bbs version 
[2-10] apr13_sm_depind15_mixed_gpnn_bbig_init_bbs 53783977

##Plot bbs loss
```{r}
library(ggplot2)
library(tidyr)

num.it <-400*4
runs <- c(2:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/sim_apr13_sm_depind15_mixed_gpnn_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }

# Assuming resdat is your dataframe
# Add a row identifier
resdat <- as.data.frame(sqrt(res.mat[2,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 200)) +
  ylim(4.25,60) +
  theme_minimal() +
  labs(title = "Test RMSE", x = "Column", y = "Value", color = "Row ID")

```

```{r}
resdat <- as.data.frame(sqrt(res.mat[1,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 200)) +
  ylim(0,20) +
  theme_minimal() +
  labs(title = "Train RMSE", x = "Column", y = "Value", color = "Row ID")
```
#Look at class assignment of converged run
##Train
```{r}
success.run <- c(2:10)
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))
n.train <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_train_index.csv')$x)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_test_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_apr13_sm_depind15_mixed_gpnn_bbig_init_bbs_inpred__jobid_',i,'.feather'))))[,3]
  dat.in <- tail(dat.in,n.train)
  dat.in.ind <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_apr13_sm_depind15_mixed_gpnn_bbig_init_bbs_inpred__jobid_',i,'.feather'))))[,1]
  dat.in.ind <- tail(dat.in.ind,n.train)
  print(paste0('run: ',i))
  print(table(age_tab$class[dat.in.ind],dat.in))
}
```
##Test
```{r}
success.run <- c(2:10)
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))
n.train <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_test_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_apr13_sm_depind15_mixed_gpnn_bbig_init_bbs_outpred__jobid_',i,'.feather'))))[,3]
  dat.in <- tail(dat.in,n.train)
  dat.in.ind <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_apr13_sm_depind15_mixed_gpnn_bbig_init_bbs_outpred__jobid_',i,'.feather'))))[,1]
  dat.in.ind <- tail(dat.in.ind,n.train)
  print(paste0('run: ',i))
  print(table(age_tab$class[dat.in.ind],dat.in))
}
```

#15 apr
##After meeting Tom
[1,2,7 survived, but misaved preds and class assignments] apr15_sm_depind15_mixed_gpnn_bbig_init 53815930 ==> from `sm_depind15_mixed2_gpnn_bbig_init` making latent class gp coef learnable

```{r}
library(ggplot2)
library(tidyr)

num.it <-400*4
runs <- c(1,2,7)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/sim_apr15_sm_depind15_mixed_gpnn_bbig_init_loss__jobid_",i,".csv")))[,1:num.it]
 }

# Assuming resdat is your dataframe
# Add a row identifier
resdat <- as.data.frame(sqrt(res.mat[2,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 200)) +
  ylim(0,50) +
  theme_minimal() +
  labs(title = "Test RMSE", x = "iterations", y = "Value", color = "Run number")

```
```{r}
resdat <- as.data.frame(sqrt(res.mat[1,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 200)) +
  ylim(0,50) +
  theme_minimal() +
  labs(title = "Train RMSE",x = "iterations", y = "Value", color = "Run number")
```

##Plot minimum
###Run 1
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))
success.run <- c(1)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_train_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_apr15_sm_depind15_mixed_gpnn_bbig_init_min_inpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('pred_amp','sex','DepInd','class')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$pred_amp)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('pred_amp','sex','DepInd','true_class','pred','SqError',"class")

library(ggplot2)
library(tidyr)
age.in_long <- pivot_longer(age.in, cols = c(pred_amp, sex, DepInd,true_class, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
sqrt(mean(age.in$SqError))
sqrt(median(age.in$SqError))
```
held-out
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))
success.run <- c(1)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_test_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_apr15_sm_depind15_mixed_gpnn_bbig_init_min_outpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('pred_amp','sex','DepInd','class')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$pred_amp)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('pred_amp','sex','DepInd','true_class','pred','SqError',"class")

library(ggplot2)
library(tidyr)
age.in_long <- pivot_longer(age.in, cols = c(pred_amp, sex, DepInd,true_class, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
sqrt(mean(age.in$SqError))
sqrt(median(age.in$SqError))
```
###Run 2
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))
success.run <- c(2)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_train_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_apr15_sm_depind15_mixed_gpnn_bbig_init_min_inpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('pred_amp','sex','DepInd','class')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$pred_amp)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('pred_amp','sex','DepInd','true_class','pred','SqError',"class")

library(ggplot2)
library(tidyr)
age.in_long <- pivot_longer(age.in, cols = c(pred_amp, sex, DepInd,true_class, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
sqrt(mean(age.in$SqError))
sqrt(median(age.in$SqError))
```
held-out
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))
success.run <- c(2)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_test_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_apr15_sm_depind15_mixed_gpnn_bbig_init_min_outpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('pred_amp','sex','DepInd','class')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$pred_amp)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('pred_amp','sex','DepInd','true_class','pred','SqError',"class")

library(ggplot2)
library(tidyr)
age.in_long <- pivot_longer(age.in, cols = c(pred_amp, sex, DepInd,true_class, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
sqrt(mean(age.in$SqError))
sqrt(median(age.in$SqError))
```
###Run 7 
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))
success.run <- c(7)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_train_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_apr15_sm_depind15_mixed_gpnn_bbig_init_min_inpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('pred_amp','sex','DepInd','class')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$pred_amp)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('pred_amp','sex','DepInd','true_class','pred','SqError',"class")

library(ggplot2)
library(tidyr)
age.in_long <- pivot_longer(age.in, cols = c(pred_amp, sex, DepInd,true_class, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
sqrt(mean(age.in$SqError))
sqrt(median(age.in$SqError))
```
held-out
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))
success.run <- c(7)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_test_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_apr15_sm_depind15_mixed_gpnn_bbig_init_min_outpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('pred_amp','sex','DepInd','class')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$pred_amp)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('pred_amp','sex','DepInd','true_class','pred','SqError',"class")

library(ggplot2)
library(tidyr)
age.in_long <- pivot_longer(age.in, cols = c(pred_amp, sex, DepInd,true_class, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
sqrt(mean(age.in$SqError))
sqrt(median(age.in$SqError))
```
54573104







#21 APR
//apr21_sm_depind15_mixed_gpnn_bbig_init 54576502 ==> from `sm_depind15_mixed2_gpnn_bbig_init` making latent class gp coef learnable... gp.coef gradient fixing from apr15 version.
##Results
###Plot of loss
```{r}
library(ggplot2)
library(tidyr)

num.it <-400*4
runs <- c(1:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/sim_apr21_sm_depind15_mixed_gpnn_bbig_init_loss__jobid_",i,".csv")))[,1:num.it]
 }

# Assuming resdat is your dataframe
# Add a row identifier
resdat <- as.data.frame(sqrt(res.mat[2,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 200)) +
  ylim(0,150) +
  theme_minimal() +
  labs(title = "Test RMSE", x = "iterations", y = "Value", color = "Run number")

```
All runs survived, but converged at 60 despite bering adaptive learning rate.

```{r}
resdat <- as.data.frame(sqrt(res.mat[1,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 200)) +
  ylim(0,50) +
  theme_minimal() +
  labs(title = "Train RMSE",x = "iterations", y = "Value", color = "Run number")
```
###Look at class assignment
##Train
```{r}
success.run <- c(1:10)
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))
n.train <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_train_index.csv')$x)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_test_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_apr21_sm_depind15_mixed_gpnn_bbig_init_min_inpred__jobid_',i,'.feather'))))[,3]
  dat.in <- tail(dat.in,n.train)
  dat.in.ind <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_apr21_sm_depind15_mixed_gpnn_bbig_init_min_inpred__jobid_',i,'.feather'))))[,1]
  dat.in.ind <- tail(dat.in.ind,n.train)
  print(paste0('run: ',i))
  print(table(age_tab$class[dat.in.ind],dat.in))
}
```
3,4,9 correct split
7,10 over split

###box plot for each run
###Run 3
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))
success.run <- c(3)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_train_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_apr21_sm_depind15_mixed_gpnn_bbig_init_min_inpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('pred_amp','sex','DepInd','class')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$pred_amp)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('pred_amp','sex','DepInd','true_class','pred','SqError',"class")

library(ggplot2)
library(tidyr)
age.in_long <- pivot_longer(age.in, cols = c(pred_amp, sex, DepInd,true_class, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
sqrt(mean(age.in$SqError))
sqrt(median(age.in$SqError))
```
held-out
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))
success.run <- c(3)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_test_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_apr21_sm_depind15_mixed_gpnn_bbig_init_min_outpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('pred_amp','sex','DepInd','class')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$pred_amp)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('pred_amp','sex','DepInd','true_class','pred','SqError',"class")

library(ggplot2)
library(tidyr)
age.in_long <- pivot_longer(age.in, cols = c(pred_amp, sex, DepInd,true_class, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
sqrt(mean(age.in$SqError))
sqrt(median(age.in$SqError))
```
###Run 4
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))
success.run <- c(4)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_train_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_apr21_sm_depind15_mixed_gpnn_bbig_init_min_inpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('pred_amp','sex','DepInd','class')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$pred_amp)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('pred_amp','sex','DepInd','true_class','pred','SqError',"class")

library(ggplot2)
library(tidyr)
age.in_long <- pivot_longer(age.in, cols = c(pred_amp, sex, DepInd,true_class, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
sqrt(mean(age.in$SqError))
sqrt(median(age.in$SqError))
```
held-out
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))
success.run <- c(4)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_test_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_apr21_sm_depind15_mixed_gpnn_bbig_init_min_outpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('pred_amp','sex','DepInd','class')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$pred_amp)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('pred_amp','sex','DepInd','true_class','pred','SqError',"class")

library(ggplot2)
library(tidyr)
age.in_long <- pivot_longer(age.in, cols = c(pred_amp, sex, DepInd,true_class, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
sqrt(mean(age.in$SqError))
sqrt(median(age.in$SqError))
```

###Run 9
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))
success.run <- c(9)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_train_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_apr21_sm_depind15_mixed_gpnn_bbig_init_min_inpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('pred_amp','sex','DepInd','class')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$pred_amp)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('pred_amp','sex','DepInd','true_class','pred','SqError',"class")

library(ggplot2)
library(tidyr)
age.in_long <- pivot_longer(age.in, cols = c(pred_amp, sex, DepInd,true_class, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
sqrt(mean(age.in$SqError))
sqrt(median(age.in$SqError))
```
held-out
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))
success.run <- c(9)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_test_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_apr21_sm_depind15_mixed_gpnn_bbig_init_min_outpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('pred_amp','sex','DepInd','class')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$pred_amp)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('pred_amp','sex','DepInd','true_class','pred','SqError',"class")

library(ggplot2)
library(tidyr)
age.in_long <- pivot_longer(age.in, cols = c(pred_amp, sex, DepInd,true_class, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
sqrt(mean(age.in$SqError))
sqrt(median(age.in$SqError))
```

###Run 7
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))
success.run <- c(7)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_train_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_apr21_sm_depind15_mixed_gpnn_bbig_init_min_inpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('pred_amp','sex','DepInd','class')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$pred_amp)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('pred_amp','sex','DepInd','true_class','pred','SqError',"class")

library(ggplot2)
library(tidyr)
age.in_long <- pivot_longer(age.in, cols = c(pred_amp, sex, DepInd,true_class, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
sqrt(mean(age.in$SqError))
sqrt(median(age.in$SqError))
```
held-out
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))
success.run <- c(7)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_test_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_apr21_sm_depind15_mixed_gpnn_bbig_init_min_outpred__jobid_',i,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')
}
age.in <- age_tab[dat.in$id_ind,c('pred_amp','sex','DepInd','class')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$pred_amp)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('pred_amp','sex','DepInd','true_class','pred','SqError',"class")

library(ggplot2)
library(tidyr)
age.in_long <- pivot_longer(age.in, cols = c(pred_amp, sex, DepInd,true_class, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
sqrt(mean(age.in$SqError))
sqrt(median(age.in$SqError))
```

#25 Apr

##To do
1. Want to go back to GPNN-GP-Lin, maybe with 52 regions and then create interactions.
  Base it on `/well/nichols/users/qcv214/bnn2/res3/sigma/gpnn_ols_bbig_init_com.R`=> transofrmation code
  and `/well/nichols/users/qcv214/bnn2/res3/res4_first_layer_gp.R` => gp generation
  and `'/well/nichols/users/qcv214/bnn2/res3/res4mask.nii.gz'` => mask

Running
[1,5,6,7,9] apr25_sm_depind15_gpnn_bbig_init  55617349 ==> testing with degvec = 10, cap BB at magnitude 0.8 and fixing no BB gradients... took 8.5 minutes ====> but loading up data takes 1.5 hours
I ran into out of memory issue. *** I will be changing the name to gpols instead of gpnn

#29 Apr

Try first version of GP-OLS

##Plot loss
```{r}
library(ggplot2)
library(tidyr)

num.it <-400*4
runs <- c(1,5,6,7,9)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/sim_apr25_sm_depind15_gpnn_bbig_init_loss__jobid_",i,".csv")))[,1:num.it]
 }

# Assuming resdat is your dataframe
# Add a row identifier
resdat <- as.data.frame(sqrt(res.mat[2,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 200)) +
  ylim(7,500) +
  theme_minimal() +
  labs(title = "Test RMSE", x = "iterations", y = "Value", color = "Run number")

```

```{r}
resdat <- as.data.frame(sqrt(res.mat[1,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 200)) +
  ylim(0,40) +
  theme_minimal() +
  labs(title = "Train RMSE",x = "iterations", y = "Value", color = "Run number")
```




apr29_sm_depind15_gpols_bbig_init_min 55815635 ===> calculate min results ***note that this is not representative of stochastic due to using high number of training in the last layer


[1,2,3,5,7,8,9,10] apr29_sm_depind15_gpols_bbig_init.  55779367 ==> since half of the previous runs still fail, I am changing it to capping lower lr by a lot (0.8 to 0.1) and if no diff then use 0.025. The machine crashes due to diff_x in the middle of an epoch.... also im changin the number of epochs to 1000

```{r}
library(ggplot2)
library(tidyr)

num.it <-1000*4
runs <- c(1,2,3,5,7,8,9,10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/sim_apr29_sm_depind15_gpols_bbig_init_loss__jobid_",i,".csv")))[,1:num.it]
 }

# Assuming resdat is your dataframe
# Add a row identifier
resdat <- as.data.frame(sqrt(res.mat[2,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(7,30) +
  theme_minimal() +
  labs(title = "Test RMSE", x = "iterations", y = "Value", color = "Run number")

```

```{r}
resdat <- as.data.frame(sqrt(res.mat[1,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(0,40) +
  theme_minimal() +
  labs(title = "Train RMSE",x = "iterations", y = "Value", color = "Run number")
```

Need to run min on this
//apr30_sm_depind15_gpols_bbig_init_min  55863674



[failed due to time limit exceeded] apr30_sm_depind15_gpols_bbig_init 55869569 ==> modify first layer gp transformation, more memory efficient. allowing 30 deg expansion using `res4_first_layer_gp_tf.R`.. I think takes 26.5 to load GPs ===> 45 mins, 116 epochs. May not make it to the end. only got to 550 epochs

//[1,2,3,4,6,7,9]may1_sm_depind15_gpols_bbig_init 55955930 ==> 20 deg... 2 hours to train 1k epochs. I think 9 hours to load up gps

#2 May
```{r}
library(ggplot2)
library(tidyr)

num.it <-1000*4
runs <- c(1,2,3,4,6,7,9)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/sim_may1_sm_depind15_gpols_bbig_init_loss__jobid_",i,".csv")))[,1:num.it]
 }

# Assuming resdat is your dataframe
# Add a row identifier
resdat <- as.data.frame(sqrt(res.mat[2,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(7,30) +
  theme_minimal() +
  labs(title = "Test RMSE", x = "iterations", y = "Value", color = "Run number")

```

```{r}
resdat <- as.data.frame(sqrt(res.mat[1,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(0,40) +
  theme_minimal() +
  labs(title = "Train RMSE",x = "iterations", y = "Value", color = "Run number")
```


This isn't showing any imprvement on test rmse at all. Basically increasing the degree does not seem to be showing it.


#3 May
Run ridge and lasso on the simulated data
`sim_may3_ridge_depind15` and `sim_may3_lasso_depind15` 56182343
```{r}
#lasso
runs.hs <- 1:10
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/sim_may3_lasso_depind15_noscale_",i,".csv"))))
}
# (hs.train <- quantile(hs.int[,1],c(0.25,0.5,0.75)))
# (hs.test <-quantile(hs.int[,3],c(0.25,0.5,0.75)))

(hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75)))
(hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75)))

```

```{r}
#ridge
runs.hs <- 1:10
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/sim_may3_ridge_depind15_noscale_",i,".csv"))))
}
# (hs.train <- quantile(hs.int[,1],c(0.25,0.5,0.75)))
# (hs.test <-quantile(hs.int[,3],c(0.25,0.5,0.75)))

(hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75)))
(hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75)))

```

We can finally see a huge improvement from ridge!!! Ridge has RMSE of 58

#May 6

I need to do
min version and bbs version of    `may1_sm_depind15_gpols`
Running 
[1,2,3,4,6,7,9] //may1_sm_depind15_gpols_bbig_init_min 56548248 ==> min
[1,2,3,4,6,7,9] //may1_sm_depind15_gpols_bbig_init_bbs 57132971 ===> (first tested with low n.expan.degree of 1, but wouldn't be compatible with saved theta)
may1_sm_depind15_gpols_bbig_init_bbs 57638137 is run to obtain predictions of bbs above
#7 May
##Min
###Class assignment of train Train
```{r}
success.run <- c(1,2,3,4,6,7,9)
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))
n.train <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_train_index.csv')$x)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_test_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_may1_sm_depind15_gpols_bbig_init_min_inpred__jobid_',i,'.feather'))))[,3]
  dat.in <- tail(dat.in,n.train)
  dat.in.ind <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_may1_sm_depind15_gpols_bbig_init_min_inpred__jobid_',i,'.feather'))))[,1]
  dat.in.ind <- tail(dat.in.ind,n.train)
  print(paste0('run: ',i))
  print(table(age_tab$class[dat.in.ind],dat.in))
}
``` 
Only run 9 actually discover the true classes. Actually perhaps run 9 is the only decent one according to RMSE of bbs below?

##plot bbs
```{r}
library(ggplot2)
library(tidyr)

num.it <-1000*4
runs <- c(1,3,4,6,7,9,2)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/sim_may1_sm_depind15_gpols_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }

# Assuming resdat is your dataframe
# Add a row identifier
resdat <- as.data.frame(sqrt(res.mat[2,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(7,30) +
  theme_minimal() +
  labs(title = "Test RMSE", x = "iterations", y = "Value", color = "Run number")

```

```{r}
resdat <- as.data.frame(sqrt(res.mat[1,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(0,40) +
  theme_minimal() +
  labs(title = "Train RMSE",x = "iterations", y = "Value", color = "Run number")
```

It's still super jumpy, but at least better than without smoothing.

###Look at class assignment
####Train
```{r}
success.run <- c(1,2,3,4,6,7,9)
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))
n.train <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_train_index.csv')$x)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_test_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_may1_sm_depind15_gpols_bbig_init_bbs_inpred__jobid_',i,'.feather'))))[,3]
  dat.in <- tail(dat.in,n.train)
  dat.in.ind <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_may1_sm_depind15_gpols_bbig_init_bbs_inpred__jobid_',i,'.feather'))))[,1]
  dat.in.ind <- tail(dat.in.ind,n.train)
  print(paste0('run: ',i))
  print(table(age_tab$class[dat.in.ind],dat.in))
}
```


#19 May
Saving the last 200 epochs of bbs predictions
//may19_sm_depind15_gpols_bbig_init_bbs   58776280
//[some] may19_sm_depind15_gpols_bbig_init_sgld   58779982
may19_sm_depind15_gpols_bbig_init 58816121 ==> fixing co.weight init


#20 May

##Observe the trajectory of class assignment
Let's look at run 2 and 9 with the correct assignments
may19_sm_depind15_gpols_bbig_init_bbs
```{r}
success.run <- c(2)
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))
n.train <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_train_index.csv')$x)
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_test_index.csv')$x)
for(i in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_may19_sm_depind15_gpols_bbig_init_bbs_inpred__jobid_',i,'.feather'))))[,3]
  dat.in.ind <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_may19_sm_depind15_gpols_bbig_init_bbs_inpred__jobid_',i,'.feather'))))[,1]
  print(paste0('run: ',i))
  print(table(age_tab$class[dat.in.ind],dat.in))
}
```
See trajectory

```{r}
plot(dat.in[dat.in.ind == 1073])
```
This will look at the last 201 epochs saved.
```{r}
# Identify unique sample indices
unique_samples <- unique(dat.in.ind)
num_samples <- length(unique_samples)
num_time_points <- length(dat.in) / num_samples

# Create an empty matrix
data_matrix <- matrix(NA, nrow = num_samples, ncol = num_time_points)

# Fill the matrix
for (i in 1:num_samples) {
  sample_index <- unique_samples[i]
  data_matrix[i, ] <- dat.in[dat.in.ind == sample_index]
}

# Verify the matrix
# print(dim(data_matrix))  # Should be (num_samples, num_time_points)
# print(head(data_matrix))  # Inspect the first few rows

# Perform analysis (example: Transition Matrix)
transition_matrix <- function(traj) {
  trans_mat <- matrix(0, nrow = 4, ncol = 4)
  rownames(trans_mat) <- colnames(trans_mat) <- 1:4
  transitions <- table(traj[-length(traj)], traj[-1])
  trans_mat[as.numeric(rownames(transitions)), as.numeric(colnames(transitions))] <- transitions
  trans_mat <- trans_mat / rowSums(trans_mat)
  return(trans_mat)
}

# Compute the transition matrix for each sample
transition_matrices <- lapply(1:nrow(data_matrix), function(i) transition_matrix(data_matrix[i, ]))

# Example output for the first sample
print(transition_matrices[[3]])
```
###Assessing frequency of assignment change BY CLASS
```{r}
# Identify unique sample indices
unique_samples <- unique(dat.in.ind)
num_samples <- length(unique_samples)

# Initialize a list to store transition counts for each sample
transitions_list <- vector("list", length = num_samples)
names(transitions_list) <- unique_samples

# Calculate transitions for each sample
for (i in 1:num_samples) {
  sample_index <- unique_samples[i]
  sample_data <- dat.in[dat.in.ind == sample_index]
  
  # Create a transition table for the sample
  transitions <- table(sample_data[-length(sample_data)], sample_data[-1])
  
  # Store in the list
  transitions_list[[i]] <- transitions
}

# Convert the list to a data frame
transition_df <- do.call(rbind, lapply(names(transitions_list), function(sample) {
  trans_mat <- transitions_list[[sample]]
  df <- as.data.frame(as.table(trans_mat))
  df$Sample <- sample
  return(df)
}))

# Set column names
colnames(transition_df) <- c("From", "To", "Frequency", "Sample")

# Display the transition data frame
print(head(transition_df))

```











###Assessing freq of assignment change by subject
```{r}
# Identify unique sample indices
unique_samples <- unique(dat.in.ind)
num_samples <- length(unique_samples)

# Initialize a vector to store the number of changes for each sample
num_changes <- numeric(num_samples)
names(num_changes) <- unique_samples

# Calculate the number of changes for each sample
for (i in 1:num_samples) {
  sample_index <- unique_samples[i]
  sample_data <- dat.in[dat.in.ind == sample_index]
  
  # Count the number of times the class changes
  changes <- sum(diff(sample_data) != 0)
  
  # Store the number of changes
  num_changes[i] <- changes
}

# Create a data frame for easier handling and visualization
changes_df <- data.frame(Sample = unique_samples, NumChanges = num_changes)

# Display the changes data frame
print(head(changes_df))

# Summary statistics
summary(changes_df$NumChanges)

# Histogram of the number of changes
library(ggplot2)

ggplot(changes_df, aes(x = NumChanges)) +
  geom_histogram(binwidth = 1, fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Distribution of Class Changes per Subject", x = "Number of Changes", y = "Frequency") +
  theme_minimal()

```
From here, we see that class assignment changes rarely occur in the last 200 epochs, and when occurs, it only occurs once per subject. 
Class changes only happen in 216 subjects from 888 subjects (24%)

####I will test this for run 9
###Assessing freq of assignment change by subject
```{r}
succ.run <- 9
dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_may19_sm_depind15_gpols_bbig_init_bbs_inpred__jobid_',succ.run,'.feather'))))[,3]
dat.in.ind <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_may19_sm_depind15_gpols_bbig_init_bbs_inpred__jobid_',succ.run,'.feather'))))[,1]
# Identify unique sample indices
unique_samples <- unique(dat.in.ind)
num_samples <- length(unique_samples)

# Initialize a vector to store the number of changes for each sample
num_changes <- numeric(num_samples)
names(num_changes) <- unique_samples

# Calculate the number of changes for each sample
for (i in 1:num_samples) {
  sample_index <- unique_samples[i]
  sample_data <- dat.in[dat.in.ind == sample_index]
  
  # Count the number of times the class changes
  changes <- sum(diff(sample_data) != 0)
  
  # Store the number of changes
  num_changes[i] <- changes
}

# Create a data frame for easier handling and visualization
changes_df <- data.frame(Sample = unique_samples, NumChanges = num_changes)

# Display the changes data frame
print(head(changes_df))

# Summary statistics
summary(changes_df$NumChanges)

# Histogram of the number of changes
library(ggplot2)

ggplot(changes_df, aes(x = NumChanges)) +
  geom_histogram(binwidth = 1, fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Distribution of Class Changes per Subject", x = "Number of Changes", y = "Frequency") +
  theme_minimal()

```
No class assignment changes in run 9

####Let's try run 7, with maybe most unstable 
```{r}
succ.run <- 7
dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_may19_sm_depind15_gpols_bbig_init_bbs_inpred__jobid_',succ.run,'.feather'))))[,3]
dat.in.ind <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_may19_sm_depind15_gpols_bbig_init_bbs_inpred__jobid_',succ.run,'.feather'))))[,1]
# Identify unique sample indices
unique_samples <- unique(dat.in.ind)
num_samples <- length(unique_samples)

# Initialize a vector to store the number of changes for each sample
num_changes <- numeric(num_samples)
names(num_changes) <- unique_samples

# Calculate the number of changes for each sample
for (i in 1:num_samples) {
  sample_index <- unique_samples[i]
  sample_data <- dat.in[dat.in.ind == sample_index]
  
  # Count the number of times the class changes
  changes <- sum(diff(sample_data) != 0)
  
  # Store the number of changes
  num_changes[i] <- changes
}

# Create a data frame for easier handling and visualization
changes_df <- data.frame(Sample = unique_samples, NumChanges = num_changes)

# Display the changes data frame
print(head(changes_df))

# Summary statistics
summary(changes_df$NumChanges)

# Histogram of the number of changes
library(ggplot2)

ggplot(changes_df, aes(x = NumChanges)) +
  geom_histogram(binwidth = 1, fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Distribution of Class Changes per Subject", x = "Number of Changes", y = "Frequency") +
  theme_minimal()

```
Run number 7 is an unstable run, we can see that class assignmentdistribution is large.
####Let's try for all runs
```{r}
success.run <- c(1,2,3,4,6,7,9)

for(r in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_may19_sm_depind15_gpols_bbig_init_bbs_inpred__jobid_',r,'.feather'))))[,3]
  dat.in.ind <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_may19_sm_depind15_gpols_bbig_init_bbs_inpred__jobid_',r,'.feather'))))[,1]

# Identify unique sample indices
unique_samples <- unique(dat.in.ind)
num_samples <- length(unique_samples)

# Initialize a vector to store the number of changes for each sample
num_changes <- numeric(num_samples)
names(num_changes) <- unique_samples

# Calculate the number of changes for each sample
for (i in 1:num_samples) {
  sample_index <- unique_samples[i]
  sample_data <- dat.in[dat.in.ind == sample_index]
  
  # Count the number of times the class changes
  changes <- sum(diff(sample_data) != 0)
  
  # Store the number of changes
  num_changes[i] <- changes
}

# Create a data frame for easier handling and visualization
changes_df <- data.frame(Sample = unique_samples, NumChanges = num_changes)


# Histogram of the number of changes
#  library(ggplot2)
# 
#  ggplot(changes_df, aes(x = NumChanges)) +
#    geom_histogram(binwidth = 1, fill = "blue", color = "black", alpha = 0.7) +
#    labs(title = "Distribution of Class Changes per Subject", x = "Number of Changes", y = "Frequency")
# }

# hist(x=changes_df$NumChanges,xlab = "Number of Changes", ylab = "Frequency", main = paste("Run", r, ": Distribution of Class Changes per Subject"))

hist_out <- hist(changes_df$NumChanges,
                 xlab = "Number of Changes",
                 ylab = "Frequency",
                 main = paste("Run", r, ": Distribution of Class Changes per Subject"),
                 col = "blue",
                 border = "black",
                 plot = FALSE)  # Prevent plotting to add customizations later

# Calculate percentages
counts <- hist_out$counts
percentages <- (counts / sum(counts)) * 100
mids <- hist_out$mids

# Plot the histogram
plot(hist_out, col = "blue", border = "black", xlab = "Number of Changes", ylab = "Frequency",
     main = paste("Run", r, ": Distribution of Class Changes per Subject"))

# Add percentage annotations
text(mids, counts, labels = paste0(round(percentages, 1), "%"), pos = 3, cex = 0.8, col = "black")
}
```

###Summary Result from BBS
```{r}
library(ggplot2)
library(tidyr)
num.it <-1000*4
runs <- c(1,2,3,4,6,7,9)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/sim_may1_sm_depind15_gpols_bbig_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }

# Assuming resdat is your dataframe
# Add a row identifier
resdat <- as.data.frame(sqrt(res.mat[2,,]))
colnames(resdat) <- 1:ncol(resdat)

#Get mean RMSE, var RMSE
RowVar <- function(x) {
  rowSums((x - rowMeans(x))^2)/(dim(x)[2] - 1)
}
RowMed <- function(x){
  apply(x,MARGIN = 1, median)
}
runs
# rowMeans((resdat))
RowMed((resdat))
RowVar((resdat))
# (resdat)[,num.it]


resdat <- as.data.frame(sqrt(res.mat[1,,]))
colnames(resdat) <- 1:ncol(resdat)
RowVar <- function(x) {
  rowSums((x - rowMeans(x))^2)/(dim(x)[2] - 1)
}
runs
# rowMeans((resdat))
RowMed((resdat))
RowVar((resdat))
# (resdat)[,num.it]

```

###Boxplot
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))

n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_train_index.csv')$x)
success.run <- c(1,2,3,4,6,7,9)

for(r in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_may19_sm_depind15_gpols_bbig_init_bbs_inpred__jobid_',r,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')

age.in <- age_tab[dat.in$id_ind,c('pred_amp','sex','DepInd','class')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$pred_amp)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('pred_amp','sex','DepInd','true_class','pred','SqError',"class")

library(ggplot2)
library(tidyr)
age.in_long <- pivot_longer(age.in, cols = c(pred_amp, sex, DepInd,true_class, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
p<- ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
print(p)
}
```






##Look at the SGLD
I am running` bayes_cal3.R`  on the first 6 runs ( the rest 4 haven't finished). The file needs an improvement. Also file is run manually, not on the job submission
It should focus on sgld result PER class
bayes_cal3.R isnot useful aggregately, need to be done run by run
maybe I should observe the class change for sgld as well to assess the effect of noise



###Meeting with Tom
Class assignment changes => look at the number of times it's in the right assighnment, but it's difficult to determine since it's latent and random. "Greedy Matching". Or just percent

26 May
[done] 1. Need to observe average width of class, I think this is by filtering
[done] 2. For latent identification, I can defind a similarity matrix by observing pair-wise similarity of the underlying covariates e.g. just summing and comparing?
  -I think just use confusion matrix. (true on the row, predicted on the columns, and observe that the column should be a single element).
  - there is also Adjusted Rand Index and Normalised mutual info, and Adjusted Mutual Info (AMI)
  - adjusted Rand seems good, no need to for correspondence of cluster. if they overlap exactly then it's 1. BUT this metric penalises oversplitting.
  - This metric has shown (and checked by looking at data) that SGLD changes class assignment from BBS
  - [mclust]`adjustedRandIndex(age.in$true_class, age.in$class)` ==> not that it is for large (equally sized)/balanced clusters
  - [mclust] see `compute_AMI` below. I think it gives very similar output to NMI below
  - [infotheo]`2*mutinformation(age.in$class,age.in$true_class)/(entropy(age.in$class)+ entropy(age.in$true_class))`
  -

```{r}
compute_AMI <- function(true_class, pred_class, num_permutations = 100) {
  # Helper function to compute the mutual information
  mi <- mutinformation(true_class, pred_class)
  # Compute the entropies
  entropy_true <- entropy(true_class)
  entropy_pred <- entropy(pred_class)
  # Compute the expected mutual information (EMI)
  # Approximate EMI using a permutation method
  expected_mi <- function(true_class, pred_class, num_permutations) {
    n <- length(true_class)
    mi_values <- numeric(num_permutations)
    for (i in 1:num_permutations) {
      permuted_pred <- sample(pred_class)
      mi_values[i] <- mutinformation(true_class, permuted_pred)
    }
    mean(mi_values)
  }
  
  emi <- expected_mi(true_class, pred_class, num_permutations)
  # Compute the Adjusted Mutual Information (AMI)
  ami <- (mi - emi) / ((entropy_true + entropy_pred) / 2 - emi)
  return(ami)
}
compute_AMI(age.in$true_class, age.in$class)
```

3. [done] we can easilty identify the lower ppi and upper ppi and mse of each class by amending the grouping code

#27 may


##Read in results from bayes_cal3: 
`summary_sim_may19_sm_depind15_gpols_bbig_init_sgld_[].csv`

```{r}
for(i in 1:10){
  print(i)
  res <- read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/summary_sim_may19_sm_depind15_gpols_bbig_init_sgld_",i,".csv" ))$x
  names(res)[1:10] <- c("inRMSE","outRMSE","inR2","outR2","in-Coverage","out-Coverage","in-PPIwidth","out-PPIwidth","inMAE","outMAE")
  print(res)
  print("---")
}
```
Let's look at 3,4,6
###Boxplot
```{r}
getmode <- function(v) {
  uniqv <- unique(v)
  uniqv[which.max(tabulate(match(v, uniqv)))]
}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))

n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_train_index.csv')$x)
success.run <- c(3,4,6)

for(r in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_may19_sm_depind15_gpols_bbig_init_sgld_inpred__jobid_',r,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test/4*1000)
  colnames(dat.in) <- c('id_ind','pred','class')
  dat.in.grouped <- dat.in %>%
    group_by(id_ind) %>%
    summarize(pred_class = getmode(class))
  dat.in.grouped <-  dat.in.grouped[order(dat.in.grouped$id_ind), ]
  dat.in <- tail(dat.in,n.test)
  dat.in <- dat.in[order(dat.in$id_ind), ]
  dat.in$class <- dat.in.grouped$pred_class

age.in <- age_tab[dat.in$id_ind,c('pred_amp','sex','DepInd','class')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$pred_amp)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('pred_amp','sex','DepInd','true_class','pred','SqError',"class")

library(ggplot2)
library(tidyr)
age.in_long <- pivot_longer(age.in, cols = c(pred_amp, sex, DepInd,true_class, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
p<- ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
print(p)
}
```

##I will load up and stack 3,4,6 since they have same number of classes
```{r}
for(i in 1:10){
  print(i)
  res <- read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/summary_sim_may19_sm_depind15_gpols_bbig_init_sgld_",i,".csv" ))$x
  names(res)[1:10] <- c("inRMSE","outRMSE","inR2","outR2","in-Coverage","out-Coverage","in-PPIwidth","out-PPIwidth","inMAE","outMAE")
  print(res)
  print("---")
}
```

```{r}
# Initialize a list to store the vectors
res_list <- lapply(c(3,4,6), function(i) {
  # Construct the file path
  file_path <- paste0("/well/nichols/users/qcv214/KGPNN/pile/summary_sim_may19_sm_depind15_gpols_bbig_init_sgld_", i, ".csv")
  
  # Read the CSV file and extract the vector (assuming the column name is 'x')
  read.csv(file_path)$x
})

# Combine the list of vectors into a dataframe
res_df <- do.call(rbind, lapply(res_list, function(x) as.data.frame(t(x))))

# If you want to retain the original vectors as rows
colnames(res_df) <- c("inRMSE","outRMSE","inR2","outR2","in-Coverage","out-Coverage","in-PPIwidth","out-PPIwidth","inMAE","outMAE", 
                      "G1", "G2", "G1-inRMSE","G2-inRMSE","G1-in-PPIwidth","G2-in-PPIwidth","G1-in-Coverage","G2-in-Coverage",
                      "G1", "G2", "G1-outRMSE","G2-outRMSE","G1-out-PPIwidth","G2-out-PPIwidth","G1-out-Coverage","G2-out-Coverage",
                      "in-Similarity","out-Similarity")

# Print the resulting dataframe
print(t(res_df))
```

```{r}
# Parameters for the original learning rate schedule
start.a <- 1e-3
start.b <- 1
start.gamma <- 1

# Parameters for the Robbins-Monro learning rate schedule
alpha_0 <- 1e-3

# Number of iterations to compare
num_iterations <- 100

# Initialize vectors to store learning rates
original_lr <- numeric(num_iterations)
robbins_monro_lr <- numeric(num_iterations)

# Calculate learning rates for each iteration
for (t in 1:num_iterations) {
  original_lr[t] <- start.a * (start.b + t)^(-start.gamma)
  robbins_monro_lr[t] <- alpha_0 / t
}

# Create a data frame for plotting
library(ggplot2)
learning_rates <- data.frame(
  Iteration = 1:num_iterations,
  Original = original_lr,
  RobbinsMonro = robbins_monro_lr
)

# Plot the learning rates
ggplot(learning_rates, aes(x = Iteration)) +
  geom_line(aes(y = Original, color = "Original")) +
  geom_line(aes(y = RobbinsMonro, color = "Robbins-Monro")) +
  labs(title = "Learning Rate Comparison",
       x = "Iteration",
       y = "Learning Rate") +
  scale_color_manual(values = c("Original" = "blue", "Robbins-Monro" = "red"),
                     name = "Learning Rate") +
  theme_minimal()
```
This shows that my new learning rate is initially greater than my original geometric lr, and they have the exact same behaviour.
it's actually 1/(1+t) [old] vs 1/t [new]




Running from sim_sm_depind15_gpols_bbig_init.R
//may28_sm_depind15_gpols_once_init 60172646 ==> no R^2 GPs, just R GPs

#29 May
##Plot param search
```{r}
library(ggplot2)
library(tidyr)

num.it <-1000*4
runs <- c(1:5,7:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/sim_may28_sm_depind15_gpols_once_init_loss__jobid_",i,".csv")))[,1:num.it]
 }

# Assuming resdat is your dataframe
# Add a row identifier
resdat <- as.data.frame(sqrt(res.mat[2,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(7,30) +
  theme_minimal() +
  labs(title = "Test RMSE", x = "iterations", y = "Value", color = "Run number")

resdat <- as.data.frame(sqrt(res.mat[1,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(0,40) +
  theme_minimal() +
  labs(title = "Train RMSE",x = "iterations", y = "Value", color = "Run number")
```


Running 
//may28_sm_depind15_gpols_once_init_bbs 60257604
may28_sm_depind15_gpols_once_init_sgld 60296931

##plot bbs result
```{r}
library(ggplot2)
library(tidyr)

num.it <-1000*4
runs <- c(1:5,7:8)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/sim_may28_sm_depind15_gpols_once_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }

# Assuming resdat is your dataframe
# Add a row identifier
resdat <- as.data.frame(sqrt(res.mat[2,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(7,100) +
  theme_minimal() +
  labs(title = "Test RMSE", x = "iterations", y = "Value", color = "Run number")

```

```{r}
resdat <- as.data.frame(sqrt(res.mat[1,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(0,100) +
  theme_minimal() +
  labs(title = "Train RMSE",x = "iterations", y = "Value", color = "Run number")
```

###Summary Result from BBS
```{r}
library(ggplot2)
library(tidyr)
num.it <-1000*4
runs <-  c(1:5,7:8)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/sim_may28_sm_depind15_gpols_once_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }

# Assuming resdat is your dataframe
# Add a row identifier
resdat <- as.data.frame(sqrt(res.mat[2,,]))
colnames(resdat) <- 1:ncol(resdat)

#Get mean RMSE, var RMSE
RowVar <- function(x) {
  rowSums((x - rowMeans(x))^2)/(dim(x)[2] - 1)
}
RowMed <- function(x){
  apply(x,MARGIN = 1, median)
}
runs
rowMeans((resdat))
RowMed((resdat))
RowVar((resdat))
(resdat)[,num.it]


resdat <- as.data.frame(sqrt(res.mat[1,,]))
colnames(resdat) <- 1:ncol(resdat)
RowVar <- function(x) {
  rowSums((x - rowMeans(x))^2)/(dim(x)[2] - 1)
}
runs
rowMeans((resdat))
RowMed((resdat))
RowVar((resdat))
(resdat)[,num.it]

```
Run number 8 has an incredible result, the rest are meh


##SGLD
`summary_sim_may28_sm_depind15_gpols_once_init_sgld_[].csv`

```{r}
for(i in c(1:5,7:10)){
  print(i)
  res <- read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/summary_sim_may28_sm_depind15_gpols_once_init_sgld_",i,".csv" ))$x
  names(res) <-  c("inRMSE","outRMSE","inR2","outR2","in-Coverage","out-Coverage","in-PPIwidth","out-PPIwidth","inMAE","outMAE", 
                      "G1", "G2", "G1-inRMSE","G2-inRMSE","G1-in-PPIwidth","G2-in-PPIwidth","G1-in-Coverage","G2-in-Coverage",
                      "G1", "G2", "G1-outRMSE","G2-outRMSE","G1-out-PPIwidth","G2-out-PPIwidth","G1-out-Coverage","G2-out-Coverage",
                      "in-Similarity","out-Similarity")
  print(res)
  print("---")
}
```

Let's look at 5,7,8,10 ==> 3 classes
```{r}
getmode <- function(v) {
  uniqv <- unique(v)
  uniqv[which.max(tabulate(match(v, uniqv)))]
}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))

n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_train_index.csv')$x)
success.run <- c(5,7,8,10)

for(r in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_may28_sm_depind15_gpols_once_init_sgld_inpred__jobid_',r,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test/4*1000)
  colnames(dat.in) <- c('id_ind','pred','class')
  dat.in.grouped <- dat.in %>%
    group_by(id_ind) %>%
    summarize(pred_class = getmode(class))
  dat.in.grouped <-  dat.in.grouped[order(dat.in.grouped$id_ind), ]
  dat.in <- tail(dat.in,n.test)
  dat.in <- dat.in[order(dat.in$id_ind), ]
  dat.in$class <- dat.in.grouped$pred_class

age.in <- age_tab[dat.in$id_ind,c('pred_amp','sex','DepInd','class')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$pred_amp)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('pred_amp','sex','DepInd','true_class','pred','SqError',"class")

library(ggplot2)
library(tidyr)
age.in_long <- pivot_longer(age.in, cols = c(pred_amp, sex, DepInd,true_class, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
p<- ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
print(p)
}
```
5 - Female low ind vs Male low ind vs High ind
7 - Low ind vs Male high ind vs Female high ind
8 - True classes
10 - Female high ind vs Male vs female low ind
```{r}
# Initialize a list to store the vectors
res_list <- lapply(c(5,7,8,10), function(i) {
  # Construct the file path
  file_path <- paste0("/well/nichols/users/qcv214/KGPNN/pile/summary_sim_may28_sm_depind15_gpols_once_init_sgld_", i, ".csv")
  
  # Read the CSV file and extract the vector (assuming the column name is 'x')
  read.csv(file_path)$x
})

# Combine the list of vectors into a dataframe
res_df <- do.call(rbind, lapply(res_list, function(x) as.data.frame(t(x))))

# If you want to retain the original vectors as rows
colnames(res_df) <- c("inRMSE","outRMSE","inR2","outR2","in-Coverage","out-Coverage","in-PPIwidth","out-PPIwidth","inMAE","outMAE", 
                      "G1", "G2","G3", "G1-inRMSE","G2-inRMSE","G3-inRMSE","G1-in-PPIwidth","G2-in-PPIwidth","G3-in-PPIwidth","G1-in-Coverage","G2-in-Coverage","G3-in-Coverage",
                      "G1", "G2","G3", "G1-outRMSE","G2-outRMSE","G3-outRMSE","G1-out-PPIwidth","G2-out-PPIwidth","G3-out-PPIwidth","G1-out-Coverage","G2-out-Coverage","G3-out-Coverage",
                      "in-Similarity","out-Similarity")

# Print the resulting dataframe
print(t(res_df))
```

Look at the out-coverage, especially G2, it's very interesting. Note that Male-High-Dep is most challegning to model
For run 7 G2, out coverage is 69.5% but it could actually detect the Male-High dep correctly though.
For run 5 G2, out-coverage is 90%, this is a class of high dep
For run 8 G3, out-cov is 94%, this is male-high-dep

let me try lowering the injected noise.
//may30_sm_depind15_gpols_once_init_sgld 60424372 => learning rate of 1e-8 (previously was 1e-6)
##Look at SGLD result with lower lr
```{r}
for(i in c(1:5,7:10)){
  print(i)
  res <- read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/summary_sim_may30_sm_depind15_gpols_once_init_sgld_",i,".csv" ))$x
  names(res) <-  c("inRMSE","outRMSE","inR2","outR2","in-Coverage","out-Coverage","in-PPIwidth","out-PPIwidth","inMAE","outMAE", 
                      "G1", "G2", "G1-inRMSE","G2-inRMSE","G1-in-PPIwidth","G2-in-PPIwidth","G1-in-Coverage","G2-in-Coverage",
                      "G1", "G2", "G1-outRMSE","G2-outRMSE","G1-out-PPIwidth","G2-out-PPIwidth","G1-out-Coverage","G2-out-Coverage",
                      "in-Similarity","out-Similarity")
  print(res)
  print("---")
}
```
let's again look at 5,7,8,10

Let's look at 5,7,8,10 ==> 3 classes
```{r}
getmode <- function(v) {
  uniqv <- unique(v)
  uniqv[which.max(tabulate(match(v, uniqv)))]
}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))

n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_train_index.csv')$x)
success.run <- c(5,7,8,10)

for(r in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_may30_sm_depind15_gpols_once_init_sgld_inpred__jobid_',r,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test/4*1000)
  colnames(dat.in) <- c('id_ind','pred','class')
  dat.in.grouped <- dat.in %>%
    group_by(id_ind) %>%
    summarize(pred_class = getmode(class))
  dat.in.grouped <-  dat.in.grouped[order(dat.in.grouped$id_ind), ]
  dat.in <- tail(dat.in,n.test)
  dat.in <- dat.in[order(dat.in$id_ind), ]
  dat.in$class <- dat.in.grouped$pred_class

age.in <- age_tab[dat.in$id_ind,c('pred_amp','sex','DepInd','class')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$pred_amp)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('pred_amp','sex','DepInd','true_class','pred','SqError',"class")

library(ggplot2)
library(tidyr)
age.in_long <- pivot_longer(age.in, cols = c(pred_amp, sex, DepInd,true_class, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
p<- ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
print(p)
}
```
5 - Female low ind vs Male low ind vs High ind
7 - Low ind vs Male high ind vs Female high ind
8 - True classes
10 - Female high ind vs Male vs female low ind
Note that this is the exact same as previous.

```{r}
# Initialize a list to store the vectors
res_list <- lapply(c(5,7,8,10), function(i) {
  # Construct the file path
  file_path <- paste0("/well/nichols/users/qcv214/KGPNN/pile/summary_sim_may30_sm_depind15_gpols_once_init_sgld_", i, ".csv")
  
  # Read the CSV file and extract the vector (assuming the column name is 'x')
  read.csv(file_path)$x
})

# Combine the list of vectors into a dataframe
res_df <- do.call(rbind, lapply(res_list, function(x) as.data.frame(t(x))))

# If you want to retain the original vectors as rows
colnames(res_df) <- c("inRMSE","outRMSE","inR2","outR2","in-Coverage","out-Coverage","in-PPIwidth","out-PPIwidth","inMAE","outMAE", 
                      "G1", "G2","G3", "G1-inRMSE","G2-inRMSE","G3-inRMSE","G1-in-PPIwidth","G2-in-PPIwidth","G3-in-PPIwidth","G1-in-Coverage","G2-in-Coverage","G3-in-Coverage",
                      "G1", "G2","G3", "G1-outRMSE","G2-outRMSE","G3-outRMSE","G1-out-PPIwidth","G2-out-PPIwidth","G3-out-PPIwidth","G1-out-Coverage","G2-out-Coverage","G3-out-Coverage",
                      "in-Similarity","out-Similarity")

# Print the resulting dataframe
print(t(res_df))
```


#1 June
Increasing deg of expansion
Currently running
//june1_sm_depind15_gpols_once_init  61132100 ==> 30 deg 

##Plot param search
```{r}
library(ggplot2)
library(tidyr)

num.it <-1000*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/sim_june1_sm_depind15_gpols_once_init_loss__jobid_",i,".csv")))[,1:num.it]
 }

# Assuming resdat is your dataframe
# Add a row identifier
resdat <- as.data.frame(sqrt(res.mat[2,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(7,30) +
  theme_minimal() +
  labs(title = "Test RMSE", x = "iterations", y = "Value", color = "Run number")

resdat <- as.data.frame(sqrt(res.mat[1,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(0,40) +
  theme_minimal() +
  labs(title = "Train RMSE",x = "iterations", y = "Value", color = "Run number")
```


//june1_sm_depind15_gpols_once_init_bbs 61350671
//[all but run 5 finished] june1_sm_depind15_gpols_once_init_sgld 61350434

##plot bbs result
```{r}
library(ggplot2)
library(tidyr)

num.it <-1000*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/sim_june1_sm_depind15_gpols_once_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }

# Assuming resdat is your dataframe
# Add a row identifier
resdat <- as.data.frame(sqrt(res.mat[2,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(7,100) +
  theme_minimal() +
  labs(title = "Test RMSE", x = "iterations", y = "Value", color = "Run number")

resdat <- as.data.frame(sqrt(res.mat[1,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(0,100) +
  theme_minimal() +
  labs(title = "Train RMSE",x = "iterations", y = "Value", color = "Run number")
```
###Summary Result from BBS
```{r}
library(ggplot2)
library(tidyr)
num.it <-1000*4
runs <-  c(1:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/sim_june1_sm_depind15_gpols_once_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }

# Assuming resdat is your dataframe
# Add a row identifier
resdat <- as.data.frame(sqrt(res.mat[2,,]))
colnames(resdat) <- 1:ncol(resdat)

#Get mean RMSE, var RMSE
RowVar <- function(x) {
  rowSums((x - rowMeans(x))^2)/(dim(x)[2] - 1)
}
RowMed <- function(x){
  apply(x,MARGIN = 1, median)
}
runs
# rowMeans((resdat))
RowMed((resdat))
RowVar((resdat))
# (resdat)[,num.it]


resdat <- as.data.frame(sqrt(res.mat[1,,]))
colnames(resdat) <- 1:ncol(resdat)
RowVar <- function(x) {
  rowSums((x - rowMeans(x))^2)/(dim(x)[2] - 1)
}
runs
# rowMeans((resdat))
RowMed((resdat))
RowVar((resdat))
# (resdat)[,num.it]

```

##getting sgld results
```{r}
for(i in c(1:4,6:10)){
  print(i)
  res <- read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/summary_sim_june1_sm_depind15_gpols_once_init_sgld_",i,".csv" ))$x
  names(res) <-  c("inRMSE","outRMSE","inR2","outR2","in-Coverage","out-Coverage","in-PPIwidth","out-PPIwidth","inMAE","outMAE", 
                      "G1", "G2", "G1-inRMSE","G2-inRMSE","G1-in-PPIwidth","G2-in-PPIwidth","G1-in-Coverage","G2-in-Coverage",
                      "G1", "G2", "G1-outRMSE","G2-outRMSE","G1-out-PPIwidth","G2-out-PPIwidth","G1-out-Coverage","G2-out-Coverage",
                      "in-Similarity","out-Similarity")
  print(res)
  print("---")
}
```
Let's look at the one that split between 3 classes to compare to previous result [1,2,4,8,9,10]

```{r}
getmode <- function(v) {
  uniqv <- unique(v)
  uniqv[which.max(tabulate(match(v, uniqv)))]
}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/sim15_age.feather'))

n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sim15_train_index.csv')$x)
success.run <- c(1,2,4,8,9,10)

for(r in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/sim_june1_sm_depind15_gpols_once_init_sgld_inpred__jobid_',r,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test/4*1000)
  colnames(dat.in) <- c('id_ind','pred','class')
  dat.in.grouped <- dat.in %>%
    group_by(id_ind) %>%
    summarize(pred_class = getmode(class))
  dat.in.grouped <-  dat.in.grouped[order(dat.in.grouped$id_ind), ]
  dat.in <- tail(dat.in,n.test)
  dat.in <- dat.in[order(dat.in$id_ind), ]
  dat.in$class <- dat.in.grouped$pred_class

age.in <- age_tab[dat.in$id_ind,c('pred_amp','sex','DepInd','class')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$pred_amp)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('pred_amp','sex','DepInd','true_class','pred','SqError',"class")

library(ggplot2)
library(tidyr)
age.in_long <- pivot_longer(age.in, cols = c(pred_amp, sex, DepInd,true_class, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
p<- ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
print(p)
}
```
1- f-hd,ld, m-hd [coincide with prev 7]
2- m-ld, hd, f-ld [coincide with prev 5]
4- f-hd, f-lw, m [coincide with prev 10]
8- m, f-hd, f-ld [coincide with prev 10]
9- ld, m-hd, f-hd [coincide with prev 7]
10- m, f-hd, f-ld [coincide with prev 10]

prev:
    5 - Female low ind vs Male low ind vs High ind
    7 - Low ind vs Male high ind vs Female high ind
    8 - True classes
    10 - Female high ind vs Male vs female low ind

I'll arbitarily pick 1,2,4 to compare

```{r}
# Initialize a list to store the vectors
res_list <- lapply(c(1,2,4), function(i) {
  # Construct the file path
  file_path <- paste0("/well/nichols/users/qcv214/KGPNN/pile/summary_sim_june1_sm_depind15_gpols_once_init_sgld_", i, ".csv")
  
  # Read the CSV file and extract the vector (assuming the column name is 'x')
  read.csv(file_path)$x
})

# Combine the list of vectors into a dataframe
res_df <- do.call(rbind, lapply(res_list, function(x) as.data.frame(t(x))))

# If you want to retain the original vectors as rows
colnames(res_df) <- c("inRMSE","outRMSE","inR2","outR2","in-Coverage","out-Coverage","in-PPIwidth","out-PPIwidth","inMAE","outMAE", 
                      "G1", "G2","G3", "G1-inRMSE","G2-inRMSE","G3-inRMSE","G1-in-PPIwidth","G2-in-PPIwidth","G3-in-PPIwidth","G1-in-Coverage","G2-in-Coverage","G3-in-Coverage",
                      "G1", "G2","G3", "G1-outRMSE","G2-outRMSE","G3-outRMSE","G1-out-PPIwidth","G2-out-PPIwidth","G3-out-PPIwidth","G1-out-Coverage","G2-out-Coverage","G3-out-Coverage",
                      "in-Similarity","out-Similarity")

# Print the resulting dataframe
print(t(res_df))
```

I have no comments on interpretation


#5 June

Need to do -> extend model to full data, changing the binary covariates to continuous. Note that previously I was dividing into 10 dep ind group, let's continue with this.
Apply the model to real data

Running 
//june6_sm_depind15_gpols_once_init_test. 62377736 ==>only with deg = 2 to test
//june6_sm_depind15_gpols_once_init. 62381358  ==> deg = 30, took over a day

Running
//june6_sm_depind15_gpols_once_init_bbs 62558941
//june6_sm_depind15_gpols_once_init_sgld 62559006 

##plot bbs result
```{r}
library(ggplot2)
library(tidyr)

num.it <-500*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_june6_sm_depind_gpols_once_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }

# Assuming resdat is your dataframe
# Add a row identifier
resdat <- as.data.frame(sqrt(res.mat[2,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(2.5,10) +
  theme_minimal() +
  labs(title = "Test RMSE", x = "iterations", y = "Value", color = "Run number")

resdat <- as.data.frame(sqrt(res.mat[1,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(0,10) +
  theme_minimal() +
  labs(title = "Train RMSE",x = "iterations", y = "Value", color = "Run number")
```
I will compare to ridge

```{r}
#ridge
runs.hs <- 1:10
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_dec19_ridge_decind_noscale_",i,".csv"))))
}
(hs.train <- quantile(hs.int[,1],c(0.25,0.5,0.75)))
(hs.test <-quantile(hs.int[,3],c(0.25,0.5,0.75)))

(hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75)))
(hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75)))

```
```{r}
library(ggplot2)
library(tidyr)

num.it <-500*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_june6_sm_depind_gpols_once_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }

# Assuming resdat is your dataframe
# Add a row identifier
resdat <- as.data.frame(sqrt(res.mat[2,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  geom_hline(aes(yintercept = 4.59, color = "Imaging-ridge"), linetype = "dashed", size = 1) +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(2.5,10) +
  theme_minimal() +
  labs(title = "Test RMSE", x = "iterations", y = "Value", color = "Run number") 

resdat <- as.data.frame(sqrt(res.mat[1,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  geom_hline(aes(yintercept = 0.9, color = "Imaging-ridge"), linetype = "dashed", size = 1) +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(0,10) +
  theme_minimal() +
  labs(title = "Train RMSE",x = "iterations", y = "Value", color = "Run number")
```
###Boxplot
```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat_depind.feather'))

n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sex_train_index.csv')$x)
success.run <- 1:10

for(r in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_june6_sm_depind_gpols_once_init_bbs_inpred__jobid_',r,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test)
  colnames(dat.in) <- c('id_ind','pred','class')

age.in <- age_tab[dat.in$id_ind,c('age','sex','DepInd')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$age)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('age','sex','DepInd','pred','SqError',"class")

library(ggplot2)
library(tidyr)
age.in_long <- pivot_longer(age.in, cols = c(age, sex, DepInd, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
p<- ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
print(p)
}
```

```{r}
library(dplyr)
library(ggplot2)
library(tidyr)
library(feather)  # Ensure this package is installed for reading feather files

# Load the age and sex stratified data
age_tab <- as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat_depind.feather'))

# Load the number of test cases
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sex_train_index.csv')$x)
success.run <- 1:10

for (r in success.run) {
  # Load and process data
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_june6_sm_depind_gpols_once_init_bbs_inpred__jobid_', r, '.feather'))))[, c(1:3)]
  dat.in <- tail(dat.in, n.test)
  colnames(dat.in) <- c('id_ind', 'pred', 'class')
  
  # Merge with age and sex information
  age.in <- age_tab[dat.in$id_ind, c('age', 'sex', 'DepInd')]
  age.in <- cbind(age.in, dat.in$pred, (dat.in$pred - age.in$age)^2, as.factor(dat.in$class))
  colnames(age.in) <- c('age', 'sex', 'DepInd', 'pred', 'SqError', 'class')
  
  # Calculate class sizes
  class_sizes <- age.in %>%
    group_by(class) %>%
    summarise(count = n())
  
  # Create a named vector for custom labels
  class_labels <- paste0(class_sizes$class, " (n=", class_sizes$count, ")")
  names(class_labels) <- class_sizes$class
  
  # Reshape the data for plotting
  age.in_long <- pivot_longer(age.in, cols = c(age, sex, DepInd, pred, SqError), names_to = "variable", values_to = "value")
  
  # Create the boxplot with class sizes in the legend
  p <- ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
    geom_boxplot() +
    facet_wrap(~ variable, scales = "free") +
    theme_minimal() +
    labs(title = paste("Boxplot of Age, Sex, and DepInd, Labeled by Class for Run", r),
         x = "Class",
         y = "Value") +
    scale_fill_discrete(labels = class_labels)
  
  print(p)
}
```

```{r}
library(dplyr)
library(ggplot2)
library(tidyr)
library(feather)  # Ensure this package is installed for reading feather files

# Load the age and sex stratified data
age_tab <- as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat_depind.feather'))

# Load the number of test cases
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sex_train_index.csv')$x)
success.run <- 1:10

for (r in success.run) {
  # Load and process data
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_june6_sm_depind_gpols_once_init_bbs_inpred__jobid_', r, '.feather'))))[, c(1:3)]
  dat.in <- tail(dat.in, n.test)
  colnames(dat.in) <- c('id_ind', 'pred', 'class')
  
  # Merge with age and sex information
  age.in <- age_tab[dat.in$id_ind, c('age', 'sex', 'DepInd')]
  age.in <- cbind(age.in, dat.in$pred, (dat.in$pred - age.in$age)^2, as.factor(dat.in$class))
  colnames(age.in) <- c('age', 'sex', 'DepInd', 'pred', 'SqError', 'class')
  
  # Calculate class sizes
  class_sizes <- age.in %>%
    group_by(class) %>%
    summarise(count = n())
  
  # Create a named vector for custom labels
  class_labels <- paste0(class_sizes$class, " (n=", class_sizes$count, ")")
  names(class_labels) <- class_sizes$class
  
  # Reshape the data for plotting
  age.in_long <- pivot_longer(age.in, cols = c(age, sex, DepInd, pred, SqError), names_to = "variable", values_to = "value")
  
  # Calculate the mean for each class and variable
  means <- age.in_long %>%
    group_by(class, variable) %>%
    summarise(mean_value = mean(value, na.rm = TRUE))
  
  # Create the boxplot with class sizes in the legend
  p <- ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
    geom_boxplot() +
    facet_wrap(~ variable, scales = "free") +
    theme_minimal() +
    labs(title = paste("Boxplot of Age, Sex, and DepInd, Labeled by Class for Run", r),
         x = "Class",
         y = "Value") +
    scale_fill_discrete(labels = class_labels) +
    # Add mean annotations
    geom_text(data = means, aes(label = sprintf("%.2f", mean_value), y = mean_value), 
              position = position_dodge(width = 0.75), vjust = -0.5, color = "black", size = 3)
  
  print(p)
}
```
####Held out data
```{r}
library(dplyr)
library(ggplot2)
library(tidyr)
library(feather)  # Ensure this package is installed for reading feather files

# Load the age and sex stratified data
age_tab <- as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat_depind.feather'))

# Load the number of test cases
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sex_test_index.csv')$x)
success.run <- 1:10

for (r in success.run) {
  # Load and process data
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_june6_sm_depind_gpols_once_init_bbs_outpred__jobid_', r, '.feather'))))[, c(1:3)]
  dat.in <- tail(dat.in, n.test)
  colnames(dat.in) <- c('id_ind', 'pred', 'class')
  
  # Merge with age and sex information
  age.in <- age_tab[dat.in$id_ind, c('age', 'sex', 'DepInd')]
  age.in <- cbind(age.in, dat.in$pred, (dat.in$pred - age.in$age)^2, as.factor(dat.in$class))
  colnames(age.in) <- c('age', 'sex', 'DepInd', 'pred', 'SqError', 'class')
  
  # Calculate class sizes
  class_sizes <- age.in %>%
    group_by(class) %>%
    summarise(count = n())
  
  # Create a named vector for custom labels
  class_labels <- paste0(class_sizes$class, " (n=", class_sizes$count, ")")
  names(class_labels) <- class_sizes$class
  
  # Reshape the data for plotting
  age.in_long <- pivot_longer(age.in, cols = c(age, sex, DepInd, pred, SqError), names_to = "variable", values_to = "value")
  
  # Calculate the mean for each class and variable
  means <- age.in_long %>%
    group_by(class, variable) %>%
    summarise(mean_value = mean(value, na.rm = TRUE))
  
  # Create the boxplot with class sizes in the legend
  p <- ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
    geom_boxplot() +
    facet_wrap(~ variable, scales = "free") +
    theme_minimal() +
    labs(title = paste("Boxplot of Age, Sex, and DepInd, Labeled by Class for Run", r),
         x = "Class",
         y = "Value") +
    scale_fill_discrete(labels = class_labels) +
    # Add mean annotations
    geom_text(data = means, aes(label = sprintf("%.2f", mean_value), y = mean_value), 
              position = position_dodge(width = 0.75), vjust = -0.5, color = "black", size = 3)
  
  print(p)
}
```

Let's focus on run 1,7,8
```{r}
library(ggplot2)
library(tidyr)

num.it <-500*4
runs <- c(1,7,8)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_june6_sm_depind_gpols_once_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }

# Assuming resdat is your dataframe
# Add a row identifier
resdat <- as.data.frame(sqrt(res.mat[2,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  geom_hline(aes(yintercept = 4.59, color = "Imaging-ridge"), linetype = "dashed", size = 1) +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(2.5,10) +
  theme_minimal() +
  labs(title = "Test RMSE", x = "iterations", y = "Value", color = "Run number") 

resdat <- as.data.frame(sqrt(res.mat[1,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  geom_hline(aes(yintercept = 0.9, color = "Imaging-ridge"), linetype = "dashed", size = 1) +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(0,10) +
  theme_minimal() +
  labs(title = "Train RMSE",x = "iterations", y = "Value", color = "Run number")
```


##SGLD results
###getting sgld results
```{r}
for(i in c(1:10)){
  print(i)
  res <- read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/summary_re_june6_sm_depind_gpols_once_init_sgld_",i,".csv" ))$x
  names(res) <-  c("inRMSE","outRMSE","inR2","outR2","in-Coverage","out-Coverage","in-PPIwidth","out-PPIwidth","inMAE","outMAE", "G1", "G2")
  print(res)
  print("---")
}
```
Let's look at [3],4,6,9
```{r}
getmode <- function(v) {
  uniqv <- unique(v)
  uniqv[which.max(tabulate(match(v, uniqv)))]
}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat_depind.feather'))

n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sex_train_index.csv')$x)
success.run <- c(3,4,6,9)

for(r in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_june6_sm_depind15_gpols_once_init_sgld_inpred__jobid_',r,'.feather'))))[,c(1:3)]
  dat.in <- tail(dat.in,n.test/4*1000)
  colnames(dat.in) <- c('id_ind','pred','class')
  dat.in.grouped <- dat.in %>%
    group_by(id_ind) %>%
    summarize(pred_class = getmode(class))
  dat.in.grouped <-  dat.in.grouped[order(dat.in.grouped$id_ind), ]
  dat.in <- tail(dat.in,n.test)
  dat.in <- dat.in[order(dat.in$id_ind), ]
  dat.in$class <- dat.in.grouped$pred_class

age.in <- age_tab[dat.in$id_ind,c('age','sex','DepInd')]
age.in <- cbind(age.in,dat.in$pred, (dat.in$pred - age.in$age)^2 ,as.factor(dat.in$class))
colnames(age.in) <- c('age','sex','DepInd','pred','SqError',"class")

library(ggplot2)
library(tidyr)
age.in_long <- pivot_longer(age.in, cols = c(age, sex, DepInd, pred, SqError), names_to = "variable", values_to = "value")

# Create the boxplot for each variable, labeled by class
p<- ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Boxplot of Age, Sex, and DepInd, Labeled by Class",
       x = "Class",
       y = "Value")
print(p)
}
```
```{r}
for(i in c(4,6,9,7)){
  print(i)
  res <- read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/summary_re_june6_sm_depind_gpols_once_init_sgld_",i,".csv" ))$x
  names(res) <-  c("inRMSE","outRMSE","inR2","outR2","in-Coverage","out-Coverage","in-PPIwidth","out-PPIwidth","inMAE","outMAE", "G1", "G2")
  print(res)
  print("---")
}
```

```{r}
for(i in c(4,9,7)){
  print(i)
  res <- read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/summary_re_june6_sm_depind_gpols_once_init_sgld_",i,".csv" ))$x[c(1:8,26:34)]
  names(res) <-  c("Overall-inRMSE","Overall-outRMSE","Overall-inR2","Overall-outR2","in-Coverage","out-Coverage","in-PPIwidth","out-PPIwidth",
                   "G1-outRMSE", "G2-outRMSE","G3-outRMSE",
                   "G1-out-PPIwidth", "G2-out-PPIwidth","G3-out-PPIwidth",
                   "G1-out-Coverage", "G2-out-Coverage","G3-out-Coverage")
  print(res[1:4])
  print(res[5:8])
  print(res[9:11])
  print(res[12:14])
  print(res[15:17])
  print("---")
}
```
```{r}
for(i in c(6)){
  print(i)
  res <- read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/summary_re_june6_sm_depind_gpols_once_init_sgld_",i,".csv" ))$x[c(1:8,31:42)]
  names(res) <-  c("Overall-inRMSE","Overall-outRMSE","Overall-inR2","Overall-outR2","in-Coverage","out-Coverage","in-PPIwidth","out-PPIwidth",
                   "G1-outRMSE", "G2-outRMSE","G3-outRMSE","G4-outRMSE",
                   "G1-out-PPIwidth", "G2-out-PPIwidth","G3-out-PPIwidth","G4-out-PPIwidth",
                   "G1-out-Coverage", "G2-out-Coverage","G3-out-Coverage","G4-out-Coverage")
  #print(res)
  print(res[1:4])
  print(res[5:8])
  print(res[9:12])
  print(res[13:16])
  print(res[17:20])
  print("---")
}
```


To Tom
1. Get class assignment sizes
2. Start point estimate, dont do SGLD, do boxplots and class splitting for optimisation

#13 June
Running
re_june13_sm_depind_gpols_once_init => change number of subclasses from 4 to 10 , and param search from 1000 to 500

##param search
```{r}
library(ggplot2)
library(tidyr)

num.it <-500*4
runs <- c(1:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_june13_sm_depind_gpols_once_init_loss__jobid_",i,".csv")))[,1:num.it]
 }

# Assuming resdat is your dataframe
# Add a row identifier
resdat <- as.data.frame(sqrt(res.mat[2,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(4,10) +
  theme_minimal() +
  labs(title = "Test RMSE", x = "iterations", y = "Value", color = "Run number")

resdat <- as.data.frame(sqrt(res.mat[1,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(1,6) +
  theme_minimal() +
  labs(title = "Train RMSE",x = "iterations", y = "Value", color = "Run number")
```
###Compare param search to previous
```{r}
library(ggplot2)
library(tidyr)

num.it <-500*4
runs <- c(1:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_june6_sm_depind15_gpols_once_init_loss__jobid_",i,".csv")))[,1:num.it]
 }

# Assuming resdat is your dataframe
# Add a row identifier
resdat <- as.data.frame(sqrt(res.mat[2,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(4,10) +
  theme_minimal() +
  labs(title = "Test RMSE", x = "iterations", y = "Value", color = "Run number")

resdat <- as.data.frame(sqrt(res.mat[1,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(1,6) +
  theme_minimal() +
  labs(title = "Train RMSE",x = "iterations", y = "Value", color = "Run number")
```


this is bad... let's run bbs?

[Over time limit] june13_sm_depind_gpols_once_init_bbs 63808175 =>1k epochs
//june13_sm_depind15_gpols_once_init_sgld 63808159

##
```{r}
library(ggplot2)
library(tidyr)

num.it <- 500*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_june13_sm_depind_gpols_once_init_sgld_loss__jobid_",i,".csv")))[,1:num.it]
 }

# Assuming resdat is your dataframe
# Add a row identifier
resdat <- as.data.frame(sqrt(res.mat[2,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  geom_hline(aes(yintercept = 4.59, color = "Imaging-ridge"), linetype = "dashed", size = 1) +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(2.5,10) +
  theme_minimal() +
  labs(title = "Test RMSE", x = "iterations", y = "Value", color = "Run number") 

resdat <- as.data.frame(sqrt(res.mat[1,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  geom_hline(aes(yintercept = 0.9, color = "Imaging-ridge"), linetype = "dashed", size = 1) +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(0,10) +
  theme_minimal() +
  labs(title = "Train RMSE",x = "iterations", y = "Value", color = "Run number")
```
##SGLD results
###getting sgld results
```{r}
for(i in c(1:10)){
  print(i)
  res <- read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/summary_re_june13_sm_depind_gpols_once_init_sgld_",i,".csv" ))$x
  names(res) <-  c("inRMSE","outRMSE","inR2","outR2","in-Coverage","out-Coverage","in-PPIwidth","out-PPIwidth","inMAE","outMAE", "G1", "G2")
  print(res)
  print("---")
}
```
There are clear distinctions between good and bad runs
Let's look at 7,9,10

Held-in
```{r}
getmode <- function(v) {
  uniqv <- unique(v)
  uniqv[which.max(tabulate(match(v, uniqv)))]
}
age_tab <- as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat_depind.feather'))

# Load the number of test cases
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sex_train_index.csv')$x)
success.run <- c(7,9,10)

for(r in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_june13_sm_depind_gpols_once_init_sgld_inpred__jobid_', r, '.feather'))))[, c(1:3)]
  dat.in <- tail(dat.in,n.test/4*1000)
  colnames(dat.in) <- c('id_ind','pred','class')
  dat.in.grouped <- dat.in %>%
    group_by(id_ind) %>%
    summarize(pred_class = getmode(class))
  dat.in.grouped <-  dat.in.grouped[order(dat.in.grouped$id_ind), ]
  dat.in <- tail(dat.in,n.test)
  dat.in <- dat.in[order(dat.in$id_ind), ]
  dat.in$class <- dat.in.grouped$pred_class

# Merge with age and sex information
  age.in <- age_tab[dat.in$id_ind, c('age', 'sex', 'DepInd')]
  age.in <- cbind(age.in, dat.in$pred, (dat.in$pred - age.in$age)^2, as.factor(dat.in$class))
  colnames(age.in) <- c('age', 'sex', 'DepInd', 'pred', 'SqError', 'class')
  
  # Calculate class sizes
  class_sizes <- age.in %>%
    group_by(class) %>%
    summarise(count = n())
  
  # Create a named vector for custom labels
  class_labels <- paste0(class_sizes$class, " (n=", class_sizes$count, ")")
  names(class_labels) <- class_sizes$class
  
  # Reshape the data for plotting
  age.in_long <- pivot_longer(age.in, cols = c(age, sex, DepInd, pred, SqError), names_to = "variable", values_to = "value")
  
  # Calculate the mean for each class and variable
  means <- age.in_long %>%
    group_by(class, variable) %>%
    summarise(mean_value = mean(value, na.rm = TRUE))
  
  # Create the boxplot with class sizes in the legend
  p <- ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
    geom_boxplot() +
    facet_wrap(~ variable, scales = "free") +
    theme_minimal() +
    labs(title = paste("Boxplot of Age, Sex, and DepInd, Labeled by Class for Run", r),
         x = "Class",
         y = "Value") +
    scale_fill_discrete(labels = class_labels) +
    # Add mean annotations
    geom_text(data = means, aes(label = sprintf("%.2f", mean_value), y = mean_value), 
              position = position_dodge(width = 0.75), vjust = -0.5, color = "black", size = 3)
  
  print(p)
}
```

Held-out
```{r}
getmode <- function(v) {
  uniqv <- unique(v)
  uniqv[which.max(tabulate(match(v, uniqv)))]
}
age_tab <- as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat_depind.feather'))

# Load the number of test cases
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sex_test_index.csv')$x)
success.run <- c(7,9,10)

for(r in success.run){
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_june13_sm_depind_gpols_once_init_sgld_outpred__jobid_', r, '.feather'))))[, c(1:3)]
  dat.in <- tail(dat.in,n.test/4*1000)
  colnames(dat.in) <- c('id_ind','pred','class')
  dat.in.grouped <- dat.in %>%
    group_by(id_ind) %>%
    summarize(pred_class = getmode(class))
  dat.in.grouped <-  dat.in.grouped[order(dat.in.grouped$id_ind), ]
  dat.in <- tail(dat.in,n.test)
  dat.in <- dat.in[order(dat.in$id_ind), ]
  dat.in$class <- dat.in.grouped$pred_class

# Merge with age and sex information
  age.in <- age_tab[dat.in$id_ind, c('age', 'sex', 'DepInd')]
  age.in <- cbind(age.in, dat.in$pred, (dat.in$pred - age.in$age)^2, as.factor(dat.in$class))
  colnames(age.in) <- c('age', 'sex', 'DepInd', 'pred', 'SqError', 'class')
  
  # Calculate class sizes
  class_sizes <- age.in %>%
    group_by(class) %>%
    summarise(count = n())
  
  # Create a named vector for custom labels
  class_labels <- paste0(class_sizes$class, " (n=", class_sizes$count, ")")
  names(class_labels) <- class_sizes$class
  
  # Reshape the data for plotting
  age.in_long <- pivot_longer(age.in, cols = c(age, sex, DepInd, pred, SqError), names_to = "variable", values_to = "value")
  
  # Calculate the mean for each class and variable
  means <- age.in_long %>%
    group_by(class, variable) %>%
    summarise(mean_value = mean(value, na.rm = TRUE))
  
  # Create the boxplot with class sizes in the legend
  p <- ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
    geom_boxplot() +
    facet_wrap(~ variable, scales = "free") +
    theme_minimal() +
    labs(title = paste("Boxplot of Age, Sex, and DepInd, Labeled by Class for Run", r),
         x = "Class",
         y = "Value") +
    scale_fill_discrete(labels = class_labels) +
    # Add mean annotations
    geom_text(data = means, aes(label = sprintf("%.2f", mean_value), y = mean_value), 
              position = position_dodge(width = 0.75), vjust = -0.5, color = "black", size = 3)
  
  print(p)
}
```


####Held out data
```{r}
library(dplyr)
library(ggplot2)
library(tidyr)
library(feather)  # Ensure this package is installed for reading feather files

# Load the age and sex stratified data
age_tab <- as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat_depind.feather'))

# Load the number of test cases
n.test <- length(read.csv('/well/nichols/users/qcv214/KGPNN/sex_test_index.csv')$x)
success.run <- 1:10

for (r in success.run) {
  # Load and process data
  dat.in <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/KGPNN/pile/re_june6_sm_depind_gpols_once_init_bbs_outpred__jobid_', r, '.feather'))))[, c(1:3)]
  dat.in <- tail(dat.in, n.test)
  colnames(dat.in) <- c('id_ind', 'pred', 'class')
  
  # Merge with age and sex information
  age.in <- age_tab[dat.in$id_ind, c('age', 'sex', 'DepInd')]
  age.in <- cbind(age.in, dat.in$pred, (dat.in$pred - age.in$age)^2, as.factor(dat.in$class))
  colnames(age.in) <- c('age', 'sex', 'DepInd', 'pred', 'SqError', 'class')
  
  # Calculate class sizes
  class_sizes <- age.in %>%
    group_by(class) %>%
    summarise(count = n())
  
  # Create a named vector for custom labels
  class_labels <- paste0(class_sizes$class, " (n=", class_sizes$count, ")")
  names(class_labels) <- class_sizes$class
  
  # Reshape the data for plotting
  age.in_long <- pivot_longer(age.in, cols = c(age, sex, DepInd, pred, SqError), names_to = "variable", values_to = "value")
  
  # Calculate the mean for each class and variable
  means <- age.in_long %>%
    group_by(class, variable) %>%
    summarise(mean_value = mean(value, na.rm = TRUE))
  
  # Create the boxplot with class sizes in the legend
  p <- ggplot(age.in_long, aes(x = class, y = value, fill = class)) +
    geom_boxplot() +
    facet_wrap(~ variable, scales = "free") +
    theme_minimal() +
    labs(title = paste("Boxplot of Age, Sex, and DepInd, Labeled by Class for Run", r),
         x = "Class",
         y = "Value") +
    scale_fill_discrete(labels = class_labels) +
    # Add mean annotations
    geom_text(data = means, aes(label = sprintf("%.2f", mean_value), y = mean_value), 
              position = position_dodge(width = 0.75), vjust = -0.5, color = "black", size = 3)
  
  print(p)
}
```


//june13_sm_depind_gpols_once_init_bbs  64888281 => 1k went overtime, let's do 750. 
#19 June

##bbs
```{r}
library(ggplot2)
library(tidyr)

num.it <- 750*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_june13_sm_depind_gpols_once_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }

# Assuming resdat is your dataframe
# Add a row identifier
resdat <- as.data.frame(sqrt(res.mat[2,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  geom_hline(aes(yintercept = 4.59, color = "Imaging-ridge"), linetype = "dashed", size = 1) +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(2.5,10) +
  theme_minimal() +
  labs(title = "Test RMSE", x = "iterations", y = "Value", color = "Run number") 

resdat <- as.data.frame(sqrt(res.mat[1,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  geom_hline(aes(yintercept = 0.9, color = "Imaging-ridge"), linetype = "dashed", size = 1) +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(0,10) +
  theme_minimal() +
  labs(title = "Train RMSE",x = "iterations", y = "Value", color = "Run number")
```

This isn't good.

##To do

1. create a benchmark of not having any class
2 apply ridge to specific classes to compare performance.


#4 july
File crashed

I lost fair chunk of work.
1. benchmark is done, same as original gpnn paper
2. Ridge to specific classes are done. Seems like it only overfits more
2.1 need to bring back my code for evaluating bbs_ridge rmse
3. june19 bbs_ridge uses more number of classes (10). It's superior over bbs, but worse than overall ridge.


Right now working on gpols with more number of classes for gpols (16)
And also working on gpnn ----- Note that I wrote a lot of comments and 2nd layer generation for tyhis, need to re-work on it.


##gpnn 
10 classes, mixed

```{r}
library(ggplot2)
library(tidyr)

num.it <-500*4
runs <- c(1,6,9,10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_july3_sm_depind_gpnn_init_loss__jobid_",i,".csv")))[,1:num.it]
 }

# Assuming resdat is your dataframe
# Add a row identifier
resdat <- as.data.frame(sqrt(res.mat[2,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(4,10) +
  theme_minimal() +
  labs(title = "Test RMSE", x = "iterations", y = "Value", color = "Run number")

resdat <- as.data.frame(sqrt(res.mat[1,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(1,6) +
  theme_minimal() +
  labs(title = "Train RMSE",x = "iterations", y = "Value", color = "Run number")
```
This is decent.

##gpols
16 classes
```{r}
library(ggplot2)
library(tidyr)

num.it <-500*4
runs <- c(1:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_july3_sm_depind_gpols_once_init_loss__jobid_",i,".csv")))[,1:num.it]
 }

# Assuming resdat is your dataframe
# Add a row identifier
resdat <- as.data.frame(sqrt(res.mat[2,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(4,10) +
  theme_minimal() +
  labs(title = "Test RMSE", x = "iterations", y = "Value", color = "Run number")

resdat <- as.data.frame(sqrt(res.mat[1,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(1,6) +
  theme_minimal() +
  labs(title = "Train RMSE",x = "iterations", y = "Value", color = "Run number")
```
This isn't that good but let's run bbs for both of them 


Currently running
[failed] july3_sm_depind_gpnn_init_bbs 287056 ==> time run out, 5-8 seconds or mins per epoch, only got to 200 epochs?.. but didn't have this issue in _init_ => i think its just the resources available at that time.

[interrupted] july3_sm_depind_gpnn_init_bbs 395813 => takes too long and memories, need to run it when not doing anything. Training RMSE is 0, but test MSE is 20.8-20.9 all runs

//[3,8 failed] july3_sm_depind_gpols_once_init_bbs 282917 => 16 classes

#July 7
## BBS of gpols 16 classes 
16 classes
```{r}
library(ggplot2)
library(tidyr)

num.it <-500*4
runs <- c(1,2,4:7,9,10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_july3_sm_depind_gpols_once_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }

# Assuming resdat is your dataframe
# Add a row identifier
resdat <- as.data.frame(sqrt(res.mat[2,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(4,10) +
  theme_minimal() +
  labs(title = "Test RMSE", x = "iterations", y = "Value", color = "Run number")

resdat <- as.data.frame(sqrt(res.mat[1,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(1,6) +
  theme_minimal() +
  labs(title = "Train RMSE",x = "iterations", y = "Value", color = "Run number")
```

## BBS of gpols 4 classes 
```{r}
library(ggplot2)
library(tidyr)

num.it <-500*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_june6_sm_depind_gpols_once_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }

# Assuming resdat is your dataframe
# Add a row identifier
resdat <- as.data.frame(sqrt(res.mat[2,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(4,10) +
  theme_minimal() +
  labs(title = "Test RMSE", x = "iterations", y = "Value", color = "Run number")

resdat <- as.data.frame(sqrt(res.mat[1,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(1,6) +
  theme_minimal() +
  labs(title = "Train RMSE",x = "iterations", y = "Value", color = "Run number")
```

## BBS of gpols 10 classes 
```{r}
library(ggplot2)
library(tidyr)

num.it <-500*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/KGPNN/pile/re_june13_sm_depind_gpols_once_init_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }

# Assuming resdat is your dataframe
# Add a row identifier
resdat <- as.data.frame(sqrt(res.mat[2,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(4,10) +
  theme_minimal() +
  labs(title = "Test RMSE", x = "iterations", y = "Value", color = "Run number")

resdat <- as.data.frame(sqrt(res.mat[1,,]))
colnames(resdat) <- 1:ncol(resdat)
resdat$row_id <- seq_len(nrow(resdat))
# Reshape the data to long format
resdat_long <- pivot_longer(resdat, cols = -row_id, names_to = "column", values_to = "value")
# Create the line plot
ggplot(resdat_long, aes(x = as.numeric(column), y = value, group = row_id, color = as.factor(row_id))) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(as.numeric(resdat_long$column)), by = 500)) +
  ylim(1,6) +
  theme_minimal() +
  labs(title = "Train RMSE",x = "iterations", y = "Value", color = "Run number")
```


#9 July

I plan to include a range of cognitive performance from subjects rather than age, see how I used depind below and do something similar

##13 December 

1. Need to cross check if the data is still the same for Age.tsv and `/well/nichols/projects/UKB/SMS/ukb_latest-Confs.tsv`
  1.2 26410:Index of Multiple Deprivation (England)	Indices of Multiple Deprivation  , 26427 Index of Multiple Deprivation (Scotland)	Indices of Multiple Deprivation  
 26426, Index of Multiple Deprivation (Wales)	Indices of Multiple Deprivation  
 
 1.3: I wonder if I should calibrate England, Scot and Wales to be on the same scale e.g. by standardising. Or should I just use the raw values?

  1.4
2. create a null model for non-imaging

###Look at Confs
```{r}
confs.dat<-read.table(file = '/well/nichols/projects/UKB/SMS/ukb_latest-Confs.tsv', sep = '\t', header = TRUE) #46535 53
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat.feather'))

#check intersection of the new deprivation index for each country, check if the sum of non NA is equal to the nrow
nrow(confs.dat) == sum(sum(!is.na(confs.dat$X26410.0.0))+sum(!is.na(confs.dat$X26427.0.0))+sum(!is.na(confs.dat$X26426.0.0)))
#46535 vs 45429 ===> meaning 1000 rows have all NA

#I will create a new combined column that takes the sum and ignore the NA
#length(apply(cbind(confs.dat$X26410.0.0,confs.dat$X26427.0.0,confs.dat$X26426.0.0),1,FUN = sum,na.rm=TRUE))
confs.dat$combDepInd <- apply(cbind(confs.dat$X26410.0.0,confs.dat$X26427.0.0,confs.dat$X26426.0.0),1,FUN = mean,na.rm=TRUE) 
# if we use `sum` instead of `mean` above then it will convert NA to 0. Using `mean` will keep `mean` the same.
#sum(is.na(confs.dat$combDepInd)) = 0 wtf
```

impute 3% of the missing index using mean
I will use MEDIAN since there is no other correlated data to predict this
```{r}
age_tab$DepInd <- vector(mode='numeric',length = nrow(age_tab))
for(i in 1:length(age_tab$id)){
  age_tab$DepInd[i] <- confs.dat$combDepInd[confs.dat$eid_8107==sub(".", "",age_tab$id[i])]
} 
summary(age_tab$DepInd) #NA's = 117 #only 3% is missing 

#Lets impute using means perhaps.
median_value <- median(age_tab$DepInd, na.rm = TRUE)
age_tab$DepInd[is.na(age_tab$DepInd)] <- median_value

#write_feather(age_tab, '/well/nichols/users/qcv214/KGPNN/age_sex_strat_depind.feather')
```

```{r}
boxplot(age_tab$DepInd~ as.factor(age_tab$sex), 
        xlab = "Sex", 
        ylab = "Values", 
        main = "Boxplot of Values by Sex")
```
```{r}
library(ggplot2)
# Assuming dep.vec and sex are defined as before
dep.vec_df <- data.frame(value = age_tab$DepInd, sex = as.factor(age_tab$sex))

# Create the histogram using ggplot
ggplot(dep.vec_df, aes(x = value, fill = sex)) +
  geom_histogram(position = "identity", alpha = 0.5, bins = 10) +
  labs(title = "Histogram of Values by Sex", x = "Values", y = "Frequency") +
  scale_fill_manual(values = c("red", "blue")) +
  theme_minimal()
```
Male and female have similar distributions. 

```{r}
# Assuming dep.vec is your numeric vector
dep.vec <- age_tab$DepInd
# Calculate the quantile thresholds (0%, 10%, 20%, ..., 100%)
quantile_thresholds <- quantile(dep.vec, probs = seq(0, 1, by = 0.1))
# Split dep.vec into quantiles
dep.vec_quantiles <- cut(dep.vec, breaks = quantile_thresholds, include.lowest = TRUE, labels = FALSE)
# Print the quantile group for each value in dep.vec
dep.vec_quantiles
```

##Looking at the new file `ukb_latest-Cog.tsv`
20016 FLuid Intelligence (normally dist, 0-13)
6348  Duration to complete numeric path (trail #1) => left skewed 92 -2557
6350 	Duration to complete alphanumeric path (trail #2) => left skewed 160-2988
6373  Number of puzzles correctly solved => right skewed 0 - 15
```{r}
cog.dat<-read.table(file = '/well/nichols/projects/UKB/SMS/ukb_latest-Cog.tsv', sep = '\t', header = TRUE) #46535 53
summary(cog.dat)
#many missing values
```
The idea is to grab the mean of xxx.1.0 and xxx.2.0 and xxx.3.0 to average it.
```{r}
#fluid intelligence
cog.dat$fi <- apply(cbind(cog.dat$X20016.0.0,cog.dat$X20016.1.0,cog.dat$X20016.2.0,cog.dat$X20016.3.0),1,FUN = mean,na.rm=TRUE) 
#numeric path
cog.dat$num <- apply(cbind(cog.dat$X6348.2.0,cog.dat$X6348.3.0),1,FUN = mean,na.rm=TRUE) 
#alphanumeric
cog.dat$alphnum <- apply(cbind(cog.dat$X6350.2.0,cog.dat$X6350.3.0),1,FUN = mean,na.rm=TRUE) 
#puzzles
cog.dat$puzzle <-  apply(cbind(cog.dat$X6373.2.0,cog.dat$X6373.3.0),1,FUN = mean,na.rm=TRUE) 
```

```{r}
age_tab <-  as.data.frame(read_feather('/well/nichols/users/qcv214/KGPNN/age_sex_strat_depind.feather'))

#something along bottom line
for(i in 1:length(age_tab$id)){
  ind <- cog.dat$eid_8107==sub(".", "",age_tab$id[i])
  age_tab$fi[i] <- cog.dat$fi[ind]
  age_tab$num[i] <- cog.dat$num[ind]
  age_tab$alphnum[i] <- cog.dat$alphnum[ind]
  age_tab$puzzle[i] <- cog.dat$puzzle[ind]
  
} 
```
```{r}
summary(age_tab$fi)
summary(age_tab$num)
summary(age_tab$alphnum)
summary(age_tab$puzzle)
```

There are so many missing values. I think I will have to create another dataset for this.

Original data
```{r}
part_list<-read.table('/well/nichols/users/qcv214/Placement_2/participant_list.txt', header = FALSE, sep = "", dec = ".") #4529 participants
part_list$exist_vbm <- file.exists(paste0('/well/win-biobank/projects/imaging/data/data3/subjectsAll/',part_list[,1],'/T1/T1_vbm/T1_GM_to_template_GM_mod.nii.gz'))
#These two are equal
part_use<-part_list[part_list$exist_vbm==1,] #4262 participants left
```

Extended data
```{r}
part_list2 <- read.csv('/well/nichols/users/qcv214/bnn2/add_1_part_id_use_final.txt')$V1 #4258
part_list2.exist_vbm <- file.exists(paste0('/well/win-biobank/projects/imaging/data/data3/subjectsAll/',part_list2,'/T1/T1_vbm/T1_GM_to_template_GM_mod.nii.gz'))
part_use2 <-part_list2[part_list2.exist_vbm] #length = 4257
```











